<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https:&#x2F;&#x2F;github.com&#x2F;perrynzhou。">
<meta property="og:type" content="website">
<meta property="og:title" content="perrynzhou">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="perrynzhou">
<meta property="og:description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https:&#x2F;&#x2F;github.com&#x2F;perrynzhou。">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="perrynzhou">
<meta property="article:tag" content="C">
<meta property="article:tag" content=" Go">
<meta property="article:tag" content=" 分布式存储">
<meta property="article:tag" content=" 对象存储">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>perrynzhou</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">perrynzhou</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一个专注存储技术的疯子,https://github.com/perrynzhou</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/14/OpenCAS-%E6%B6%88%E8%80%97%E8%BF%87%E5%A4%9A%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/14/OpenCAS-%E6%B6%88%E8%80%97%E8%BF%87%E5%A4%9A%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">OpenCAS 消耗过多内存问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-14 16:09:40 / Modified: 16:23:15" itemprop="dateCreated datePublished" datetime="2020-05-14T16:09:40+08:00">2020-05-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="OpenCase-内存耗尽的问题"><a href="#OpenCase-内存耗尽的问题" class="headerlink" title="OpenCase 内存耗尽的问题"></a>OpenCase 内存耗尽的问题</h2><h3 id="1-现象"><a href="#1-现象" class="headerlink" title="1.现象"></a>1.现象</h3><ul>
<li>使用3.5T  SSD 初始化opencas,发现无法初始化，宿主机内存为120G，初始化成功后，运行一段时间出现内存全部消耗完。</li>
</ul>
<h3 id="2-opencas-版本信息"><a href="#2-opencas-版本信息" class="headerlink" title="2.opencas 版本信息"></a>2.opencas 版本信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">opencas version:19.9</span><br><span class="line">Linux kernel: 3.10.0-957.el7.x86_64</span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br></pre></td></tr></table></figure>

<h3 id="3-opencas-出问题时候日志"><a href="#3-opencas-出问题时候日志" class="headerlink" title="3.opencas 出问题时候日志"></a>3.opencas 出问题时候日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">use command:  grep vmalloc &#x2F;proc&#x2F;vmallocinfo |grep cas_cache</span><br><span class="line">0xffffae2a4dffe000-0xffffae2a4e000000    8192 ocf_metadata_hash_ctrl_init+0x23&#x2F;0xe0 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebb2000-0xffffae2a4ebb4000    8192 ocf_metadata_hash_ctrl_init+0x23&#x2F;0xe0 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebb4000-0xffffae2a4ebb6000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebb6000-0xffffae2a4ebb8000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebb8000-0xffffae2a4ebc5000   53248 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;12 vmalloc N0&#x3D;12</span><br><span class="line">0xffffae2a4ebc5000-0xffffae2a4ebc7000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebc7000-0xffffae2a4ebd1000   40960 raw_dynamic_init+0x38&#x2F;0x90 [cas_cache] pages&#x3D;9 vmalloc N0&#x3D;9</span><br><span class="line">0xffffae2a4ebd1000-0xffffae2a4ebd3000    8192 _cache_mngt_cache_priv_init+0x2e&#x2F;0x60 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebf1000-0xffffae2a4ebf3000    8192 _ocf_mngt_attach_cache_device+0x23&#x2F;0x1b0 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4ebf3000-0xffffae2a4ebf5000    8192 ocf_volume_init+0x99&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4ebfc000-0xffffae2a4ebfe000    8192 ocf_freelist_init+0x25&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4ebfe000-0xffffae2a4ec00000    8192 ocf_freelist_init+0x64&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4edda000-0xffffae2a4edfb000  135168 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;32 vmalloc N0&#x3D;32</span><br><span class="line">0xffffae2a4edfb000-0xffffae2a4edfd000    8192 ocf_freelist_init+0x74&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4edfe000-0xffffae2a4ee00000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ef01000-0xffffae2a4ef7b000  499712 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;121 vmalloc N0&#x3D;121</span><br><span class="line">0xffffae2a4ef7b000-0xffffae2a4ef87000   49152 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;11 vmalloc N1&#x3D;11</span><br><span class="line">0xffffae2a4ef87000-0xffffae2a4ef8f000   32768 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;7 vmalloc N1&#x3D;7</span><br><span class="line">0xffffae2a4ef8f000-0xffffae2a4ef9b000   49152 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;11 vmalloc N1&#x3D;11</span><br><span class="line">0xffffae2a4ef9b000-0xffffae2a4efab000   65536 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;15 vmalloc N1&#x3D;15</span><br><span class="line">0xffffae2a4efab000-0xffffae2a4efb9000   57344 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;13 vmalloc N1&#x3D;13</span><br><span class="line">0xffffae2a4efbe000-0xffffae2a4efc0000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4efc0000-0xffffae2a4efe1000  135168 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;32 vmalloc N0&#x3D;32</span><br><span class="line">0xffffae2a4efe1000-0xffffae2a4efee000   53248 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;12 vmalloc N0&#x3D;12</span><br><span class="line">0xffffae2a4efee000-0xffffae2a4eff0000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4eff0000-0xffffae2a4effa000   40960 raw_dynamic_init+0x38&#x2F;0x90 [cas_cache] pages&#x3D;9 vmalloc N0&#x3D;9</span><br><span class="line">0xffffae2a4effa000-0xffffae2a4effc000    8192 _cache_mngt_cache_priv_init+0x2e&#x2F;0x60 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f101000-0xffffae2a4f17b000  499712 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;121 vmalloc N0&#x3D;121</span><br><span class="line">0xffffae2a4f17b000-0xffffae2a4f17d000    8192 _ocf_mngt_attach_cache_device+0x23&#x2F;0x1b0 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f17d000-0xffffae2a4f17f000    8192 ocf_volume_init+0x99&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f17f000-0xffffae2a4f18b000   49152 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;11 vmalloc N0&#x3D;11</span><br><span class="line">0xffffae2a4f192000-0xffffae2a4f19a000   32768 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;7 vmalloc N0&#x3D;7</span><br><span class="line">0xffffae2a4f19a000-0xffffae2a4f1a6000   49152 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;11 vmalloc N0&#x3D;11</span><br><span class="line">0xffffae2a4f1a6000-0xffffae2a4f1b6000   65536 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;15 vmalloc N0&#x3D;15</span><br><span class="line">0xffffae2a4f1b6000-0xffffae2a4f1c4000   57344 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;13 vmalloc N0&#x3D;13</span><br><span class="line">0xffffae2a4f1c4000-0xffffae2a4f1c6000    8192 ocf_freelist_init+0x25&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f1c6000-0xffffae2a4f1c8000    8192 ocf_freelist_init+0x64&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f1c8000-0xffffae2a4f1ca000    8192 ocf_freelist_init+0x74&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f1ca000-0xffffae2a4f1d4000   40960 ocf_cache_line_concurrency_init+0x48&#x2F;0x190 [cas_cache] pages&#x3D;9 vmalloc N0&#x3D;9</span><br><span class="line">0xffffae2a4f1d4000-0xffffae2a4f1d9000   20480 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;4 vmalloc N0&#x3D;4</span><br><span class="line">0xffffae2a4f1d9000-0xffffae2a4f1de000   20480 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;4 vmalloc N1&#x3D;4</span><br><span class="line">0xffffae2a4f1df000-0xffffae2a4f1e1000    8192 ocf_promotion_init+0x2e&#x2F;0xc0 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f1e5000-0xffffae2a4f1ef000   40960 ocf_cache_line_concurrency_init+0x48&#x2F;0x190 [cas_cache] pages&#x3D;9 vmalloc N1&#x3D;9</span><br><span class="line">0xffffae2a4f1f5000-0xffffae2a4f1f7000    8192 ocf_promotion_init+0x2e&#x2F;0xc0 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4f301000-0xffffae2a4f34b000  303104 ocf_metadata_concurrency_attached_init+0x57&#x2F;0x190 [cas_cache] pages&#x3D;73 vmalloc N0&#x3D;73</span><br><span class="line">0xffffae2a4f34b000-0xffffae2a4f395000  303104 ocf_metadata_concurrency_attached_init+0x57&#x2F;0x190 [cas_cache] pages&#x3D;73 vmalloc N1&#x3D;73</span><br><span class="line">0xffffae2a4f503000-0xffffae2a4f505000    8192 _raw_dynamic_get_item.isra.10+0xbc&#x2F;0x160 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f5fa000-0xffffae2a4f5fc000    8192 _raw_dynamic_get_item.isra.10+0xbc&#x2F;0x160 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4fe90000-0xffffae2a4ff9a000 1089536 ocf_mngt_cache_start+0x1b0&#x2F;0x7a0 [cas_cache] pages&#x3D;265 vmalloc N0&#x3D;265</span><br><span class="line">0xffffae2a50b02000-0xffffae2a50c28000 1204224 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;293 vmalloc N0&#x3D;293</span><br><span class="line">0xffffae2a50c28000-0xffffae2a50d32000 1089536 ocf_mngt_cache_start+0x1b0&#x2F;0x7a0 [cas_cache] pages&#x3D;265 vmalloc N0&#x3D;265</span><br><span class="line">0xffffae2a50d32000-0xffffae2a50e58000 1204224 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;293 vmalloc N0&#x3D;293</span><br><span class="line">0xffffae2a50e58000-0xffffae2a52313000 21737472 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;5306 vmalloc vpages N0&#x3D;5306</span><br><span class="line">0xffffae2a52313000-0xffffae2a530e2000 14479360 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;3534 vmalloc vpages N0&#x3D;3534</span><br><span class="line">0xffffae2a530e2000-0xffffae2a5459d000 21737472 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;5306 vmalloc vpages N0&#x3D;5306</span><br><span class="line">0xffffae2a5459d000-0xffffae2a56311000 30883840 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;7539 vmalloc vpages N0&#x3D;7539</span><br><span class="line">0xffffae2a56311000-0xffffae2a564cc000 1814528 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;442 vmalloc N0&#x3D;442</span><br><span class="line">0xffffae2a564cc000-0xffffae2a57cf6000 25337856 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;6185 vmalloc vpages N0&#x3D;6185</span><br><span class="line">0xffffae2a57cf6000-0xffffae2a58cf8000 16785408 ocf_cache_line_concurrency_init+0x48&#x2F;0x190 [cas_cache] pages&#x3D;4097 vmalloc vpages N0&#x3D;4097</span><br><span class="line">0xffffae2a58cf8000-0xffffae2a593e0000 7241728 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;1767 vmalloc vpages N0&#x3D;1767</span><br><span class="line">0xffffae2a5c278000-0xffffae2a5d733000 21737472 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;5306 vmalloc vpages N1&#x3D;5306</span><br><span class="line">0xffffae2a5d733000-0xffffae2a5e502000 14479360 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;3534 vmalloc vpages N1&#x3D;3534</span><br><span class="line">0xffffae2a5e502000-0xffffae2a5f9bd000 21737472 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;5306 vmalloc vpages N1&#x3D;5306</span><br><span class="line">0xffffae2a5f9bd000-0xffffae2a5fb78000 1814528 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;442 vmalloc N1&#x3D;442</span><br><span class="line">0xffffae2a70001000-0xffffae2d073a0000 11127091200 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;2716574 vmalloc vpages N0&#x3D;2716574</span><br><span class="line">0xffffae2d073a0000-0xffffae2ec0f22000 7410819072 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1809281 vmalloc vpages N0&#x3D;1809281</span><br><span class="line">0xffffae2ec0f22000-0xffffae31582c1000 11127091200 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;2716574 vmalloc vpages N0&#x3D;2716574</span><br><span class="line">0xffffae31582c1000-0xffffae3506818000 15809736704 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;3859798 vmalloc vpages N0&#x3D;3859798</span><br><span class="line">0xffffae3506818000-0xffffae353db8a000 926359552 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;226161 vmalloc vpages N0&#x3D;226161</span><br><span class="line">0xffffae353db8a000-0xffffae3842bac000 12968927232 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;3166241 vmalloc vpages N0&#x3D;3166241</span><br><span class="line">0xffffae3842bac000-0xffffae384bcc2000 152133632 ocf_metadata_concurrency_attached_init+0x57&#x2F;0x190 [cas_cache] pages&#x3D;37141 vmalloc vpages N0&#x3D;37141</span><br><span class="line">0xffffae384bcc2000-0xffffae3928a84000 3705413632 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;904641 vmalloc vpages N0&#x3D;904641</span><br><span class="line">0xffffae3928a84000-0xffffae3bbfe23000 11127091200 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;2716574 vmalloc vpages N1&#x3D;2716574</span><br><span class="line">0xffffae3bbfe23000-0xffffae3d799a5000 7410819072 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1809281 vmalloc vpages N1&#x3D;1809281</span><br><span class="line">0xffffae3d799a5000-0xffffae4010d44000 11127091200 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;2716574 vmalloc vpages N1&#x3D;2716574</span><br><span class="line">0xffffae4010d44000-0xffffae43bf29b000 15809736704 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;3859798 vmalloc vpages N1&#x3D;3859798</span><br><span class="line">0xffffae43bf29b000-0xffffae43c100f000 30883840 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;7539 vmalloc vpages N1&#x3D;7539</span><br><span class="line">0xffffae43c100f000-0xffffae43f8381000 926359552 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;226161 vmalloc vpages N1&#x3D;226161</span><br><span class="line">0xffffae43f8381000-0xffffae46fd3a3000 12968927232 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;3166241 vmalloc vpages N1&#x3D;3166241</span><br><span class="line">0xffffae46fd3a3000-0xffffae46febcd000 25337856 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;6185 vmalloc vpages N1&#x3D;6185</span><br><span class="line">0xffffae46febcd000-0xffffae4707ce3000 152133632 ocf_metadata_concurrency_attached_init+0x57&#x2F;0x190 [cas_cache] pages&#x3D;37141 vmalloc vpages N1&#x3D;37141</span><br><span class="line">0xffffae4707ce3000-0xffffae4708ce5000 16785408 ocf_cache_line_concurrency_init+0x48&#x2F;0x190 [cas_cache] pages&#x3D;4097 vmalloc vpages N1&#x3D;4097</span><br><span class="line">0xffffae4708ce5000-0xffffae47e5aa7000 3705413632 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;904641 vmalloc vpages N1&#x3D;904641</span><br><span class="line">0xffffae47e5aa7000-0xffffae47e618f000 7241728 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;1767 vmalloc vpages N1&#x3D;1767</span><br><span class="line">0xffffae47e6eb3000-0xffffae47e6eec000  233472 cleaning_policy_acp_initialize+0x3e&#x2F;0x330 [cas_cache] pages&#x3D;56 vmalloc N1&#x3D;56</span><br><span class="line">0xffffae47e6eec000-0xffffae47e6ef3000   28672 cleaning_policy_acp_add_core+0x7c&#x2F;0x160 [cas_cache] pages&#x3D;6 vmalloc N1&#x3D;6</span><br><span class="line">0xffffae47e712a000-0xffffae47e7163000  233472 cleaning_policy_acp_initialize+0x3e&#x2F;0x330 [cas_cache] pages&#x3D;56 vmalloc N1&#x3D;56</span><br><span class="line">0xffffae47e7163000-0xffffae47e7169000   24576 cleaning_policy_acp_add_core+0x7c&#x2F;0x160 [cas_cache] pages&#x3D;5 vmalloc N1&#x3D;5</span><br><span class="line">0xffffae47e7692000-0xffffae47e8238000 12214272 cleaning_policy_acp_add_core+0x7c&#x2F;0x160 [cas_cache] pages&#x3D;2981 vmalloc vpages N1&#x3D;2981</span><br><span class="line">0xffffae47e8238000-0xffffae47e8af5000 9162752 cleaning_policy_acp_add_core+0x7c&#x2F;0x160 [cas_cache] pages&#x3D;2236 vmalloc vpages N1&#x3D;2236</span><br><span class="line"></span><br><span class="line">use command grep vmalloc &#x2F;proc&#x2F;vmallocinfo |grep cas_cache | awk &#39;&#123;total+&#x3D;$2&#125;; END &#123;print total&#125;&#39;</span><br><span class="line">126764556288 </span><br><span class="line">[root@szdpl1491 ~]# free -h</span><br><span class="line">              total        used        free      shared  buff&#x2F;cache   available</span><br><span class="line">Mem:           125G        123G        967M        5.1M        864M        194M</span><br><span class="line">Swap:           31G        7.9G         24G</span><br><span class="line"> </span><br><span class="line">the cas_cache use 118G,  I have  another sever with opencas for 1 month, the cas_cache use 59G</span><br></pre></td></tr></table></figure>
<h3 id="3-opencas-相关配置"><a href="#3-opencas-相关配置" class="headerlink" title="3.opencas 相关配置"></a>3.opencas 相关配置</h3><ul>
<li><p>cache mode: WT</p>
</li>
<li><p>cache config</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">casadm -L</span><br><span class="line"></span><br><span class="line">type    id   disk       status    write policy   device</span><br><span class="line">cache   1    &#x2F;dev&#x2F;sda   Running   wt             -</span><br><span class="line">└core   1    &#x2F;dev&#x2F;sdd   Active    -              &#x2F;dev&#x2F;cas1-1</span><br><span class="line">cache   2    &#x2F;dev&#x2F;sdb   Running   wt             -</span><br><span class="line">└core   1    &#x2F;dev&#x2F;sde   Active    -              &#x2F;dev&#x2F;cas2-1</span><br><span class="line">casadm -P -i 1</span><br><span class="line"></span><br><span class="line">Cache Id                  1</span><br><span class="line">Cache Size                926351414 [4KiB Blocks] &#x2F; 3533.75 [GiB]</span><br><span class="line">Cache Device              &#x2F;dev&#x2F;sda</span><br><span class="line">Core Devices              1</span><br><span class="line">Inactive Core Devices     0</span><br><span class="line">Write Policy              wt</span><br><span class="line">Eviction Policy           lru</span><br><span class="line">Cleaning Policy           alru</span><br><span class="line">Promotion Policy          always</span><br><span class="line">Cache line size           4 [KiB]</span><br><span class="line">Metadata Memory Footprint 46.7 [GiB]</span><br><span class="line">Dirty for                 0 [s] &#x2F; Cache clean</span><br><span class="line">Metadata Mode             normal</span><br><span class="line">Status                    Running</span><br><span class="line"></span><br><span class="line">╔══════════════════╤═══════════╤══════╤═════════════╗</span><br><span class="line">║ Usage statistics │   Count   │  %   │   Units     ║</span><br><span class="line">╠══════════════════╪═══════════╪══════╪═════════════╣</span><br><span class="line">║ Occupancy        │ 500156640 │ 54.0 │ 4KiB blocks ║</span><br><span class="line">║ Free             │ 426194774 │ 46.0 │ 4KiB blocks ║</span><br><span class="line">║ Clean            │ 500156640 │ 54.0 │ 4KiB blocks ║</span><br><span class="line">║ Dirty            │         0 │  0.0 │ 4KiB blocks ║</span><br><span class="line">╚══════════════════╧═══════════╧══════╧═════════════╝</span><br><span class="line"></span><br><span class="line">╔══════════════════════╤════════════╤═══════╤══════════╗</span><br><span class="line">║ Request statistics   │   Count    │   %   │ Units    ║</span><br><span class="line">╠══════════════════════╪════════════╪═══════╪══════════╣</span><br><span class="line">║ Read hits            │ 2628479218 │  61.6 │ Requests ║</span><br><span class="line">║ Read partial misses  │          0 │   0.0 │ Requests ║</span><br><span class="line">║ Read full misses     │         64 │   0.0 │ Requests ║</span><br><span class="line">║ Read total           │ 2628479282 │  61.6 │ Requests ║</span><br><span class="line">╟──────────────────────┼────────────┼───────┼──────────╢</span><br><span class="line">║ Write hits           │ 1579075690 │  37.0 │ Requests ║</span><br><span class="line">║ Write partial misses │    4237509 │   0.1 │ Requests ║</span><br><span class="line">║ Write full misses    │   58309934 │   1.4 │ Requests ║</span><br><span class="line">║ Write total          │ 1641623133 │  38.4 │ Requests ║</span><br><span class="line">╟──────────────────────┼────────────┼───────┼──────────╢</span><br><span class="line">║ Pass-Through reads   │          0 │   0.0 │ Requests ║</span><br><span class="line">║ Pass-Through writes  │          0 │   0.0 │ Requests ║</span><br><span class="line">║ Serviced requests    │ 4270102415 │ 100.0 │ Requests ║</span><br><span class="line">╟──────────────────────┼────────────┼───────┼──────────╢</span><br><span class="line">║ Total requests       │ 4270102415 │ 100.0 │ Requests ║</span><br><span class="line">╚══════════════════════╧════════════╧═══════╧══════════╝</span><br><span class="line"></span><br><span class="line">╔══════════════════════════════════╤═════════════╤═══════╤═════════════╗</span><br><span class="line">║ Block statistics                 │    Count    │   %   │   Units     ║</span><br><span class="line">╠══════════════════════════════════╪═════════════╪═══════╪═════════════╣</span><br><span class="line">║ Reads from core(s)               │         356 │   0.0 │ 4KiB blocks ║</span><br><span class="line">║ Writes to core(s)                │  2954907028 │ 100.0 │ 4KiB blocks ║</span><br><span class="line">║ Total to&#x2F;from core(s)            │  2954907384 │ 100.0 │ 4KiB blocks ║</span><br><span class="line">╟──────────────────────────────────┼─────────────┼───────┼─────────────╢</span><br><span class="line">║ Reads from cache                 │           0 │   0.0 │ 4KiB blocks ║</span><br><span class="line">║ Writes to cache                  │           0 │   0.0 │ 4KiB blocks ║</span><br><span class="line">║ Total to&#x2F;from cache              │           0 │   0.0 │ 4KiB blocks ║</span><br><span class="line">╟──────────────────────────────────┼─────────────┼───────┼─────────────╢</span><br><span class="line">║ Reads from exported object(s)    │ 12708231250 │  81.1 │ 4KiB blocks ║</span><br><span class="line">║ Writes to exported object(s)     │  2954907028 │  18.9 │ 4KiB blocks ║</span><br><span class="line">║ Total to&#x2F;from exported object(s) │ 15663138278 │ 100.0 │ 4KiB blocks ║</span><br><span class="line">╚══════════════════════════════════╧═════════════╧═══════╧═════════════╝</span><br><span class="line"></span><br><span class="line">╔════════════════════╤═══════╤═════╤══════════╗</span><br><span class="line">║ Error statistics   │ Count │  %  │ Units    ║</span><br><span class="line">╠════════════════════╪═══════╪═════╪══════════╣</span><br><span class="line">║ Cache read errors  │     0 │ 0.0 │ Requests ║</span><br><span class="line">║ Cache write errors │     0 │ 0.0 │ Requests ║</span><br><span class="line">║ Cache total errors │     0 │ 0.0 │ Requests ║</span><br><span class="line">╟────────────────────┼───────┼─────┼──────────╢</span><br><span class="line">║ Core read errors   │     0 │ 0.0 │ Requests ║</span><br><span class="line">║ Core write errors  │     0 │ 0.0 │ Requests ║</span><br><span class="line">║ Core total errors  │     0 │ 0.0 │ Requests ║</span><br><span class="line">╟────────────────────┼───────┼─────┼──────────╢</span><br><span class="line">║ Total errors       │     0 │ 0.0 │ Requests ║</span><br><span class="line">╚════════════════════╧═══════╧═════╧══════════╝</span><br></pre></td></tr></table></figure>
</li>
<li><p>cache line size</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># dmesg |grep &quot;Cache line size&quot;</span><br><span class="line">2751 [ 1505.783016] cache1: Hash offset : 44427904 kiB</span><br><span class="line">2752 [ 1505.783017] cache1: Hash size : 904644 kiB</span><br><span class="line">2753 [ 1505.783018] cache1: Cache line size: 4 kiB</span><br><span class="line">2754 [ 1505.783019] cache1: Metadata capacity: 47803 MiB</span><br><span class="line">2755 [ 1521.649327] cache1: OCF metadata self-test PASSED</span><br><span class="line">2756 [ 1527.389763] Thread cas_clean_cache1 started</span><br><span class="line"></span><br><span class="line">2893 [ 1823.699193] cache2: Hash offset : 44427904 kiB</span><br><span class="line">2894 [ 1823.699194] cache2: Hash size : 904644 kiB</span><br><span class="line">2895 [ 1823.699195] cache2: Cache line size: 4 kiB</span><br><span class="line">2896 [ 1823.699197] cache2: Metadata capacity: 47803 MiB</span><br><span class="line">2897 [ 1839.660385] cache2: OCF metadata self-test PASSED</span><br><span class="line">2898 [ 1845.359600] Thread cas_clean_cache2 started</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="5-解决方法"><a href="#5-解决方法" class="headerlink" title="5.解决方法"></a>5.解决方法</h3><ul>
<li>opencas在初始化时候casadm 需要添加–cache-line-size  参数，默认是4k，针对宿主机器消耗内存的计算公式为 内存消耗 =  SSD_size / Cache_Line_size  * 70 byte</li>
<li>官方给的简要说明<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">It looks quite normal to me. You have two huge cache devices (2 x 3.5TB) and size of CAS metadata is proportional to number of cache lines. CAS allocates about 70 bytes of metadata per cache line, so in your case it is about 60GiB of metadata per single cache, giving ~120GiB in total. That matches pretty well with your numbers.</span><br><span class="line"></span><br><span class="line">You can decrease memory consumption by choosing bigger cache line size. You can select cache line size up to 64kiB, which would decrease memory usage by factor of 16.</span><br><span class="line"></span><br><span class="line">I&#39;d also recommend you, if it&#39;s possible, to switch to CAS v20.3.</span><br><span class="line">CAS v19.9 was tested only with basic set of tests, while v20.3 was thoroughly validated with extensive set of tests, thus it&#39;s much more stable than any previous version.</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="6-关于opencas-cache-line官方说明"><a href="#6-关于opencas-cache-line官方说明" class="headerlink" title="6.关于opencas cache line官方说明"></a>6.关于opencas cache line官方说明</h3><p><strong>Why does Open CAS Linux use some DRAM space?</strong></p>
<p>Open CAS Linux uses a portion of system memory for metadata, which tells us where data resides. The amount of memory needed is proportional to the size of the cache space. This is true for any caching software solution. However with Open CAS Linux this memory footprint can be decreased using a larger cache line size set by the parameter <em>–cache-line-size</em> which may be useful in high density servers with many large HDDs.</p>
<p><strong>Configuration Tool Details</strong></p>
<p>The Open CAS Linux product includes a user-level configuration tool that provides complete control of the caching software. The commands and parameters available with this tool are detailed in this chapter.</p>
<p>To access help from the CLI, type the <em>-H</em> or -<em>-help</em> parameter for details. You can also view the man page for this product by entering the following command:</p>
<blockquote>
<p># man casadm</p>
</blockquote>
<p><strong>Usage:</strong> casadm –start-cache –cache-device <DEVICE> [option…]</DEVICE></p>
<p><strong>Example:</strong></p>
<blockquote>
<p># casadm –start-cache –cache-device /dev/sdc</p>
</blockquote>
<p>or</p>
<blockquote>
<p># casadm -S -d /dev/sdc</p>
</blockquote>
<p><strong>Description:</strong> Prepares a block device to be used as device for caching other block devices. Typically the cache devices are SSDs or other NVM block devices or RAM disks. The process starts a framework for device mappings pertaining to a specific cache ID. The cache can be loaded with an old state when using the <em>-l</em> or <em>–load</em> parameter (previous cache metadata will not be marked as invalid) or with a new state as the default (previous cache metadata will be marked as invalid).</p>
<p><strong>Required Parameters:</strong></p>
<p><strong>[-d, –cache-device ] :</strong> Caching device to be used. This is an SSD or any NVM block device or RAM disk shown in the <em>/dev</em> directory. <device> needs to be the complete path describing the caching device to be used, for example /dev/sdc.</device></p>
<p><strong>Optional Parameters:</strong></p>
<p><strong>[-i, –cache-id ]:</strong> Cache ID to create; &lt;1 to 16384&gt;. The ID may be specified or by default the command will use the lowest available number first.</p>
<p><strong>[-l, –load]:</strong> Load existing cache metadata from caching device. If the cache device has been used previously and then disabled (like in a reboot) and it is determined that the data in the core device has not changed since the cache device was used, this option will allow continuing the use of the data in the cache device without the need to re-warm the cache with data.</p>
<ul>
<li><em>Caution:</em> You must ensure that the last shutdown followed the instructions in section <a href="https://open-cas.github.io/guide_running.html#stopping-cache-instances" target="_blank" rel="noopener"><strong>Stopping Cache Instances</strong></a>. If there was any change in the core data prior to enabling the cache, data would be not synced correctly and will be corrupted.</li>
</ul>
<p><strong>[-f, –force]:</strong> Forces creation of a cache even if a file system exists on the cache device. This is typically used for devices that have been previously utilized as a cache device.</p>
<ul>
<li><em>Caution:</em> This will delete the file system and any existing data on the cache device.</li>
</ul>
<p><strong>[-c, –cache-mode ]:</strong> Sets the cache mode for a cache instance the first time it is started or created. The mode can be one of the following:</p>
<p><em>wt:</em> (default mode) Turns write-through mode on. When using this parameter, the write-through feature is enabled which allows the acceleration of only read intensive operations.</p>
<p><em>wb:</em> Turns write-back mode on. When using this parameter, the write-back feature is enabled which allows the acceleration of both read and write intensive operations.</p>
<ul>
<li><em>Caution:</em> A failure of the cache device may lead to the loss of data that has not yet been flushed to the core device.</li>
</ul>
<p><em>wa:</em> Turns write-around mode on. When using this parameter, the write-around feature is enabled which allows the acceleration of reads only. All write locations that do not already exist in the cache (i.e. the locations have not be read yet or have been evicted), are written directly to the core drive bypassing the cache. If the location being written already exists in cache, then both the cache and the core drive will be updated.</p>
<p><em>pt:</em> Starts cache in pass-through mode. Caching is effectively disabled in this mode. This allows the user to associate all their desired core devices to be cached prior to actually enabling caching. Once the core devices are associated, the user would dynamically switch to their desired caching mode (see ‘-Q | –set-cache-mode’ for details).</p>
<p><em>wo:</em> Turns write-only mode on. When using this parameter, the write-only feature is enabled which allows the acceleration of write intensive operations primarily.</p>
<ul>
<li><em>Caution:</em> A failure of the cache device may lead to the loss of data that has not yet been flushed to the core device.</li>
</ul>
<p><strong>[-x, –cache-line-size ]:</strong> Set cache line size {4 (default), 8, 16, 32, 64}. The cache line size can only be set when starting the cache and cannot be changed after cache is started.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/05/lustre-2-13%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/05/lustre-2-13%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">lustre-2.13部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-05 13:53:58 / Modified: 15:16:23" itemprop="dateCreated datePublished" datetime="2020-05-05T13:53:58+08:00">2020-05-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="chapter-1-lustre部署"><a href="#chapter-1-lustre部署" class="headerlink" title="chapter 1.lustre部署"></a>chapter 1.lustre部署</h2><h3 id="0-节点信息"><a href="#0-节点信息" class="headerlink" title="0.节点信息"></a>0.节点信息</h3><table>
<thead>
<tr>
<th>node</th>
<th>role</th>
</tr>
</thead>
<tbody><tr>
<td>centos1(mgs_node/mds_node)</td>
<td>mgs/mds</td>
</tr>
<tr>
<td>centos2(oss_node)</td>
<td>oss</td>
</tr>
<tr>
<td>centos3(client_node)</td>
<td>client</td>
</tr>
</tbody></table>
<h3 id="1-kernel版本信息"><a href="#1-kernel版本信息" class="headerlink" title="1.kernel版本信息"></a>1.kernel版本信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS1 ~]# cat &#x2F;etc&#x2F;redhat-release </span><br><span class="line">CentOS Linux release 7.7.1908 (Core)</span><br><span class="line">[root@CentOS1 ~]# uname -r</span><br><span class="line">3.10.0-1062.el7.x86_64</span><br></pre></td></tr></table></figure>

<h3 id="2-配置离线lustre-安装包安装源"><a href="#2-配置离线lustre-安装包安装源" class="headerlink" title="2.配置离线lustre 安装包安装源"></a>2.配置离线lustre 安装包安装源</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; lustre-2.13.0 内核刚好匹配 kernel 3.10.0-1062.el7.x86_64</span><br><span class="line">[root@CentOS1 lustre]# pwd</span><br><span class="line">&#x2F;root&#x2F;lustre</span><br><span class="line">[root@CentOS1 lustre]# ls</span><br><span class="line">repo.conf</span><br><span class="line">[root@CentOS1 lustre]# cat repo.conf </span><br><span class="line">[lustre-server]</span><br><span class="line">name&#x3D;lustre-server</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;downloads.whamcloud.com&#x2F;public&#x2F;lustre&#x2F;lustre-2.13.0&#x2F;el7.7.1908&#x2F;server</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[patchless-ldiskfs-server]</span><br><span class="line">name&#x3D;patchless-ldiskfs-server</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;downloads.whamcloud.com&#x2F;public&#x2F;lustre&#x2F;lustre-2.13.0&#x2F;el7.7.1908&#x2F;patchless-ldiskfs-server</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line"></span><br><span class="line">[lustre-client]</span><br><span class="line">name&#x3D;lustre-client</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;downloads.whamcloud.com&#x2F;public&#x2F;lustre&#x2F;lustre-2.13.0&#x2F;el7.7.1908&#x2F;client</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line"></span><br><span class="line">[e2fsprogs-wc]</span><br><span class="line">name&#x3D;e2fsprogs-wc</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;downloads.whamcloud.com&#x2F;public&#x2F;e2fsprogs&#x2F;latest&#x2F;el7</span><br><span class="line">gpgcheck&#x3D;0</span><br></pre></td></tr></table></figure>

<h3 id="3-下载lustre安装包到本地"><a href="#3-下载lustre安装包到本地" class="headerlink" title="3.下载lustre安装包到本地"></a>3.下载lustre安装包到本地</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS1 ~]# cd ~&#x2F;lustre</span><br><span class="line">[root@CentOS1 ~]# yum groupinstall “Development Tools” -y</span><br><span class="line">[root@CentOS1 ~]# yum install epel-release quilt libselinux-devel python-docutils xmlto asciidoc elfutils-libelf-devel elfutils-devel zlib-devel rng-tools binutils-devel python-devel sg3_utils newt-devel perl-ExtUtils-Embed audit-libs-devel lsof hmaccalc -y</span><br><span class="line">[root@CentOS1 ~]# systemctl stop firewalld.service</span><br><span class="line">[root@CentOS1 ~]# systemctl disable firewalld.service</span><br><span class="line">[root@CentOS1 ~]# yum install  yum-utils dkms-y</span><br><span class="line">[root@CentOS1 ~]# reposync -c lustre-repo.conf -n \</span><br><span class="line">-r lustre-server \</span><br><span class="line">-r lustre-client \</span><br><span class="line">-r patchless-ldiskfs-server \</span><br><span class="line">-r e2fsprogs-wc</span><br><span class="line">[root@CentOS1 ~]# cp ~&#x2F;lustre&#x2F;repo.conf &#x2F;etc&#x2F;yum.repos.d&#x2F;lustre.repo</span><br></pre></td></tr></table></figure>

<h3 id="4-安装lustre版本kernel"><a href="#4-安装lustre版本kernel" class="headerlink" title="4.安装lustre版本kernel"></a>4.安装lustre版本kernel</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;after download all lustre package</span><br><span class="line">[root@CentOS1 lustre]# ls</span><br><span class="line">e2fsprogs-wc  lustre-client  lustre-server  patchless-ldiskfs-server  repo.conf</span><br><span class="line"></span><br><span class="line">[root@CentOS1 lustre]# cd e2fsprogs-wc&#x2F;RPMS&#x2F;x86_64&#x2F; &amp;&amp; pwd</span><br><span class="line">&#x2F;root&#x2F;lustre&#x2F;e2fsprogs-wc&#x2F;RPMS&#x2F;x86_64 &amp;&amp; yum --nogpgcheck --disablerepo&#x3D;* --enablerepo&#x3D;e2fsprogs-wc install  e2fsprogs-1.45.2.wc1-0.el7.x86_64.rpm </span><br><span class="line"></span><br><span class="line">[root@CentOS1 lustre]# cd lustre-server&#x2F;RPMS&#x2F;x86_64&#x2F; &amp;&amp; pwd </span><br><span class="line">&#x2F;root&#x2F;lustre&#x2F;lustre-server&#x2F;RPMS&#x2F;x86_64</span><br><span class="line">yum --nogpgcheck --disablerepo&#x3D;* --enablerepo&#x3D;e2fsprogs-wc install  e2fsprogs-1.45.2.wc1-0.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum --nogpgcheck --disablerepo&#x3D;* --enablerepo&#x3D;lustre-server install  kernel-devel-3.10.0-1062.1.1.el7_lustre.x86_64.rpm  kernel-headers-3.10.0-1062.1.1.el7_lustre.x86_64.rpm </span><br><span class="line">[root@CentOS1 ~] reboot</span><br></pre></td></tr></table></figure>
<h3 id="5-安装zfs"><a href="#5-安装zfs" class="headerlink" title="5.安装zfs"></a>5.安装zfs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS1 lustre]# cd lustre-server&#x2F;RPMS&#x2F;x86_64&#x2F; &amp;&amp; pwd </span><br><span class="line">&#x2F;root&#x2F;lustre&#x2F;lustre-server&#x2F;RPMS&#x2F;x86_64</span><br><span class="line"></span><br><span class="line">[root@CentOS1 x86_64]# yum --nogpgcheck --disablerepo&#x3D;* --enablerepo&#x3D;lustre-server install zfs-0.7.13-1.el7.x86_64.rpm  zfs-dkms-0.7.13-1.el7.noarch.rpm  zfs-dracut-0.7.13-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">[root@CentOS1 x86_64]# reboot</span><br><span class="line">[root@CentOS1 x86_64]# modprobe  zfs</span><br><span class="line">[root@CentOS1 x86_64]# lsmod  |grep zfs</span><br><span class="line">zfs                  3564425  3 </span><br><span class="line">zunicode              331170  1 zfs</span><br><span class="line">zavl                   15236  1 zfs</span><br><span class="line">icp                   270148  1 zfs</span><br><span class="line">zcommon                73440  1 zfs</span><br><span class="line">znvpair                89131  2 zfs,zcommon</span><br><span class="line">spl                   102412  4 icp,zfs,zcommon,znvpair</span><br></pre></td></tr></table></figure>
<h3 id="6-安装lustre-server-核心包"><a href="#6-安装lustre-server-核心包" class="headerlink" title="6.安装lustre server 核心包"></a>6.安装lustre server 核心包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS1 ~] yum --nogpgcheck --disablerepo&#x3D;*  --enablerepo&#x3D;lustre-server install kmod-lustre-2.13.0-1.el7.x86_64.rpm kmod-lustre-osd-ldiskfs-2.13.0-1.el7.x86_64.rpm lustre-2.13.0-1.el7.x86_64.rpm lustre-osd-ldiskfs-mount-2.13.0-1.el7.x86_64.rpm lustre-osd-zfs-mount-2.13.0-1.el7.x86_64.rpm lustre-resource-agents-2.13.0-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">[root@CentOS1 ~]# reboot</span><br><span class="line">[root@CentOS1 ~]# modprobe  lustre</span><br><span class="line">[root@CentOS1 ~]# lsmod  |grep lustre</span><br><span class="line">lustre                875887  0 </span><br><span class="line">lmv                   191957  1 lustre</span><br><span class="line">mdc                   247683  1 lustre</span><br><span class="line">lov                   320485  1 lustre</span><br><span class="line">ptlrpc               2287996  7 fid,fld,lmv,mdc,lov,osc,lustre</span><br><span class="line">obdclass             2649116  8 fid,fld,lmv,mdc,lov,osc,lustre,ptlrpc</span><br><span class="line">lnet                  595547  6 lmv,osc,lustre,obdclass,ptlrpc,ksocklnd</span><br><span class="line">libcfs                388506  11 fid,fld,lmv,mdc,lov,osc,lnet,lustre,obdclass,ptlrpc,ksocklnd</span><br><span class="line"></span><br><span class="line">[root@CentOS1 ~]# modprobe  lnet</span><br><span class="line">[root@CentOS1 ~]# lsmod  |grep lnet</span><br><span class="line">lnet                  595547  6 lmv,osc,lustre,obdclass,ptlrpc,ksocklnd</span><br><span class="line">libcfs                388506  11 fid,fld,lmv,mdc,lov,osc,lnet,lustre,obdclass,ptlrpc,ksocklnd</span><br></pre></td></tr></table></figure>

<h3 id="7-安装lustre-client核心包-客户端节点"><a href="#7-安装lustre-client核心包-客户端节点" class="headerlink" title="7.安装lustre client核心包(客户端节点)"></a>7.安装lustre client核心包(客户端节点)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;lustre server和lustre client版本版本冲突，客户端必须在其他节点安装</span><br><span class="line">[root@CentOS3 ~]# yum install epel-release -y</span><br><span class="line">[root@CentOS3 ~]# yum install dkms -y</span><br><span class="line">[root@CentOS3 ~]# cd lustre&#x2F;</span><br><span class="line">[root@CentOS3 lustre]# cd lustre-client&#x2F;RPMS&#x2F;x86_64&#x2F;</span><br><span class="line">[root@CentOS3 x86_64]# ls</span><br><span class="line">kmod-lustre-client-2.13.0-1.el7.x86_64.rpm        lustre-client-debuginfo-2.13.0-1.el7.x86_64.rpm  lustre-iokit-2.13.0-1.el7.x86_64.rpm</span><br><span class="line">kmod-lustre-client-tests-2.13.0-1.el7.x86_64.rpm  lustre-client-dkms-2.13.0-1.el7.noarch.rpm</span><br><span class="line">lustre-client-2.13.0-1.el7.x86_64.rpm             lustre-client-tests-2.13.0-1.el7.x86_64.rpm</span><br><span class="line">[root@CentOS3 x86_64]# yum --nogpgcheck --disablerepo&#x3D;*  --enablerepo&#x3D;lustre-client install  kmod-lustre-client-2.13.0-1.el7.x86_64.rpm  lustre-client-2.13.0-1.el7.x86_64.rpm  lustre-client-dkms-2.13.0-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure>


<h3 id="8-deploy-msg-mst"><a href="#8-deploy-msg-mst" class="headerlink" title="8.deploy msg/mst"></a>8.deploy msg/mst</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS1 ~]# fdisk -l|grep sd</span><br><span class="line">Disk &#x2F;dev&#x2F;sda: 68.7 GB, 68719476736 bytes, 134217728 sectors</span><br><span class="line">&#x2F;dev&#x2F;sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">&#x2F;dev&#x2F;sda2         2099200   134217727    66059264   8e  Linux LVM</span><br><span class="line">Disk &#x2F;dev&#x2F;sdc: 25.8 GB, 25769803776 bytes, 50331648 sectors</span><br><span class="line">Disk &#x2F;dev&#x2F;sdb: 25.8 GB, 25769803776 bytes, 50331648 sectors</span><br><span class="line">[root@CentOS1 ~]# mkfs.lustre --mgs  &#x2F;dev&#x2F;sdb</span><br><span class="line">[root@CentOS1 ~]# mkdir &#x2F;mgt</span><br><span class="line">[root@CentOS1 ~]# mount.lustre  &#x2F;dev&#x2F;sdb &#x2F;mgt&#x2F;</span><br><span class="line">[root@CentOS1 ~]# df -h</span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs                 905M     0  905M   0% &#x2F;dev</span><br><span class="line">tmpfs                    917M     0  917M   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs                    917M  9.0M  908M   1% &#x2F;run</span><br><span class="line">tmpfs                    917M     0  917M   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root   41G  2.9G   39G   7% &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sda1               1014M  193M  822M  20% &#x2F;boot</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-home   20G   33M   20G   1% &#x2F;home</span><br><span class="line">tmpfs                    184M     0  184M   0% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line">&#x2F;dev&#x2F;sdb                  24G   46M   23G   1% &#x2F;mgt</span><br></pre></td></tr></table></figure>
<h3 id="9-deploy-mds-mdt"><a href="#9-deploy-mds-mdt" class="headerlink" title="9.deploy mds/mdt"></a>9.deploy mds/mdt</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;mkfs.lustre --fsname&#x3D;lustrefs --mgsnode&#x3D;msg_node@tcp0  --mdt --index&#x3D;0 &#x2F;dev&#x2F;sdc</span><br><span class="line">[root@CentOS1 ~]# mkfs.lustre --fsname&#x3D;lustrefs --mgsnode&#x3D;10.211.55.3@tcp0  --mdt --index&#x3D;0 &#x2F;dev&#x2F;sdc</span><br><span class="line"></span><br><span class="line">   Permanent disk data:</span><br><span class="line">Target:     lustrefs:MDT0000</span><br><span class="line">Index:      0</span><br><span class="line">Lustre FS:  lustrefs</span><br><span class="line">Mount type: ldiskfs</span><br><span class="line">Flags:      0x61</span><br><span class="line">              (MDT first_time update )</span><br><span class="line">Persistent mount opts: user_xattr,errors&#x3D;remount-ro</span><br><span class="line">Parameters: mgsnode&#x3D;10.211.55.3@tcp</span><br><span class="line"></span><br><span class="line">checking for existing Lustre data: not found</span><br><span class="line">device size &#x3D; 24576MB</span><br><span class="line">formatting backing filesystem ldiskfs on &#x2F;dev&#x2F;sdc</span><br><span class="line">        target name   lustrefs:MDT0000</span><br><span class="line">        kilobytes     25165824</span><br><span class="line">        options        -J size&#x3D;983 -I 1024 -i 2560 -q -O dirdata,uninit_bg,^extents,dir_nlink,quota,huge_file,ea_inode,flex_bg -E lazy_journal_init -F</span><br><span class="line">mkfs_cmd &#x3D; mke2fs -j -b 4096 -L lustrefs:MDT0000  -J size&#x3D;983 -I 1024 -i 2560 -q -O dirdata,uninit_bg,^extents,dir_nlink,quota,huge_file,ea_inode,flex_bg -E lazy_journal_init -F &#x2F;dev&#x2F;sdc 25165824k</span><br><span class="line">Writing CONFIGS&#x2F;mountdata</span><br><span class="line">[root@CentOS1 ~]# mkdir &#x2F;mdt</span><br><span class="line">[root@CentOS1 ~]# mount.lustre &#x2F;dev&#x2F;sdc  &#x2F;mdt</span><br></pre></td></tr></table></figure>

<h3 id="10-deploy-oss-ost"><a href="#10-deploy-oss-ost" class="headerlink" title="10.deploy oss/ost"></a>10.deploy oss/ost</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;mkfs.lustre --ost --fsname&#x3D;lustrefs --mgsnode&#x3D;mgs_node@tcp0 --index&#x3D;1 &#x2F;dev&#x2F;sdb</span><br><span class="line"></span><br><span class="line">[root@CentOS2 ~]# mkfs.lustre --ost --fsname&#x3D;lustrefs --mgsnode&#x3D;10.211.55.3@tcp0 --index&#x3D;1 &#x2F;dev&#x2F;sdb</span><br><span class="line"></span><br><span class="line">   Permanent disk data:</span><br><span class="line">Target:     lustrefs:OST0001</span><br><span class="line">Index:      1</span><br><span class="line">Lustre FS:  lustrefs</span><br><span class="line">Mount type: ldiskfs</span><br><span class="line">Flags:      0x62</span><br><span class="line">              (OST first_time update )</span><br><span class="line">Persistent mount opts: ,errors&#x3D;remount-ro</span><br><span class="line">Parameters: mgsnode&#x3D;10.211.55.3@tcp</span><br><span class="line"></span><br><span class="line">checking for existing Lustre data: not found</span><br><span class="line">device size &#x3D; 24576MB</span><br><span class="line">formatting backing filesystem ldiskfs on &#x2F;dev&#x2F;sdb</span><br><span class="line">        target name   lustrefs:OST0001</span><br><span class="line">        kilobytes     25165824</span><br><span class="line">        options        -J size&#x3D;983 -I 512 -i 69905 -q -O extents,uninit_bg,dir_nlink,quota,huge_file,flex_bg -G 256 -E resize&#x3D;&quot;4290772992&quot;,lazy_journal_init -F</span><br><span class="line">mkfs_cmd &#x3D; mke2fs -j -b 4096 -L lustrefs:OST0001  -J size&#x3D;983 -I 512 -i 69905 -q -O extents,uninit_bg,dir_nlink,quota,huge_file,flex_bg -G 256 -E resize&#x3D;&quot;4290772992&quot;,lazy_journal_init -F &#x2F;dev&#x2F;sdb 25165824k</span><br><span class="line">Writing CONFIGS&#x2F;mountdata</span><br><span class="line">[root@CentOS2 ~]# mkdir &#x2F;ost</span><br><span class="line">[root@CentOS2 ~]# mount.lustre  &#x2F;dev&#x2F;sdb &#x2F;ost&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="11-mount-on-client-node"><a href="#11-mount-on-client-node" class="headerlink" title="11.mount on client node"></a>11.mount on client node</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS3 ~]# mkdir &#x2F;mnt&#x2F;lustrefs</span><br><span class="line">[root@CentOS3 ~]# mount -t lustre 10.211.55.3@tcp0:&#x2F;lustrefs &#x2F;mnt&#x2F;lustrefs</span><br><span class="line">[root@CentOS3 ~]# df -h</span><br><span class="line">Filesystem                 Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs                   906M     0  906M   0% &#x2F;dev</span><br><span class="line">tmpfs                      917M     0  917M   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs                      917M  9.0M  908M   1% &#x2F;run</span><br><span class="line">tmpfs                      917M     0  917M   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root     41G  2.8G   39G   7% &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sda1                 1014M  149M  866M  15% &#x2F;boot</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-home     20G   33M   20G   1% &#x2F;home</span><br><span class="line">tmpfs                      184M     0  184M   0% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line">10.211.55.3@tcp:&#x2F;lustrefs   23G   46M   22G   1% &#x2F;mnt&#x2F;lustrefs</span><br></pre></td></tr></table></figure>

<h2 id="chapter-2-lustre-process"><a href="#chapter-2-lustre-process" class="headerlink" title="chapter 2. lustre process"></a>chapter 2. lustre process</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;show luste mgs info</span><br><span class="line">[root@CentOS1 ~]# ps -ef|grep mgs</span><br><span class="line">root      2275     2  0 13:29 ?        00:00:00 [mgs_params_noti]</span><br><span class="line">root      2276     2  0 13:29 ?        00:00:00 [ll_mgs_0000]</span><br><span class="line">root      2277     2  0 13:29 ?        00:00:00 [ll_mgs_0001]</span><br><span class="line">root      2278     2  0 13:29 ?        00:00:00 [ll_mgs_0002]</span><br><span class="line">root      2375     2  0 13:31 ?        00:00:00 [mgs_lustrefs_no]</span><br><span class="line">root      2548  2105  0 13:49 pts&#x2F;0    00:00:00 grep --color&#x3D;auto mgs</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;show lustre mdt process</span><br><span class="line">[root@CentOS1 ~]# ps -ef|grep mdt</span><br><span class="line">root      2357     2  0 13:31 ?        00:00:00 [mdt00_000]</span><br><span class="line">root      2358     2  0 13:31 ?        00:00:00 [mdt00_001]</span><br><span class="line">root      2359     2  0 13:31 ?        00:00:01 [mdt00_002]</span><br><span class="line">root      2360     2  0 13:31 ?        00:00:00 [mdt_rdpg00_000]</span><br><span class="line">root      2361     2  0 13:31 ?        00:00:00 [mdt_rdpg00_001]</span><br><span class="line">root      2362     2  0 13:31 ?        00:00:00 [mdt_attr00_000]</span><br><span class="line">root      2363     2  0 13:31 ?        00:00:00 [mdt_attr00_001]</span><br><span class="line">root      2364     2  0 13:31 ?        00:00:00 [mdt_out00_000]</span><br><span class="line">root      2365     2  0 13:31 ?        00:00:00 [mdt_out00_001]</span><br><span class="line">root      2366     2  0 13:31 ?        00:00:00 [mdt_seqs_0000]</span><br><span class="line">root      2367     2  0 13:31 ?        00:00:00 [mdt_seqs_0001]</span><br><span class="line">root      2368     2  0 13:31 ?        00:00:00 [mdt_seqm_0000]</span><br><span class="line">root      2369     2  0 13:31 ?        00:00:00 [mdt_seqm_0001]</span><br><span class="line">root      2370     2  0 13:31 ?        00:00:00 [mdt_fld_0000]</span><br><span class="line">root      2371     2  0 13:31 ?        00:00:00 [mdt_fld_0001]</span><br><span class="line">root      2372     2  0 13:31 ?        00:00:00 [mdt_io00_000]</span><br><span class="line">root      2373     2  0 13:31 ?        00:00:00 [mdt_io00_001]</span><br><span class="line">root      2374     2  0 13:31 ?        00:00:00 [mdt_io00_002]</span><br><span class="line">root      2540     2  0 13:48 ?        00:00:00 [mdt00_003]</span><br><span class="line">root      2552  2105  0 13:49 pts&#x2F;0    00:00:00 grep --color&#x3D;auto mdt</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;show ost process</span><br><span class="line">[root@CentOS2 ~]# ps -ef|grep ost</span><br><span class="line">root      1854     1  0 13:09 ?        00:00:00 &#x2F;usr&#x2F;libexec&#x2F;postfix&#x2F;master -w</span><br><span class="line">postfix   1859  1854  0 13:09 ?        00:00:00 pickup -l -t unix -u</span><br><span class="line">postfix   1860  1854  0 13:09 ?        00:00:00 qmgr -l -t unix -u</span><br><span class="line">root      2431     2  0 13:47 ?        00:00:00 [ll_ost00_000]</span><br><span class="line">root      2432     2  0 13:47 ?        00:00:00 [ll_ost00_001]</span><br><span class="line">root      2433     2  0 13:47 ?        00:00:00 [ll_ost00_002]</span><br><span class="line">root      2434     2  0 13:47 ?        00:00:00 [ll_ost_create00]</span><br><span class="line">root      2435     2  0 13:47 ?        00:00:00 [ll_ost_create00]</span><br><span class="line">root      2436     2  0 13:47 ?        00:00:00 [ll_ost_io00_000]</span><br><span class="line">root      2437     2  0 13:47 ?        00:00:00 [ll_ost_io00_001]</span><br><span class="line">root      2438     2  0 13:47 ?        00:00:00 [ll_ost_io00_002]</span><br><span class="line">root      2439     2  0 13:47 ?        00:00:00 [ll_ost_seq00_00]</span><br><span class="line">root      2440     2  0 13:47 ?        00:00:00 [ll_ost_seq00_00]</span><br><span class="line">root      2441     2  0 13:47 ?        00:00:00 [ll_ost_out00_00]</span><br><span class="line">root      2442     2  0 13:47 ?        00:00:00 [ll_ost_out00_00]</span><br><span class="line">root      2473  2111  0 13:49 pts&#x2F;0    00:00:00 grep --color&#x3D;auto ost</span><br></pre></td></tr></table></figure>

<h2 id="chapter-3-script"><a href="#chapter-3-script" class="headerlink" title="chapter 3.script"></a>chapter 3.script</h2><ul>
<li>start mgs/mdt</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">modprobe  zfs</span><br><span class="line">modprobe  lustre</span><br><span class="line">modprobe  lnet</span><br><span class="line">&#x2F;&#x2F;execute on mgs&#x2F;mdt node</span><br><span class="line">mount.lustre &#x2F;dev&#x2F;sdc  &#x2F;mdt</span><br><span class="line">mount.lustre  &#x2F;dev&#x2F;sdb &#x2F;mgt&#x2F;</span><br></pre></td></tr></table></figure>
<ul>
<li>start ost</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modprobe  zfs</span><br><span class="line">modprobe  lustre</span><br><span class="line">modprobe  lnet</span><br><span class="line">mount.lustre  &#x2F;dev&#x2F;sdb &#x2F;ost&#x2F;</span><br></pre></td></tr></table></figure>
<ul>
<li>mount </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t lustre 10.211.55.3@tcp0:&#x2F;lustrefs &#x2F;mnt&#x2F;lustrefs</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/21/glusterfs%E9%9B%86%E7%BE%A4glusterd%E6%98%BE%E7%A4%BADisconnect%E7%8A%B6%E6%80%81%E5%AF%BC%E8%87%B4%E9%9B%86%E7%BE%A4IO%E8%AF%B7%E6%B1%82%E5%8F%98%E6%85%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/21/glusterfs%E9%9B%86%E7%BE%A4glusterd%E6%98%BE%E7%A4%BADisconnect%E7%8A%B6%E6%80%81%E5%AF%BC%E8%87%B4%E9%9B%86%E7%BE%A4IO%E8%AF%B7%E6%B1%82%E5%8F%98%E6%85%A2/" class="post-title-link" itemprop="url">glusterfs集群glusterd显示Disconnect状态导致集群IO请求变慢</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-21 11:43:12 / Modified: 11:44:58" itemprop="dateCreated datePublished" datetime="2020-04-21T11:43:12+08:00">2020-04-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="glusterfs集群glusterd显示Disconnect状态导致集群IO请求变慢"><a href="#glusterfs集群glusterd显示Disconnect状态导致集群IO请求变慢" class="headerlink" title="glusterfs集群glusterd显示Disconnect状态导致集群IO请求变慢"></a>glusterfs集群glusterd显示Disconnect状态导致集群IO请求变慢</h3><h4 id="172-25-78-16节点的集群状态"><a href="#172-25-78-16节点的集群状态" class="headerlink" title="172.25.78.16节点的集群状态"></a>172.25.78.16节点的集群状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@szdpl1491 ~]# gluster pool list</span><br><span class="line">UUID                                    Hostname        State</span><br><span class="line">bde7b9e2-af2a-419e-8242-6a8f8e18bb8a    172.25.78.242   Disconnected </span><br><span class="line">54fa8ec0-3617-4c8e-968a-7402a80a9017    172.25.78.240   Connected </span><br><span class="line">588bb497-5d9f-4bcf-b0b1-c9d364afb084    172.25.78.241   Connected </span><br><span class="line">a8522deb-ee16-44a3-a800-9525cb8d64fa    localhost       Connected</span><br></pre></td></tr></table></figure>
<ul>
<li>172.25.78.242节点在172.25.78.16的状态明显不对，查看其它的节点242的认证信息</li>
</ul>
<h4 id="172-25-78-240节点的集群状态"><a href="#172-25-78-240节点的集群状态" class="headerlink" title="172.25.78.240节点的集群状态"></a>172.25.78.240节点的集群状态</h4>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@szdpl1543 ~]# gluster pool list</span><br><span class="line">UUID                                    Hostname        State</span><br><span class="line">588bb497-5d9f-4bcf-b0b1-c9d364afb084    172.25.78.241   Connected </span><br><span class="line">bde7b9e2-af2a-419e-8242-6a8f8e18bb8a    172.25.78.242   Connected </span><br><span class="line">a8522deb-ee16-44a3-a800-9525cb8d64fa    172.25.78.16    Connected </span><br><span class="line">54fa8ec0-3617-4c8e-968a-7402a80a9017    localhost       Connected </span><br><span class="line">[root@szdpl1543 ~]# cd &#x2F;var&#x2F;lib&#x2F;glusterd&#x2F;peers&#x2F;</span><br><span class="line">[root@szdpl1543 peers]# ls</span><br><span class="line">588bb497-5d9f-4bcf-b0b1-c9d364afb084  a8522deb-ee16-44a3-a800-9525cb8d64fa  bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">[root@szdpl1543 peers]# cat bde7b9e2-af2a-419e-8242-6a8f8e18bb8a </span><br><span class="line">uuid&#x3D;bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">state&#x3D;3</span><br><span class="line">hostname1&#x3D;172.25.78.242</span><br><span class="line">hostname2&#x3D;bogon</span><br><span class="line">[root@szdpl1543 peers]# vi bde7b9e2-af2a-419e-8242-6a8f8e18bb8a </span><br><span class="line">uuid&#x3D;bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">state&#x3D;3</span><br><span class="line">hostname1&#x3D;172.25.78.242</span><br></pre></td></tr></table></figure>



<h4 id="172-25-78-16节点的集群状态-1"><a href="#172-25-78-16节点的集群状态-1" class="headerlink" title="172.25.78.16节点的集群状态"></a>172.25.78.16节点的集群状态</h4>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@szdpl1491 ~]# gluster pool list</span><br><span class="line"> UUID                                    Hostname        State</span><br><span class="line">  bde7b9e2-af2a-419e-8242-6a8f8e18bb8a    172.25.78.242   Disconnected </span><br><span class="line">  54fa8ec0-3617-4c8e-968a-7402a80a9017    172.25.78.240   Connected </span><br><span class="line">  588bb497-5d9f-4bcf-b0b1-c9d364afb084    172.25.78.241   Connected </span><br><span class="line">  a8522deb-ee16-44a3-a800-9525cb8d64fa    localhost       Connected</span><br><span class="line">[root@szdpl1491 ~]# cd &#x2F;var&#x2F;lib&#x2F;glusterd&#x2F;peers&#x2F;</span><br><span class="line">[root@szdpl1491 peers]# ls</span><br><span class="line">54fa8ec0-3617-4c8e-968a-7402a80a9017  588bb497-5d9f-4bcf-b0b1-c9d364afb084  bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">[root@szdpl1491 peers]# cat bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">uuid&#x3D;bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">state&#x3D;3</span><br><span class="line">hostname1&#x3D;bogon</span><br><span class="line">hostname2&#x3D;172.25.78.242</span><br></pre></td></tr></table></figure>
<ul>
<li>修改每个节点的var/lib/glusterd/peers/bde7b9e2-af2a-419e-8242-6a8f8e18bb8a 中的hostname1修改为真实的IP，然后重启每个节点的glusterd的服务(systemctl restart glusterd)</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/21/%E5%AE%89%E8%A3%85glusterfs%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/21/%E5%AE%89%E8%A3%85glusterfs%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC/" class="post-title-link" itemprop="url">安装glusterfs指定版本</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-21 09:48:29 / Modified: 09:52:34" itemprop="dateCreated datePublished" datetime="2020-04-21T09:48:29+08:00">2020-04-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="1-glusterfs7-repo源"><a href="#1-glusterfs7-repo源" class="headerlink" title="1.glusterfs7 repo源"></a>1.glusterfs7 repo源</h4><ul>
<li>添加此源到/etc/yum.repo.d/glusterfs.repo中<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[centos-gluster7]</span><br><span class="line">gpgcheck &#x3D; 0</span><br><span class="line">mirrorlist &#x3D; http:&#x2F;&#x2F;mirrorlist.centos.org?arch&#x3D;$basearch&amp;release&#x3D;$releasever&amp;repo&#x3D;storage-gluster-7</span><br><span class="line">name &#x3D; CentOS-$releasever - Gluster 7</span><br><span class="line"></span><br><span class="line">[centos-gluster6]</span><br><span class="line">gpgcheck &#x3D; 0</span><br><span class="line">mirrorlist &#x3D; http:&#x2F;&#x2F;mirrorlist.centos.org?arch&#x3D;$basearch&amp;release&#x3D;$releasever&amp;repo&#x3D;storage-gluster-6</span><br><span class="line">name &#x3D; CentOS-$releasever - Gluster 6</span><br></pre></td></tr></table></figure>
<h4 id="2-更新系统yum-源"><a href="#2-更新系统yum-源" class="headerlink" title="2.更新系统yum 源"></a>2.更新系统yum 源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum check-update</span><br></pre></td></tr></table></figure>
<h4 id="3-安装脚本-glusterfs-install-sh"><a href="#3-安装脚本-glusterfs-install-sh" class="headerlink" title="3.安装脚本(glusterfs_install.sh)"></a>3.安装脚本(glusterfs_install.sh)</h4></li>
<li>脚本内容<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">version&#x3D;&quot;$1&quot;</span><br><span class="line">[[ &quot;$version&quot; &#x3D;&#x3D; &quot;&quot; ]] &amp;&amp; echo &quot;version not provided&quot; &amp;&amp; exit 1</span><br><span class="line"></span><br><span class="line">rpm_packages&#x3D;(</span><br><span class="line">glusterfs-server</span><br><span class="line">glusterfs-events</span><br><span class="line">glusterfs-extra-xlators</span><br><span class="line">glusterfs-geo-replication</span><br><span class="line">glusterfs-libs</span><br><span class="line">glusterfs-rdma</span><br><span class="line">glusterfs</span><br><span class="line">glusterfs-api</span><br><span class="line">glusterfs-api-devel</span><br><span class="line">glusterfs-cli</span><br><span class="line">glusterfs-client-xlators</span><br><span class="line">glusterfs-fuse</span><br><span class="line">python2-gluster</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for index in $&#123;!rpm_packages[@]&#125;; do</span><br><span class="line">  rpm_version_packages[$index]&#x3D;$&#123;rpm_packages[$index]&#125;&quot;-&quot;$version</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum install -y $&#123;rpm_version_packages[*]&#125;</span><br></pre></td></tr></table></figure></li>
<li>脚本执行<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 7.2是版本号</span><br><span class="line">.&#x2F;glusterfs_install.sh 7.2</span><br></pre></td></tr></table></figure>







</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/Go%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8C%E5%87%BD%E6%95%B0%E4%BE%8B%E5%AD%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/Go%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8C%E5%87%BD%E6%95%B0%E4%BE%8B%E5%AD%90/" class="post-title-link" itemprop="url">Go语言调用C函数例子</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-16 18:05:07 / Modified: 18:07:17" itemprop="dateCreated datePublished" datetime="2020-04-16T18:05:07+08:00">2020-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>go access c struct</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">  &#x2F;&#x2F; go run cgo.go</span><br><span class="line">  package main</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;assert.h&gt;</span><br><span class="line">typedef struct student &#123;</span><br><span class="line">        int age;</span><br><span class="line">        char *name;</span><br><span class="line">&#125;student;</span><br><span class="line"></span><br><span class="line">void student_init(void **ptr,char *name,int age) &#123;</span><br><span class="line">        size_t len &#x3D; strlen(name);</span><br><span class="line">        student *st &#x3D; (student *)calloc(1,sizeof(student));</span><br><span class="line">        assert(st!&#x3D;NULL);</span><br><span class="line">        st-&gt;age &#x3D; age;</span><br><span class="line">        st-&gt;name &#x3D; (char *)calloc(1,len+1);</span><br><span class="line">        memcpy(st-&gt;name,name,len);</span><br><span class="line">        *ptr &#x3D; st;</span><br><span class="line">        fprintf(stdout,&quot;...call student_init...\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line">student *student_new(char *name,int age) &#123;</span><br><span class="line">        size_t len &#x3D; strlen(name);</span><br><span class="line">        student *st &#x3D; (student *)calloc(1,sizeof(student));</span><br><span class="line">        assert(st!&#x3D;NULL);</span><br><span class="line">        st-&gt;age &#x3D; age;</span><br><span class="line">        st-&gt;name &#x3D; (char *)calloc(1,len+1);</span><br><span class="line">        memcpy(st-&gt;name,name,len);</span><br><span class="line"></span><br><span class="line">        fprintf(stdout,&quot;...call student_new...\n&quot;);</span><br><span class="line">        return st;</span><br><span class="line">&#125;</span><br><span class="line">void student_destroy(void *ptr) &#123;</span><br><span class="line">        student *st &#x3D; (student *)ptr;</span><br><span class="line">        if(st !&#x3D;NULL)</span><br><span class="line">        &#123;</span><br><span class="line">                free(st-&gt;name);</span><br><span class="line">                free(st);</span><br><span class="line">                st&#x3D;NULL;</span><br><span class="line">                fprintf(stdout,&quot;...call student_destroy...\n&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">void student_print(void  *ptr) &#123;</span><br><span class="line">        student *st &#x3D; (student *)ptr;</span><br><span class="line">        fprintf(stdout,&quot;student addr&#x3D;%p,name&#x3D;%p,age&#x3D;%p\n&quot;,st,st-&gt;name,&amp;st-&gt;age);</span><br><span class="line">        fprintf(stdout,&quot; student &#123;name&#x3D;%s,age&#x3D;%d&#125;\n&quot;,st-&gt;name,st-&gt;age);</span><br><span class="line">&#125;</span><br><span class="line">*&#x2F;</span><br><span class="line">import &quot;C&quot;</span><br><span class="line">import (</span><br><span class="line">        &quot;fmt&quot;</span><br><span class="line">        &quot;unsafe&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">        var st1 unsafe.Pointer</span><br><span class="line">        name :&#x3D; C.CString(&quot;perrynzhou&quot;)</span><br><span class="line">        C.student_init(&amp;st1, name, 30)</span><br><span class="line">        C.student_print(st1)</span><br><span class="line">        C.student_destroy(st1)</span><br><span class="line">        C.free(unsafe.Pointer(name))</span><br><span class="line"></span><br><span class="line">        var st2 *C.student</span><br><span class="line">        name2 :&#x3D; C.CString(&quot;hello&quot;)</span><br><span class="line">        st2 &#x3D; C.student_new(name2, 100)</span><br><span class="line">        fmt.Printf(&quot;init student st2 &#123;age:%d,name:%s&#125;\n&quot;, st2.age, C.GoString(st2.name))</span><br><span class="line">        C.student_print(unsafe.Pointer(st2))</span><br><span class="line"></span><br><span class="line">        C.free(unsafe.Pointer(st2.name))</span><br><span class="line">        name3 :&#x3D; C.CString(&quot;join&quot;)</span><br><span class="line">        st2.name &#x3D; name3</span><br><span class="line">        st2.age &#x3D; 67</span><br><span class="line">        fmt.Printf(&quot;after change student st2 &#123;age:%d,name:%s&#125;\n&quot;, st2.age, C.GoString(st2.name))</span><br><span class="line">        C.student_print(unsafe.Pointer(st2))</span><br><span class="line">        C.student_destroy(unsafe.Pointer(st2))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/16/Go%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8C%E5%87%BD%E6%95%B0%E4%BE%8B%E5%AD%90/2582954-7ff22e6700b629e6.png" alt></p>
<ul>
<li>go access c memory<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;    go build  -o cgo_test cgo.go </span><br><span class="line"></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">void *alloc() &#123;</span><br><span class="line">        static int count &#x3D; 0;</span><br><span class="line">        void *d &#x3D; malloc(sizeof(int));</span><br><span class="line">        *((int *)d) &#x3D; count++;</span><br><span class="line">        return d;</span><br><span class="line">&#125;</span><br><span class="line">*&#x2F;</span><br><span class="line">import &quot;C&quot;</span><br><span class="line">import (</span><br><span class="line">        &quot;fmt&quot;</span><br><span class="line">        &quot;runtime&quot;</span><br><span class="line">        &quot;sync&quot;</span><br><span class="line">        &quot;time&quot;</span><br><span class="line">        &quot;unsafe&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type CStruct struct &#123;</span><br><span class="line">        sync.Mutex</span><br><span class="line">        name     string</span><br><span class="line">        allocCnt int</span><br><span class="line">        memory   unsafe.Pointer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (cs *CStruct) alloc(name string, id int) &#123;</span><br><span class="line">        cs.name &#x3D; fmt.Sprintf(&quot;CStruct-%s-%d&quot;, name, id)</span><br><span class="line">        cs.Lock()</span><br><span class="line">        defer cs.Unlock()</span><br><span class="line">        cs.allocCnt++</span><br><span class="line">        fmt.Printf(&quot;%s begin with alloc,count&#x3D;%d\n&quot;, cs.name, cs.allocCnt)</span><br><span class="line">        cs.memory &#x3D; C.alloc()</span><br><span class="line">        runtime.SetFinalizer(cs, free)</span><br><span class="line">&#125;</span><br><span class="line">func free(cs *CStruct) &#123;</span><br><span class="line">        C.free(unsafe.Pointer(cs.memory))</span><br><span class="line">        cs.Lock()</span><br><span class="line">        defer cs.Unlock()</span><br><span class="line">        cs.allocCnt--</span><br><span class="line">        fmt.Printf(&quot;%s end with free count&#x3D;%d\n&quot;, cs.name, cs.allocCnt)</span><br><span class="line">&#125;</span><br><span class="line">func CStructTest(i int) &#123;</span><br><span class="line">        var c1, c2 CStruct</span><br><span class="line">        c1.alloc(&quot;c1&quot;, i)</span><br><span class="line">        c2.alloc(&quot;c2&quot;, i)</span><br><span class="line">&#125;</span><br><span class="line">func main() &#123;</span><br><span class="line">        for i :&#x3D; 0; i &lt; 10; i++ &#123;</span><br><span class="line">                CStructTest(i)</span><br><span class="line">                time.Sleep(time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">        runtime.GC()</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        fmt.Println(&quot;done..&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2020/04/16/Go%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8C%E5%87%BD%E6%95%B0%E4%BE%8B%E5%AD%90/2582954-4171fe1cc79448ad.png" alt></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84shell/" class="post-title-link" itemprop="url">实现简单的shell</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-16 18:01:22 / Modified: 18:02:44" itemprop="dateCreated datePublished" datetime="2020-04-16T18:01:22+08:00">2020-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>shell实现代码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*************************************************************************</span><br><span class="line">  &gt; File Name: shell.c</span><br><span class="line">  &gt; Author:perrynzhou </span><br><span class="line">  &gt; Mail:perrynzhou@gmail.com </span><br><span class="line">  &gt; Created Time: Thu 20 Jun 2019 09:15:59 PM CST</span><br><span class="line"> ************************************************************************&#x2F;</span><br><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;glob.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;types.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;wait.h&gt;</span><br><span class="line">static const char *delimiter &#x3D; &quot; \t\n&quot;;</span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  glob_t gt;</span><br><span class="line">  int (*cmd_cd_fn)(char **argv);</span><br><span class="line">  int (*cmd_exit_fn)(char **argv);</span><br><span class="line">  int (*cmd_help_fn)(char **argv);</span><br><span class="line">&#125; cmd_t;</span><br><span class="line">static void prompt()</span><br><span class="line">&#123;</span><br><span class="line">  fprintf(stdout, &quot;zsh-0.1$ &quot;);</span><br><span class="line">&#125;</span><br><span class="line">void parsed_cmd(char *line, cmd_t *cmd)</span><br><span class="line">&#123;</span><br><span class="line">  char *token;</span><br><span class="line">  int flag &#x3D; 0;</span><br><span class="line">  while (1)</span><br><span class="line">  &#123;</span><br><span class="line">    token &#x3D; strsep(&amp;line, delimiter);</span><br><span class="line">    if (token &#x3D;&#x3D; NULL)</span><br><span class="line">    &#123;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">    if (*token &#x3D;&#x3D; &#39;\0&#39;)</span><br><span class="line">    &#123;</span><br><span class="line">      continue;</span><br><span class="line">    &#125;</span><br><span class="line">    glob(token, GLOB_NOCHECK | GLOB_APPEND * flag, NULL, &amp;cmd-&gt;gt);</span><br><span class="line">    flag &#x3D; 1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">  char *line &#x3D; NULL;</span><br><span class="line">  size_t line_size &#x3D; 0;</span><br><span class="line">  cmd_t cmd;</span><br><span class="line">  pid_t pid;</span><br><span class="line">  while (1)</span><br><span class="line">  &#123;</span><br><span class="line">    prompt();</span><br><span class="line">    if (getline(&amp;line, &amp;line_size, stdin) &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">    parsed_cmd(line, &amp;cmd);</span><br><span class="line">    pid &#x3D; fork();</span><br><span class="line">    switch (pid)</span><br><span class="line">    &#123;</span><br><span class="line">    case -1:</span><br><span class="line">      perror(&quot;fork()&quot;);</span><br><span class="line">      exit(1);</span><br><span class="line">    case 0:</span><br><span class="line">      execvp(cmd.gt.gl_pathv[0], cmd.gt.gl_pathv);</span><br><span class="line">      exit(0);</span><br><span class="line">    default:</span><br><span class="line">      wait(NULL);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/%E5%85%B3%E4%BA%8ECPU%E5%AD%97%E8%8A%82%E5%BA%8F%E7%9A%84%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/%E5%85%B3%E4%BA%8ECPU%E5%AD%97%E8%8A%82%E5%BA%8F%E7%9A%84%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="url">关于CPU字节序的理解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-16 17:59:50 / Modified: 18:01:04" itemprop="dateCreated datePublished" datetime="2020-04-16T17:59:50+08:00">2020-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="为什么会有字节序这一说法"><a href="#为什么会有字节序这一说法" class="headerlink" title="为什么会有字节序这一说法"></a>为什么会有字节序这一说法</h2><ul>
<li>对于单字节处理器不存在字节序，对于大于1个字节的位数的CPU，其寄存器的宽度也大于1个字节，所以存储字节排序的问题</li>
</ul>
<h2 id="大端字节序排序"><a href="#大端字节序排序" class="headerlink" title="大端字节序排序"></a>大端字节序排序</h2><ul>
<li>大端：高字节位在低地址存储，低字节位在高地址存储</li>
<li>小端: 高字节位存储在高地址，低字节位存储在低地址<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> 例如 int  x &#x3D; 0x0001,假设是在64位的CPU上，它的地址空间为：0xff13,其字节排序可能有两种可能：</span><br><span class="line">  oxff13: 0  0  0  1   ---&gt;第一种情况 大端</span><br><span class="line">  0xff13: 1  0  0  0   ---&gt;第二种情况 小端</span><br><span class="line">在x这个值中0001从左往右是高字节位到低字节位，也就是 0,0 是高字节，0 1 是低字节位。</span><br></pre></td></tr></table></figure>
<h2 id="如何验证CPU的字节序呢？"><a href="#如何验证CPU的字节序呢？" class="headerlink" title="如何验证CPU的字节序呢？"></a>如何验证CPU的字节序呢？</h2></li>
<li>C语言中有union结构，这个结构的数据存储是从低地址向高地址依次存储值，可以通过这个特性来验证CPU的字节序<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*************************************************************************</span><br><span class="line">  &gt; File Name: byte_order.c</span><br><span class="line">  &gt; Author:perrynzhou </span><br><span class="line">  &gt; Mail:perrynzhou@gmail.com </span><br><span class="line">  &gt; Created Time: Fri 15 Nov 2019 03:42:37 PM CST</span><br><span class="line"> ************************************************************************&#x2F;</span><br><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">typedef union object_t &#123;</span><br><span class="line">    int a;</span><br><span class="line">    char b;</span><br><span class="line">&#125; object;</span><br><span class="line">enum</span><br><span class="line">&#123;</span><br><span class="line">    big_endian_type &#x3D; 0,</span><br><span class="line">    small_endian_type,</span><br><span class="line">&#125;;</span><br><span class="line">int checkCpu(object *obj)</span><br><span class="line">&#123;</span><br><span class="line">    return obj-&gt;b &#x3D;&#x3D; 1 ? small_endian_type : big_endian_type;</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int v &#x3D; 0x0001;</span><br><span class="line">    object obj;</span><br><span class="line">    obj.a &#x3D; v;</span><br><span class="line">    fprintf(stdout, &quot;value:%d,value_string:%s,object address:%p\n&quot;, v, &quot;0x0001&quot;, &amp;obj);</span><br><span class="line">    if (checkCpu(&amp;obj) &#x3D;&#x3D; big_endian_type)</span><br><span class="line">    &#123;</span><br><span class="line">        fprintf(stdout, &quot;store plan: |%d|%d|%d|%d|,big endian\n&quot;, 0, 0, 0, 1);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        fprintf(stdout, &quot;store plan: |%d|%d|%d|%d|,small endian\n&quot;, 1, 0, 0, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[perrynzhou@localhost ~&#x2F;Source&#x2F;vivo&#x2F;linux_kernel_study&#x2F;chapter_01]$ .&#x2F;test </span><br><span class="line">value:1,value_string:0x0001,object address:0x7ffcaf058a08</span><br><span class="line">store plan: |0|0|0|1|,big endian</span><br><span class="line">[perrynzhou@localhost ~&#x2F;Source&#x2F;vivo&#x2F;linux_kernel_study&#x2F;chapter_01]$</span><br></pre></td></tr></table></figure>



</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/glusterfs%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/glusterfs%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E/" class="post-title-link" itemprop="url">glusterfs参数说明</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-16 17:58:49 / Modified: 18:10:39" itemprop="dateCreated datePublished" datetime="2020-04-16T17:58:49+08:00">2020-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="选项说明"><a href="#选项说明" class="headerlink" title="选项说明"></a>选项说明</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gluster volume set help</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="center">默认值</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">changelog.changelog-barrier-timeout</td>
<td align="center">120</td>
<td align="left">After ‘timeout’ seconds since the time ‘barrier’ option was set to “on”, unlink/rmdir/rename operations are no longer blocked and previously blocked fops are allowed to go through</td>
</tr>
<tr>
<td align="left">cluster.enable-shared-storage</td>
<td align="center">disable</td>
<td align="left">Create and mount the shared storage volume(gluster_shared_storage) at /var/run/gluster/shared_storage on enabling this option. Unmount and delete the shared storage volume on disabling this option.</td>
</tr>
<tr>
<td align="left">cluster.write-freq-threshold</td>
<td align="center">0</td>
<td align="left">Defines the number of writes, in a promotion/demotion cycle, that would mark a file HOT for promotion. Any file that has write hits less than this value will be considered as COLD and will be demoted.</td>
</tr>
<tr>
<td align="left">cluster.read-freq-threshold</td>
<td align="center">0</td>
<td align="left">Defines the number of reads, in a promotion/demotion cycle, that would mark a file HOT for promotion. Any file that has read hits less than this value will be considered as COLD and will be demoted.</td>
</tr>
<tr>
<td align="left">cluster.tier-pause</td>
<td align="center">off</td>
<td align="left">(null)</td>
</tr>
<tr>
<td align="left">cluster.tier-promote-frequency</td>
<td align="center">120</td>
<td align="left">Frequency to promote files to fast tier</td>
</tr>
<tr>
<td align="left">cluster.tier-demote-frequency</td>
<td align="center">120</td>
<td align="left">Frequency to demote files to slow tier</td>
</tr>
<tr>
<td align="left">cluster.watermark-hi</td>
<td align="center">90</td>
<td align="left">Upper % watermark for promotion. If hot tier fills above this percentage, no promotion will happen and demotion will happen with high probability.</td>
</tr>
<tr>
<td align="left">cluster.watermark-low</td>
<td align="center">75</td>
<td align="left">Lower % watermark. If hot tier is less full than this, promotion will happen and demotion will not happen. If greater than this, promotion/demotion will happen at a probability relative to how full the hot tier is.</td>
</tr>
<tr>
<td align="left">cluster.tier-mode</td>
<td align="center">cache</td>
<td align="left">Either ‘test’ or ‘cache’. Test mode periodically demotes or promotes files automatically based on access. Cache mode does so based on whether the cache is full or not, as specified with watermarks.</td>
</tr>
<tr>
<td align="left">cluster.tier-max-mb</td>
<td align="center">10000</td>
<td align="left">The maximum number of MB that may be migrated in any direction in a given cycle by a single node.</td>
</tr>
<tr>
<td align="left">cluster.tier-max-files</td>
<td align="center">50000</td>
<td align="left">The maximum number of files that may be migrated in any direction in a given cycle by a single node.</td>
</tr>
<tr>
<td align="left">cluster.lookup-unhashed</td>
<td align="center">on</td>
<td align="left">This option if set to ON, does a lookup through all the sub-volumes, in case a lookup didn’t return any result from the hash subvolume. If set to OFF, it does not do a lookup on the remaining subvolumes.</td>
</tr>
<tr>
<td align="left">cluster.lookup-optimize</td>
<td align="center">off</td>
<td align="left">This option if set to ON enables the optimization of -ve lookups, by not doing a lookup on non-hashed subvolumes for files, in case the hashed subvolume does not return any result. This option disregards the lookup-unhashed setting, when enabled.</td>
</tr>
<tr>
<td align="left">cluster.min-free-disk</td>
<td align="center">10%</td>
<td align="left">Percentage/Size of disk space, after which the process starts balancing out the cluster, and logs will appear in log files</td>
</tr>
<tr>
<td align="left">cluster.min-free-inodes</td>
<td align="center">5%</td>
<td align="left">after system has only N% of inodes, warnings starts to appear in log files</td>
</tr>
<tr>
<td align="left">cluster.rebalance-stats</td>
<td align="center">off</td>
<td align="left">This option if set to ON displays and logs the time taken for migration of each file, during the rebalance process. If set to OFF, the rebalance logs will only display the time spent in each directory.</td>
</tr>
<tr>
<td align="left">cluster.subvols-per-directory</td>
<td align="center">null</td>
<td align="left">Specifies the directory layout spread. Takes number of subvolumes as default value.</td>
</tr>
<tr>
<td align="left">cluster.readdir-optimize</td>
<td align="center">off</td>
<td align="left">This option if set to ON enables the optimization that allows DHT to requests non-first subvolumes to filter out directory entries.</td>
</tr>
<tr>
<td align="left">cluster.rebal-throttle</td>
<td align="center">normal</td>
<td align="left">Sets the maximum number of parallel file migrations allowed on a node during the rebalance operation. The default value is normal and allows a max of [($(processing units) - 4) / 2), 2] files to be migrated at a time. Lazy will allow only one file to be migrated at a time and aggressive will allow max of [($(processing units) - 4) / 2), 4]</td>
</tr>
<tr>
<td align="left">cluster.weighted-rebalance</td>
<td align="center">on</td>
<td align="left">When enabled, files will be allocated to bricks with a probability proportional to their size. Otherwise, all bricks will have the same probability (legacy behavior).</td>
</tr>
<tr>
<td align="left">cluster.entry-change-log</td>
<td align="center">on</td>
<td align="left">Entry fops like create/unlink will not perform pre/post fop changelog operations in afr transaction if this option is disabled</td>
</tr>
<tr>
<td align="left">cluster.read-subvolume</td>
<td align="center">null</td>
<td align="left">inode-read fops happen only on one of the bricks in replicate. Afr will prefer the one specified using this option if it is not stale. Option value must be one of the xlator names of the children. Ex: -client-0 till -client-&lt;number-of-bricks - 1&gt;</td>
</tr>
<tr>
<td align="left">cluster.read-subvolume-index</td>
<td align="center">-1</td>
<td align="left">inode-read fops happen only on one of the bricks in replicate. AFR will prefer the one specified using this option if it is not stale. allowed options include -1 till replica-count - 1</td>
</tr>
<tr>
<td align="left">cluster.read-hash-mode</td>
<td align="center">1</td>
<td align="left">inode-read fops happen only on one of the bricks in replicate. AFR will prefer the one computed using the method specified using this option0 = first up server, 1 = hash by GFID of file (all clients use same subvolume), 2 = hash by GFID of file and client PID</td>
</tr>
<tr>
<td align="left">cluster.background-self-heal-count</td>
<td align="center">16</td>
<td align="left">This specifies the number of self-heals that can be performed in background without blocking the fop</td>
</tr>
<tr>
<td align="left">cluster.metadata-self-heal</td>
<td align="center">on</td>
<td align="left">Using this option we can enable/disable metadata i.e. Permissions, ownerships, xattrs self-heal on the file/directory.</td>
</tr>
<tr>
<td align="left">cluster.data-self-heal</td>
<td align="center">on</td>
<td align="left">Using this option we can enable/disable data self-heal on the file. “open” means data self-heal action will only be triggered by file open operations.</td>
</tr>
<tr>
<td align="left">cluster.entry-self-heal</td>
<td align="center">on</td>
<td align="left">Using this option we can enable/disable entry self-heal on the directory.</td>
</tr>
<tr>
<td align="left">cluster.self-heal-daemon</td>
<td align="center">on</td>
<td align="left">This option applies to only self-heal-daemon. Index directory crawl and automatic healing of files will not be performed if this option is turned off.</td>
</tr>
<tr>
<td align="left">cluster.heal-timeout</td>
<td align="center">600</td>
<td align="left">time interval for checking the need to self-heal in self-heal-daemon</td>
</tr>
<tr>
<td align="left">cluster.self-heal-window-size</td>
<td align="center">1</td>
<td align="left">Maximum number blocks per file for which self-heal process would be applied simultaneously.</td>
</tr>
<tr>
<td align="left">cluster.data-change-log</td>
<td align="center">on</td>
<td align="left">Data fops like write/truncate will not perform pre/post fop changelog operations in afr transaction if this option is disabled</td>
</tr>
<tr>
<td align="left">cluster.metadata-change-log</td>
<td align="center">on</td>
<td align="left">Metadata fops like setattr/setxattr will not perform pre/post fop changelog operations in afr transaction if this option is disabled</td>
</tr>
<tr>
<td align="left">cluster.data-self-heal-algorithm</td>
<td align="center">null</td>
<td align="left">Select between “full”, “diff”. The “full” algorithm copies the entire file from source to sink. The “diff” algorithm copies to sink only those blocks whose checksums don’t match with those of source. If no option is configured the option is chosen dynamically as follows: If the file does not exist on one of the sinks or empty file exists or if the source file size is about the same as page size the entire file will be read and written i.e “full” algo, otherwise “diff” algo is chosen.</td>
</tr>
<tr>
<td align="left">cluster.eager-lock</td>
<td align="center">on</td>
<td align="left">Lock phase of a transaction has two sub-phases. First is an attempt to acquire locks in parallel by broadcasting non-blocking lock requests. If lock acquisition fails on any server, then the held locks are unlocked and revert to a blocking locked mode sequentially on one server after another. If this option is enabled the initial broadcasting lock request attempt to acquire lock on the entire file. If this fails, we revert back to the sequential “regional” blocking lock as before. In the case where such an “eager” lock is granted in the non-blocking phase, it gives rise to an opportunity for optimization. i.e, if the next write transaction on the same FD arrives before the unlock phase of the first transaction, it “takes over” the full file lock. Similarly if yet another data transaction arrives before the unlock phase of the “optimized” transaction, that in turn “takes over” the lock as well. The actual unlock now happens at the end of the last “optimized” transaction.</td>
</tr>
<tr>
<td align="left">cluster.quorum-type</td>
<td align="center">none</td>
<td align="left">If value is “fixed” only allow writes if quorum-count bricks are present. If value is “auto” only allow writes if more than half of bricks, or exactly half including the first, are present.</td>
</tr>
<tr>
<td align="left">cluster.quorum-count</td>
<td align="center">null</td>
<td align="left">If quorum-type is “fixed” only allow writes if this many bricks or present. Other quorum types will OVERWRITE this value.</td>
</tr>
<tr>
<td align="left">cluster.choose-local</td>
<td align="center">true</td>
<td align="left">Choose a local subvolume (i.e. Brick) to read from if read-subvolume is not explicitly set.</td>
</tr>
<tr>
<td align="left">cluster.self-heal-readdir-size</td>
<td align="center">1KB</td>
<td align="left">readdirp size for performing entry self-heal</td>
</tr>
<tr>
<td align="left">cluster.ensure-durability</td>
<td align="center">on</td>
<td align="left">Afr performs fsyncs for transactions if this option is on to make sure the changelogs/data is written to the disk</td>
</tr>
<tr>
<td align="left">cluster.consistent-metadata</td>
<td align="center">no</td>
<td align="left">If this option is enabled, readdirp will force lookups on those entries read whose read child is not the same as that of the parent. This will guarantee that all read operations on a file serve attributes from the same subvol as long as it holds a good copy of the file/dir.</td>
</tr>
<tr>
<td align="left">cluster.stripe-block-size</td>
<td align="center">128KB</td>
<td align="left">Size of the stripe unit that would be read from or written to the striped servers.</td>
</tr>
<tr>
<td align="left">cluster.stripe-coalesce</td>
<td align="center">true</td>
<td align="left">Enable/Disable coalesce mode to flatten striped files as stored on the server (i.e., eliminate holes caused by the traditional format).</td>
</tr>
<tr>
<td align="left">cluster.server-quorum-type</td>
<td align="center">(null)</td>
<td align="left">This feature is on the server-side i.e. in glusterd. Whenever the glusterd on a machine observes that the quorum is not met, it brings down the bricks to prevent data split-brains. When the network connections are brought back up and the quorum is restored the bricks in the volume are brought back up.</td>
</tr>
<tr>
<td align="left">cluster.server-quorum-ratio</td>
<td align="center">(null)</td>
<td align="left">Sets the quorum percentage for the trusted storage pool.</td>
</tr>
<tr>
<td align="left">cluster.quorum-reads</td>
<td align="center">no</td>
<td align="left">If quorum-reads is “true” only allow reads if quorum is met when quorum is enabled.</td>
</tr>
<tr>
<td align="left">diagnostics.latency-measurement</td>
<td align="center">off</td>
<td align="left">If on stats related to the latency of each operation would be tracked inside GlusterFS data-structures.</td>
</tr>
<tr>
<td align="left">diagnostics.dump-fd-stats</td>
<td align="center">off</td>
<td align="left">If on stats related to file-operations would be tracked inside GlusterFS data-structures.</td>
</tr>
<tr>
<td align="left">diagnostics.brick-log-level</td>
<td align="center">INFO</td>
<td align="left">Changes the log-level of the bricks</td>
</tr>
<tr>
<td align="left">diagnostics.client-log-level</td>
<td align="center">INFO</td>
<td align="left">Changes the log-level of the clients</td>
</tr>
<tr>
<td align="left">diagnostics.brick-sys-log-level</td>
<td align="center">CRITICAL</td>
<td align="left">Gluster’s syslog log-level</td>
</tr>
<tr>
<td align="left">diagnostics.client-sys-log-level</td>
<td align="center">CRITICAL</td>
<td align="left">Gluster’s syslog log-level</td>
</tr>
<tr>
<td align="left">diagnostics.brick-logger</td>
<td align="center">null</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">diagnostics.client-logger</td>
<td align="center">null</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">diagnostics.brick-log-format</td>
<td align="center">null</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">diagnostics.client-log-format</td>
<td align="center">null</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">diagnostics.brick-log-buf-size</td>
<td align="center">5</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">diagnostics.client-log-buf-size</td>
<td align="center">5</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">diagnostics.brick-log-flush-timeout</td>
<td align="center">20</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">diagnostics.client-log-flush-timeout</td>
<td align="center">20</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">disperse.background-heals</td>
<td align="center">8</td>
<td align="left">This option can be used to control number of parallel heals</td>
</tr>
<tr>
<td align="left">disperse.heal-wait-qlength</td>
<td align="center">128</td>
<td align="left">This option can be used to control number of heals that can wait</td>
</tr>
<tr>
<td align="left">disperse.read-policy</td>
<td align="center">round-robin</td>
<td align="left">inode-read fops happen only on ‘k’ number of bricks in n=k+m disperse subvolume. ‘round-robin’ selects the read subvolume using round-robin algo. ‘gfid-hash’ selects read subvolume based on hash of the gfid of that file/directory.</td>
</tr>
<tr>
<td align="left">dht.force-readdirp</td>
<td align="center">on</td>
<td align="left">This option if set to ON, forces the use of readdirp, and hence also displays the stats of the files.</td>
</tr>
<tr>
<td align="left">performance.cache-max-file-size</td>
<td align="center">0</td>
<td align="left">Maximum file size which would be cached by the io-cache translator.</td>
</tr>
<tr>
<td align="left">performance.cache-min-file-size</td>
<td align="center">0</td>
<td align="left">Minimum file size which would be cached by the io-cache translator.</td>
</tr>
<tr>
<td align="left">performance.cache-refresh-timeout</td>
<td align="center">1</td>
<td align="left">The cached data for a file will be retained till ‘cache-refresh-timeout’ seconds, after which data re-validation is performed.</td>
</tr>
<tr>
<td align="left">performance.cache-priority</td>
<td align="center"></td>
<td align="left">Assigns priority to filenames with specific patterns so that when a page needs to be ejected out of the cache, the page of a file whose priority is the lowest will be ejected earlier</td>
</tr>
<tr>
<td align="left">performance.cache-size</td>
<td align="center">32MB</td>
<td align="left">Size of the read cache.</td>
</tr>
<tr>
<td align="left">performance.io-thread-count</td>
<td align="center">16</td>
<td align="left">Number of threads in IO threads translator which perform concurrent IO operations</td>
</tr>
<tr>
<td align="left">performance.high-prio-threads</td>
<td align="center">16</td>
<td align="left">Max number of threads in IO threads translator which perform high priority IO operations at a given time</td>
</tr>
<tr>
<td align="left">performance.normal-prio-threads</td>
<td align="center">16</td>
<td align="left">Max number of threads in IO threads translator which perform normal priority IO operations at a given time</td>
</tr>
<tr>
<td align="left">performance.low-prio-threads</td>
<td align="center">16</td>
<td align="left">Max number of threads in IO threads translator which perform low priority IO operations at a given time</td>
</tr>
<tr>
<td align="left">performance.least-prio-threads</td>
<td align="center">1</td>
<td align="left">Max number of threads in IO threads translator which perform least priority IO operations at a given time</td>
</tr>
<tr>
<td align="left">performance.enable-least-priority</td>
<td align="center">on</td>
<td align="left">Enable/Disable least priority</td>
</tr>
<tr>
<td align="left">performance.least-rate-limit</td>
<td align="center">0</td>
<td align="left">Max number of least priority operations to handle per-second</td>
</tr>
<tr>
<td align="left">performance.flush-behind</td>
<td align="center">on</td>
<td align="left">If this option is set ON, instructs write-behind translator to perform flush in background, by returning success (or any errors, if any of previous writes were failed) to application even before flush FOP is sent to backend filesystem.</td>
</tr>
<tr>
<td align="left">performance.nfs.flush-behind</td>
<td align="center">on</td>
<td align="left">If this option is set ON, instructs write-behind translator to perform flush in background, by returning success (or any errors, if any of previous writes were failed) to application even before flush FOP is sent to backend filesystem.</td>
</tr>
<tr>
<td align="left">performance.write-behind-window-size</td>
<td align="center">1MB</td>
<td align="left">Size of the write-behind buffer for a single file (inode).</td>
</tr>
<tr>
<td align="left">performance.nfs.write-behind-window-size</td>
<td align="center">1MB</td>
<td align="left">Size of the write-behind buffer for a single file (inode).</td>
</tr>
<tr>
<td align="left">performance.strict-o-direct</td>
<td align="center">off</td>
<td align="left">This option when set to off, ignores the O_DIRECT flag.</td>
</tr>
<tr>
<td align="left">performance.nfs.strict-o-direct</td>
<td align="center">off</td>
<td align="left">This option when set to off, ignores the O_DIRECT flag.</td>
</tr>
<tr>
<td align="left">performance.strict-write-ordering</td>
<td align="center">off</td>
<td align="left">Do not let later writes overtake earlier writes even if they do not overlap</td>
</tr>
<tr>
<td align="left">performance.nfs.strict-write-ordering</td>
<td align="center">off</td>
<td align="left">Do not let later writes overtake earlier writes even if they do not overlap</td>
</tr>
<tr>
<td align="left">performance.lazy-open</td>
<td align="center">yes</td>
<td align="left">Perform open in the backend only when a necessary FOP arrives (e.g writev on the FD, unlink of the file). When option is disabled, perform backend open right after unwinding open().</td>
</tr>
<tr>
<td align="left">performance.read-after-open</td>
<td align="center">no</td>
<td align="left">read is sent only after actual open happens and real fd is obtained, instead of doing on anonymous fd (similar to write)</td>
</tr>
<tr>
<td align="left">performance.read-ahead-page-count</td>
<td align="center">4</td>
<td align="left">Number of pages that will be pre-fetched</td>
</tr>
<tr>
<td align="left">performance.md-cache-timeout</td>
<td align="center">1</td>
<td align="left">Time period after which cache has to be refreshed</td>
</tr>
<tr>
<td align="left">performance.write-behind</td>
<td align="center">on</td>
<td align="left">enable/disable write-behind translator in the volume.</td>
</tr>
<tr>
<td align="left">performance.read-ahead</td>
<td align="center">on</td>
<td align="left">enable/disable read-ahead translator in the volume.</td>
</tr>
<tr>
<td align="left">performance.readdir-ahead</td>
<td align="center">off</td>
<td align="left">enable/disable readdir-ahead translator in the volume.</td>
</tr>
<tr>
<td align="left">performance.io-cache</td>
<td align="center">on</td>
<td align="left">enable/disable io-cache translator in the volume.</td>
</tr>
<tr>
<td align="left">performance.quick-read</td>
<td align="center">on</td>
<td align="left">enable/disable quick-read translator in the volume.</td>
</tr>
<tr>
<td align="left">performance.open-behind</td>
<td align="center">on</td>
<td align="left">enable/disable open-behind translator in the volume.</td>
</tr>
<tr>
<td align="left">performance.stat-prefetch</td>
<td align="center">on</td>
<td align="left">enable/disable meta-data caching translator in the volume.</td>
</tr>
<tr>
<td align="left">performance.client-io-threads</td>
<td align="center">off</td>
<td align="left">enable/disable io-threads translator in the client graph of volume.</td>
</tr>
<tr>
<td align="left">performance.nfs.write-behind</td>
<td align="center">on</td>
<td align="left">enable/disable write-behind translator in the volume</td>
</tr>
<tr>
<td align="left">performance.force-readdirp</td>
<td align="center">true</td>
<td align="left">Convert all readdir requests to readdirplus to collect stat info on each entry.</td>
</tr>
<tr>
<td align="left">features.encryption</td>
<td align="center">off</td>
<td align="left">enable/disable client-side encryption for the volume.</td>
</tr>
<tr>
<td align="left">encryption.master-key</td>
<td align="center">null</td>
<td align="left">Pathname of regular file which contains master volume key</td>
</tr>
<tr>
<td align="left">encryption.data-key-size</td>
<td align="center">256</td>
<td align="left">Data key size (bits)</td>
</tr>
<tr>
<td align="left">encryption.block-size</td>
<td align="center">4096</td>
<td align="left">Atom size (bits)</td>
</tr>
<tr>
<td align="left">nfs.enable-ino32</td>
<td align="center">no</td>
<td align="left">For nfs clients or apps that do not support 64-bit inode numbers, use this option to make NFS return 32-bit inode numbers instead. Disabled by default, so NFS returns 64-bit inode numbers.</td>
</tr>
<tr>
<td align="left">nfs.mem-factor</td>
<td align="center">15</td>
<td align="left">Use this option to make NFS be faster on systems by using more memory. This option specifies a multiple that determines the total amount of memory used. Default value is 15. Increase to use more memory in order to improve performance for certain use cases.Please consult gluster-users list before using this option.</td>
</tr>
<tr>
<td align="left">nfs.export-dirs</td>
<td align="center">on</td>
<td align="left">By default, all subvolumes of nfs are exported as individual exports. There are cases where a subdirectory or subdirectories in the volume need to be exported separately. Enabling this option allows any directory on a volumes to be exported separately.Directory exports are enabled by default.</td>
</tr>
<tr>
<td align="left">nfs.export-volumes</td>
<td align="center">on</td>
<td align="left">Enable or disable exporting whole volumes, instead if used in conjunction with nfs3.export-dir, can allow setting up only subdirectories as exports. On by default.</td>
</tr>
<tr>
<td align="left">nfs.addr-namelookup</td>
<td align="center">off</td>
<td align="left">Users have the option of turning on name lookup for incoming client connections using this option. Use this option to turn on name lookups during address-based authentication. Turning this on will enable you to use hostnames in nfs.rpc-auth-* filters. In some setups, the name server can take too long to reply to DNS queries resulting in timeouts of mount requests. By default, name lookup is off</td>
</tr>
<tr>
<td align="left">nfs.dynamic-volumes</td>
<td align="center">off</td>
<td align="left">Internal option set to tell gnfs to use a different scheme for encoding file handles when DVM is being used.</td>
</tr>
<tr>
<td align="left">nfs.register-with-portmap</td>
<td align="center">on</td>
<td align="left">For systems that need to run multiple nfs servers, only one registration is possible with portmap service. Use this option to turn off portmap registration for Gluster NFS. On by default</td>
</tr>
<tr>
<td align="left">nfs.outstanding-rpc-limit</td>
<td align="center">16</td>
<td align="left">Parameter to throttle the number of incoming RPC requests from a client. 0 means no limit (can potentially run out of memory)</td>
</tr>
<tr>
<td align="left">nfs.port</td>
<td align="center">2049</td>
<td align="left">Use this option on systems that need Gluster NFS to be associated with a non-default port number.</td>
</tr>
<tr>
<td align="left">nfs.rpc-auth-unix</td>
<td align="center">on</td>
<td align="left">Disable or enable the AUTH_UNIX authentication type for a particular exported volume overriding defaults and general setting for AUTH_UNIX scheme. Must always be enabled for better interoperability. However, can be disabled if needed. Enabled by default.</td>
</tr>
<tr>
<td align="left">nfs.rpc-auth-null</td>
<td align="center">on</td>
<td align="left">Disable or enable the AUTH_NULL authentication type for a particular exported volume overriding defaults and general setting for AUTH_NULL. Must always be enabled. This option is here only to avoid unrecognized option warnings.</td>
</tr>
<tr>
<td align="left">nfs.rpc-auth-allow</td>
<td align="center">all</td>
<td align="left">Allow a comma separated list of addresses and/or hostnames to connect to the server. By default, all connections are allowed. This allows users to define a rule for a specific exported volume.</td>
</tr>
<tr>
<td align="left">nfs.rpc-auth-reject</td>
<td align="center">none</td>
<td align="left">Reject a comma separated list of addresses and/or hostnames from connecting to the server. By default, all connections are allowed. This allows users to define a rule for a specific exported volume.</td>
</tr>
<tr>
<td align="left">nfs.ports-insecure</td>
<td align="center">off</td>
<td align="left">Allow client connections from unprivileged ports. By default only privileged ports are allowed. Use this option to enable or disable insecure ports for a specific subvolume and to override the global setting set by the previous option.</td>
</tr>
<tr>
<td align="left">nfs.transport-type</td>
<td align="center">(null)</td>
<td align="left">Specifies the nfs transport type. Valid transport types are ‘tcp’ and ‘rdma’.</td>
</tr>
<tr>
<td align="left">nfs.trusted-sync</td>
<td align="center">off</td>
<td align="left">All writes and COMMIT requests are treated as async. This implies that no write requests are guaranteed to be on server disks when the write reply is received at the NFS client. Trusted sync includes trusted-write behaviour. Off by default.</td>
</tr>
<tr>
<td align="left">nfs.trusted-write</td>
<td align="center">off</td>
<td align="left">On an UNSTABLE write from client, return STABLE flag to force client to not send a COMMIT request. In some environments, combined with a replicated GlusterFS setup, this option can improve write performance. This flag allows user to trust Gluster replication logic to sync data to the disks and recover when required. COMMIT requests if received will be handled in a default manner by fsyncing. STABLE writes are still handled in a sync manner. Off by default.</td>
</tr>
<tr>
<td align="left">nfs.volume-access</td>
<td align="center">read-write</td>
<td align="left">Type of access desired for this subvolume: read-only, read-write(default)</td>
</tr>
<tr>
<td align="left">nfs.export-dir</td>
<td align="center"></td>
<td align="left">By default, all subvolumes of nfs are exported as individual exports. There are cases where a subdirectory or subdirectories in the volume need to be exported separately. This option can also be used in conjunction with nfs3.export-volumes option to restrict exports only to the subdirectories specified through this option. Must be an absolute path. Along with path allowed list of IPs/hostname can be associated with each subdirectory. If provided connection will allowed only from these IPs. By default connections from all IPs are allowed. Format:[(hostspec[|hostspec|…])][,…]. Where hostspec can be an IP address, hostname or an IP range in CIDR notation. e.g. /foo(192.168.1.0/24|host1|10.1.1.8),/host2. NOTE: Care must be taken while configuring this option as invalid entries and/or unreachable DNS servers can introduce unwanted delay in all the mount calls.</td>
</tr>
<tr>
<td align="left">nfs.disable</td>
<td align="center">false</td>
<td align="left">This option is used to start or stop the NFS server for individual volumes.</td>
</tr>
<tr>
<td align="left">nfs.nlm</td>
<td align="center">on</td>
<td align="left">This option, if set to ‘off’, disables NLM server by not registering the service with the portmapper. Set it to ‘on’ to re-enable it. Default value: ‘on’</td>
</tr>
<tr>
<td align="left">nfs.acl</td>
<td align="center">on</td>
<td align="left">This option is used to control ACL support for NFS.</td>
</tr>
<tr>
<td align="left">nfs.mount-udp</td>
<td align="center">off</td>
<td align="left">set the option to ‘on’ to enable mountd on UDP. Required for some Solaris and AIX NFS clients. The need for enabling this option often depends on the usage of NLM.</td>
</tr>
<tr>
<td align="left">nfs.mount-rmtab</td>
<td align="center">/var/lib/glusterd/nfs/rmtab</td>
<td align="left">Set the location of the cache file that is used to list all the NFS-clients that have connected through the MOUNT protocol. If this is on shared storage, all GlusterFS servers will update and output (with ‘showmount’) the same list. Set to “/-“ to disable.</td>
</tr>
<tr>
<td align="left">nfs.drc</td>
<td align="center">off</td>
<td align="left">Enable Duplicate Request Cache in gNFS server to improve correctness of non-idempotent operations like write, delete, link, et al</td>
</tr>
<tr>
<td align="left">nfs.drc-size</td>
<td align="center">0x20000</td>
<td align="left">Sets the number of non-idempotent requests to cache in drc</td>
</tr>
<tr>
<td align="left">nfs.read-size</td>
<td align="center">(1 * 1048576ULL)</td>
<td align="left">Size in which the client should issue read requests to the Gluster NFSv3 server. Must be a multiple of 4KB (4096). Min and Max supported values are 4KB (4096) and 1MB (1048576) respectively. If the specified value is within the supported range but not a multiple of 4096, it is rounded up to the nearest multiple of 4096.</td>
</tr>
<tr>
<td align="left">nfs.write-size</td>
<td align="center">(1 * 1048576ULL)</td>
<td align="left">Size in which the client should issue write requests to the Gluster NFSv3 server. Must be a multiple of 1KB (1024). Min and Max supported values are 4KB (4096) and 1MB(1048576) respectively. If the specified value is within the supported range but not a multiple of 4096, it is rounded up to the nearest multiple of 4096.</td>
</tr>
<tr>
<td align="left">nfs.readdir-size</td>
<td align="center">(1 * 1048576ULL)</td>
<td align="left">Size in which the client should issue directory reading requests to the Gluster NFSv3 server. Must be a multiple of 1KB (1024). Min and Max supported values are 4KB (4096) and 1MB (1048576) respectively.If the specified value is within the supported range but not a multiple of 4096, it is rounded up to the nearest multiple of 4096.</td>
</tr>
<tr>
<td align="left">nfs.exports-auth-enable</td>
<td align="center">(null)</td>
<td align="left">Set the option to ‘on’ to enable exports/netgroup authentication in the NFS server and mount daemon.</td>
</tr>
<tr>
<td align="left">nfs.auth-refresh-interval-sec</td>
<td align="center">(null)</td>
<td align="left">Frequency in seconds that the daemon should check for changes in the exports/netgroups file.</td>
</tr>
<tr>
<td align="left">nfs.auth-cache-ttl-sec</td>
<td align="center">(null)</td>
<td align="left">Sets the TTL of an entry in the auth cache. Value is in seconds.</td>
</tr>
<tr>
<td align="left">ganesha.enable</td>
<td align="center">off</td>
<td align="left">export volume via NFS-Ganesha</td>
</tr>
<tr>
<td align="left">network.frame-timeout</td>
<td align="center">1800</td>
<td align="left">Time frame after which the (file) operation would be declared as dead, if the server does not respond for a particular (file) operation.</td>
</tr>
<tr>
<td align="left">network.ping-timeout</td>
<td align="center">42</td>
<td align="left">Time duration for which the client waits to check if the server is responsive.</td>
</tr>
<tr>
<td align="left">network.tcp-window-size</td>
<td align="center">null</td>
<td align="left">Specifies the window size for tcp socket.</td>
</tr>
<tr>
<td align="left">network.remote-dio</td>
<td align="center">disable</td>
<td align="left">If enabled, in open() and creat() calls, O_DIRECT flag will be filtered at the client protocol level so server will still continue to cache the file. This works similar to NFS’s behavior of O_DIRECT</td>
</tr>
<tr>
<td align="left">network.inode-lru-limit</td>
<td align="center">16384</td>
<td align="left">Specifies the maximum megabytes of memory to be used in the inode cache.</td>
</tr>
<tr>
<td align="left">network.compression</td>
<td align="center">off</td>
<td align="left">enable/disable network compression translator</td>
</tr>
<tr>
<td align="left">network.compression.window-size</td>
<td align="center">-15</td>
<td align="left">Size of the zlib history buffer.</td>
</tr>
<tr>
<td align="left">network.compression.mem-level</td>
<td align="center">8</td>
<td align="left">Memory allocated for internal compression state. 1 uses minimum memory but is slow and reduces compression ratio; memLevel=9 uses maximum memory for optimal speed. The default value is 8.</td>
</tr>
<tr>
<td align="left">network.compression.min-size</td>
<td align="center">0</td>
<td align="left">Data is compressed only when its size exceeds this.</td>
</tr>
<tr>
<td align="left">network.compression.compression-level</td>
<td align="center">-1</td>
<td align="left">Compression levels 0 : no compression, 1 : best speed, 9 : best compression, -1 : default compression</td>
</tr>
<tr>
<td align="left">features.lock-heal</td>
<td align="center">off</td>
<td align="left">When the connection to client is lost, server cleans up all the locks held by the client. After the connection is restored, the client reacquires (heals) the fcntl locks released by the server.</td>
</tr>
<tr>
<td align="left">features.grace-timeout</td>
<td align="center">10</td>
<td align="left">Specifies the duration for the lock state to be maintained on the client after a network disconnection. Range 10-1800 seconds.</td>
</tr>
<tr>
<td align="left">features.file-snapshot</td>
<td align="center">off</td>
<td align="left">enable/disable file-snapshot feature in the volume.</td>
</tr>
<tr>
<td align="left">features.uss</td>
<td align="center">off</td>
<td align="left">enable/disable User Serviceable Snapshots on the volume.</td>
</tr>
<tr>
<td align="left">features.snapshot-directory</td>
<td align="center">.snaps</td>
<td align="left">Entry point directory for entering snapshot world</td>
</tr>
<tr>
<td align="left">features.show-snapshot-directory</td>
<td align="center">off</td>
<td align="left">show entry point in readdir output of snapdir-entry-path which is set by samba</td>
</tr>
<tr>
<td align="left">features.quota-deem-statfs</td>
<td align="center">off</td>
<td align="left">If set to on, it takes quota limits intoconsideration while estimating fs size. (df command) (Default is off).</td>
</tr>
<tr>
<td align="left">features.read-only</td>
<td align="center">off</td>
<td align="left">When “on”, makes a volume read-only. It is turned “off” by default.</td>
</tr>
<tr>
<td align="left">features.worm</td>
<td align="center">off</td>
<td align="left">When “on”, makes a volume get write once read many feature. It is turned “off” by default.</td>
</tr>
<tr>
<td align="left">features.barrier-timeout</td>
<td align="center">120</td>
<td align="left">After ‘timeout’ seconds since the time ‘barrier’ option was set to “on”, acknowledgements to file operations are no longer blocked and previously blocked acknowledgements are sent to the application</td>
</tr>
<tr>
<td align="left">features.trash</td>
<td align="center">off</td>
<td align="left">Enable/disable trash translator</td>
</tr>
<tr>
<td align="left">features.trash-dir</td>
<td align="center">.trashcan</td>
<td align="left">Directory for trash files</td>
</tr>
<tr>
<td align="left">features.trash-eliminate-path</td>
<td align="center">(null)</td>
<td align="left">Eliminate paths to be excluded from trashing</td>
</tr>
<tr>
<td align="left">features.trash-max-filesize</td>
<td align="center">5MB</td>
<td align="left">Maximum size of file that can be moved to trash</td>
</tr>
<tr>
<td align="left">features.trash-internal-op</td>
<td align="center">off</td>
<td align="left">Enable/disable trash translator for internal operations</td>
</tr>
<tr>
<td align="left">features.ctr-enabled</td>
<td align="center">off</td>
<td align="left">Enable CTR xlator</td>
</tr>
<tr>
<td align="left">features.record-counters</td>
<td align="center">off</td>
<td align="left">Its a Change Time Recorder Xlator option to enable recording write and read heat counters. The default is disabled. If enabled, “cluster.write-freq-threshold” and “cluster.read-freq-threshold” defined the number of writes (or reads) to a given file are needed before triggering migration.</td>
</tr>
<tr>
<td align="left">features.ctr-sql-db-cachesize</td>
<td align="center">1000</td>
<td align="left">Defines the cache size of the sqlite database of changetimerecorder xlator.The input to this option is in pages.Each page is 4096 bytes. Default value is 1000 pages i.e ~ 4 MB. The max value is 262144 pages i.e 1 GB and the min value is 1000 pages i.e ~ 4 MB.</td>
</tr>
<tr>
<td align="left">features.ctr-sql-db-wal-autocheckpoint</td>
<td align="center">1000</td>
<td align="left">Defines the autocheckpoint of the sqlite database of changetimerecorder. The input to this option is in pages. Each page is 4096 bytes. Default value is 1000 pages i.e ~ 4 MB.The max value is 262144 pages i.e 1 GB and the min value is 1000 pages i.e ~4 MB.</td>
</tr>
<tr>
<td align="left">features.shard-block-size</td>
<td align="center">4MB</td>
<td align="left">The size unit used to break a file into multiple chunks</td>
</tr>
<tr>
<td align="left">features.cache-invalidation</td>
<td align="center">off</td>
<td align="left">When “on”, sends cache-invalidation notifications.</td>
</tr>
<tr>
<td align="left">features.cache-invalidation-timeout</td>
<td align="center">60</td>
<td align="left">After ‘timeout’ seconds since the time client accessed any file, cache-invalidation notifications are no longer sent to that client.</td>
</tr>
<tr>
<td align="left">client.event-threads</td>
<td align="center">2</td>
<td align="left">Specifies the number of event threads to execute in parallel. Larger values would help process responses faster, depending on available processing power. Range 1-32 threads.</td>
</tr>
<tr>
<td align="left">auth.allow</td>
<td align="center">null</td>
<td align="left">Allow a comma separated list of addresses and/or hostnames to connect to the server. Option auth.reject overrides this option. By default, all connections are allowed.</td>
</tr>
<tr>
<td align="left">auth.reject</td>
<td align="center">null</td>
<td align="left">Reject a comma separated list of addresses and/or hostnames to connect to the server. This option overrides the auth.allow option. By default, all connections are allowed.</td>
</tr>
<tr>
<td align="left">server.root-squash</td>
<td align="center">off</td>
<td align="left">Map requests from uid/gid 0 to the anonymous uid/gid. Note that this does not apply to any other uids or gids that might be equally sensitive, such as user bin or group staff.</td>
</tr>
<tr>
<td align="left">server.anonuid</td>
<td align="center">65534</td>
<td align="left">value of the uid used for the anonymous user/nfsnobody when root-squash is enabled.</td>
</tr>
<tr>
<td align="left">server.anongid</td>
<td align="center">65534</td>
<td align="left">value of the gid used for the anonymous user/nfsnobody when root-squash is enabled.</td>
</tr>
<tr>
<td align="left">server.statedump-path</td>
<td align="center">/var/run/gluster</td>
<td align="left">Specifies directory in which gluster should save its statedumps.</td>
</tr>
<tr>
<td align="left">server.outstanding-rpc-limit</td>
<td align="center">64</td>
<td align="left">Parameter to throttle the number of incoming RPC requests from a client. 0 means no limit (can potentially run out of memory)</td>
</tr>
<tr>
<td align="left">server.manage-gids</td>
<td align="center">off</td>
<td align="left">Resolve groups on the server-side.</td>
</tr>
<tr>
<td align="left">server.dynamic-auth</td>
<td align="center">on</td>
<td align="left">When ‘on’ perform dynamic authentication of volume options in order to allow/terminate client transport connection immediately in response to *.allow | *.reject volume set options.</td>
</tr>
<tr>
<td align="left">server.gid-timeout</td>
<td align="center">300</td>
<td align="left">Timeout in seconds for the cached groups to expire.</td>
</tr>
<tr>
<td align="left">server.event-threads</td>
<td align="center">2</td>
<td align="left">Specifies the number of event threads to execute in parallel. Larger values would help process responses faster, depending on available processing power. Range 1-32 threads.</td>
</tr>
<tr>
<td align="left">ssl.own-cert</td>
<td align="center">null</td>
<td align="left">SSL certificate. Ignored if SSL is not enabled.</td>
</tr>
<tr>
<td align="left">ssl.private-key</td>
<td align="center">null</td>
<td align="left">SSL private key. Ignored if SSL is not enabled.</td>
</tr>
<tr>
<td align="left">ssl.ca-list</td>
<td align="center">null</td>
<td align="left">SSL CA list. Ignored if SSL is not enabled.</td>
</tr>
<tr>
<td align="left">ssl.crl-path</td>
<td align="center">null</td>
<td align="left">Path to directory containing CRL. Ignored if SSL is not enabled.</td>
</tr>
<tr>
<td align="left">ssl.certificate-depth</td>
<td align="center">null</td>
<td align="left">Maximum certificate-chain depth. If zero, the peer’s certificate itself must be in the local certificate list. Otherwise, there may be up to N signing certificates between the peer’s and the local list. Ignored if SSL is not enabled.</td>
</tr>
<tr>
<td align="left">ssl.cipher-list</td>
<td align="center">null</td>
<td align="left">Allowed SSL ciphers. Ignored if SSL is not enabled.</td>
</tr>
<tr>
<td align="left">ssl.dh-param</td>
<td align="center">null</td>
<td align="left">DH parameters file. Ignored if SSL is not enabled.</td>
</tr>
<tr>
<td align="left">ssl.ec-curve</td>
<td align="center">null</td>
<td align="left">ECDH curve name. Ignored if SSL is not enabled.</td>
</tr>
<tr>
<td align="left">storage.linux-aio</td>
<td align="center">off</td>
<td align="left">Support for native Linux AIO</td>
</tr>
<tr>
<td align="left">storage.batch-fsync-mode</td>
<td align="center">reverse-fsync</td>
<td align="left">Possible values: syncfs: Perform one syncfs() on behalf oa batchof fsyncs. syncfs-single-fsync: Perform one syncfs() on behalf of a batch of fsyncs and one fsync() per batch. syncfs-reverse-fsync: Preform one syncfs() on behalf of a batch of fsyncs and fsync() each file in the batch in reverse order. reverse-fsync: Perform fsync() of each file in the batch in reverse order.</td>
</tr>
<tr>
<td align="left">storage.batch-fsync-delay-usec</td>
<td align="center">0</td>
<td align="left">Num of usecs to wait for aggregating fsync requests</td>
</tr>
<tr>
<td align="left">storage.owner-uid</td>
<td align="center">-1</td>
<td align="left">Support for setting uid of brick’s owner</td>
</tr>
<tr>
<td align="left">storage.owner-gid</td>
<td align="center">-1</td>
<td align="left">Support for setting gid of brick’s owner</td>
</tr>
<tr>
<td align="left">storage.node-uuid-pathinfo</td>
<td align="center">off</td>
<td align="left">return glusterd’s node-uuid in pathinfo xattr string instead of hostname</td>
</tr>
<tr>
<td align="left">storage.health-check-interval</td>
<td align="center">30</td>
<td align="left">Interval in seconds for a filesystem health check, set to 0 to disable</td>
</tr>
<tr>
<td align="left">storage.build-pgfid</td>
<td align="center">off</td>
<td align="left">Enable placeholders for gfid to path conversion</td>
</tr>
<tr>
<td align="left">storage.bd-aio</td>
<td align="center">off</td>
<td align="left">Support for native Linux AIO</td>
</tr>
</tbody></table>
<h2 id="基本GlusterFS的优化样例"><a href="#基本GlusterFS的优化样例" class="headerlink" title="基本GlusterFS的优化样例"></a>基本GlusterFS的优化样例</h2><table>
<thead>
<tr>
<th align="left">选项</th>
<th align="center">配置</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">cluster.server-quorum-type</td>
<td align="center">server</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">cluster.quorum-type</td>
<td align="center">auto</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">network.remote-dio</td>
<td align="center">enable</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">cluster.eager-lock</td>
<td align="center">enable</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">performance.stat-prefetch</td>
<td align="center">off</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">performance.io-cache</td>
<td align="center">off</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">performance.read-ahead</td>
<td align="center">off</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">performance.quick-read</td>
<td align="center">off</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">performance.readdir-ahead</td>
<td align="center"></td>
<td align="left"></td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/Redis%E5%A4%8D%E5%88%B6%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/Redis%E5%A4%8D%E5%88%B6%E8%BF%87%E7%A8%8B/" class="post-title-link" itemprop="url">Redis复制过程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-16 17:51:11 / Modified: 17:56:29" itemprop="dateCreated datePublished" datetime="2020-04-16T17:51:11+08:00">2020-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="how-redis-do-replication"><a href="#how-redis-do-replication" class="headerlink" title="how redis do replication"></a>how redis do replication</h3><p><img src="/2020/04/16/Redis%E5%A4%8D%E5%88%B6%E8%BF%87%E7%A8%8B/2582954-c87cc2da4707fecf.jpg" alt></p>
<ul>
<li>step 1:add callback for server cron job</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;location:server.c</span><br><span class="line">&#x2F;&#x2F;fucntion:setting callback for timeout</span><br><span class="line">if (aeCreateTimeEvent(server.el, 1, serverCron, NULL, NULL) &#x3D;&#x3D; AE_ERR) &#123;</span><br><span class="line">      serverPanic(&quot;Can&#39;t create event loop timers.&quot;);</span><br><span class="line">      exit(1);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>step 2:call replication for each 1000 seconds</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;location:server.c</span><br><span class="line">&#x2F;&#x2F;function:serverCron,crontab for redis-server</span><br><span class="line">run_with_period(1000) replicationCron();</span><br></pre></td></tr></table></figure>
<ul>
<li><p>step 3:core replication cron job</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;location:replication.c</span><br><span class="line">&#x2F;&#x2F;function: response for redis replication </span><br><span class="line">&#x2F;* Replication cron function, called 1 time per second. *&#x2F;</span><br><span class="line">void replicationCron(void) &#123;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">     &#x2F;* Check if we should connect to a MASTER *&#x2F;</span><br><span class="line">    if (server.repl_state &#x3D;&#x3D; REPL_STATE_CONNECT) &#123;</span><br><span class="line">        if (connectWithMaster() &#x3D;&#x3D; C_OK) &#123;</span><br><span class="line">            serverLog(LL_NOTICE,&quot;MASTER &lt;-&gt; REPLICA sync started&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;；</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int connectWithMaster(void) &#123;</span><br><span class="line">    int fd;</span><br><span class="line">    fd &#x3D; anetTcpNonBlockBestEffortBindConnect(NULL,</span><br><span class="line">        server.masterhost,server.masterport,NET_FIRST_BIND_ADDR);</span><br><span class="line">    &#x2F;&#x2F; fd of master socket </span><br><span class="line">    aeCreateFileEvent(server.el,fd,AE_READABLE|AE_WRITABLE,syncWithMaster,NULL)；</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void syncWithMaster(aeEventLoop *el, int fd, void *privdata, int mask) &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;* Send a PING to check the master is able to reply without errors. *&#x2F;</span><br><span class="line">    sendSynchronousCommand(SYNC_CMD_WRITE,fd,&quot;PING&quot;,NULL);</span><br><span class="line">    </span><br><span class="line">    &#x2F;* Receive the PONG command. *&#x2F;</span><br><span class="line">    sendSynchronousCommand(SYNC_CMD_READ,fd,NULL);</span><br><span class="line"></span><br><span class="line">    &#x2F;* AUTH with the master if required. *&#x2F;</span><br><span class="line">    sendSynchronousCommand(SYNC_CMD_WRITE,fd,&quot;AUTH&quot;,server.masterauth,NULL);</span><br><span class="line">          </span><br><span class="line"></span><br><span class="line">    &#x2F;* Receive AUTH reply. *&#x2F;</span><br><span class="line">    sendSynchronousCommand(SYNC_CMD_READ,fd,NULL);</span><br><span class="line">    </span><br><span class="line">    &#x2F;* Set the slave port, so that Master&#39;s INFO command can list the</span><br><span class="line">     * slave listening port correctly. *&#x2F;</span><br><span class="line">     sendSynchronousCommand(SYNC_CMD_WRITE,fd,&quot;REPLCONF&quot;,</span><br><span class="line">                &quot;listening-port&quot;,port, NULL);</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    &#x2F;* Receive REPLCONF listening-port reply. *&#x2F;</span><br><span class="line">    sendSynchronousCommand(SYNC_CMD_READ,fd,NULL);</span><br><span class="line"></span><br><span class="line">    &#x2F;* Set the slave ip, so that Master&#39;s INFO command can list the</span><br><span class="line">     * slave IP address port correctly in case of port forwarding or NAT. *&#x2F;</span><br><span class="line">     sendSynchronousCommand(SYNC_CMD_WRITE,fd,&quot;REPLCONF&quot;,</span><br><span class="line">                &quot;ip-address&quot;,server.slave_announce_ip, NULL);</span><br><span class="line"></span><br><span class="line">    &#x2F;* Receive REPLCONF ip-address reply. *&#x2F;</span><br><span class="line">    sendSynchronousCommand(SYNC_CMD_READ,fd,NULL);</span><br><span class="line">      </span><br><span class="line">    &#x2F;* Inform the master of our (slave) capabilities.</span><br><span class="line">     *</span><br><span class="line">     * EOF: supports EOF-style RDB transfer for diskless replication.</span><br><span class="line">     * PSYNC2: supports PSYNC v2, so understands +CONTINUE &lt;new repl ID&gt;.</span><br><span class="line">     *</span><br><span class="line">     * The master will ignore capabilities it does not understand. *&#x2F;</span><br><span class="line">     sendSynchronousCommand(SYNC_CMD_WRITE,fd,&quot;REPLCONF&quot;,</span><br><span class="line">                &quot;capa&quot;,&quot;eof&quot;,&quot;capa&quot;,&quot;psync2&quot;,NULL);</span><br><span class="line">     </span><br><span class="line">    </span><br><span class="line">     </span><br><span class="line">    &#x2F;* Receive CAPA reply. *&#x2F;</span><br><span class="line">    sendSynchronousCommand(SYNC_CMD_READ,fd,NULL)；</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">    &#x2F;* Try a partial resynchonization. If we don&#39;t have a cached master</span><br><span class="line">     * slaveTryPartialResynchronization() will at least try to use PSYNC</span><br><span class="line">     * to start a full resynchronization so that we get the master run id</span><br><span class="line">     * and the global offset, to try a partial resync at the next</span><br><span class="line">     * reconnection attempt. *&#x2F;</span><br><span class="line">    slaveTryPartialResynchronization(fd,0) &#123;</span><br><span class="line">     &#x2F;* If we reached this point, we are able to perform a partial resync:</span><br><span class="line">     </span><br><span class="line">          &#x2F;* Issue the PSYNC command *&#x2F;</span><br><span class="line">        reply &#x3D; sendSynchronousCommand(SYNC_CMD_WRITE,fd,&quot;PSYNC&quot;,psync_replid,psync_offset,NULL)</span><br><span class="line">        &#123;</span><br><span class="line">         &#x2F;* command of up,will call syncCommand of master node</span><br><span class="line">          &#x2F;* SYNC and PSYNC command implemenation. *&#x2F;</span><br><span class="line">          </span><br><span class="line">          &#x2F;&#x2F; PSYNC command will call syncCommand function</span><br><span class="line">          void syncCommand(client *c) &#123;</span><br><span class="line">            masterTryPartialResynchronization(c) &#123;</span><br><span class="line">                &#x2F;&#x2F; write master replid to slave</span><br><span class="line">                </span><br><span class="line">                if (c-&gt;slave_capa &amp; SLAVE_CAPA_PSYNC2) &#123;</span><br><span class="line">                    buflen &#x3D; snprintf(buf,sizeof(buf),&quot;+CONTINUE %s\r\n&quot;, server.replid);</span><br><span class="line">                 &#125; else &#123;</span><br><span class="line">                    buflen &#x3D; snprintf(buf,sizeof(buf),&quot;+CONTINUE\r\n&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                if (write(c-&gt;fd,buf,buflen) !&#x3D; buflen) &#123;</span><br><span class="line">                freeClientAsync(c);</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">           * 1) Set client state to make it a slave.</span><br><span class="line">           * 2) Inform the client we can continue with +CONTINUE</span><br><span class="line">          * 3) Send the backlog data (from the offset to the end) to the slave. *&#x2F;</span><br><span class="line">          c-&gt;flags |&#x3D; CLIENT_SLAVE;</span><br><span class="line">          c-&gt;replstate &#x3D; SLAVE_STATE_ONLINE;</span><br><span class="line">          c-&gt;repl_ack_time &#x3D; server.unixtime;</span><br><span class="line">          c-&gt;repl_put_online_on_ack &#x3D; 0;</span><br><span class="line">          listAddNodeTail(server.slaves,c);</span><br><span class="line">          startBgsaveForReplication(c-&gt;slave_capa) &#123;</span><br><span class="line">               &#x2F;&#x2F; proto</span><br><span class="line">               &#x2F;&#x2F;int startBgsaveForReplication(int mincapa) </span><br><span class="line">                int retval;</span><br><span class="line">                </span><br><span class="line">                &#x2F;&#x2F;socket_target init according slave_capa_eof</span><br><span class="line">                int socket_target &#x3D; server.repl_diskless_sync &amp;&amp; (mincapa &amp; SLAVE_CAPA_EOF);</span><br><span class="line">                rdbSaveInfo rsi, *rsiptr;</span><br><span class="line">                rsiptr &#x3D; rdbPopulateSaveInfo(&amp;rsi);</span><br><span class="line">                </span><br><span class="line">                if (rsiptr) &#123;</span><br><span class="line">                  if (socket_target)</span><br><span class="line">                      &#x2F;&#x2F; mark rio with end flag,and send to slave</span><br><span class="line">                      rdbSaveToSlavesSockets(rsiptr)&#123;</span><br><span class="line">                         if(fork()&#x3D;&#x3D;0)&#123;</span><br><span class="line">                              CHILD_INFO_TYPE_RDB</span><br><span class="line">                         &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                  else</span><br><span class="line">                      &#x2F;&#x2F; 1. bgsave current rdb.dump with background</span><br><span class="line">                      rdbSaveBackground(server.rdb_filename,rsiptr)&#123;</span><br><span class="line">                         if((childpid&#x3D;fork())&#x3D;&#x3D;0)&#123;</span><br><span class="line">                            &#x2F;&#x2F; redis server main process will wait util save all database in disk for finish</span><br><span class="line">                            rdbSave(rdb_filename);</span><br><span class="line">                            &#x2F;&#x2F; write CHILD_INFO_TYPE_RDB to parent process by pipe</span><br><span class="line">                            sendChildInfo(CHILD_INFO_TYPE_RDB）</span><br><span class="line">                         &#125;else&#123;</span><br><span class="line">                            server.rdb_child_pid &#x3D; childpid;</span><br><span class="line">                            server.rdb_child_type &#x3D; RDB_CHILD_TYPE_DISK;</span><br><span class="line">                         &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 copyClientOutputBuffer(c,slave);</span><br><span class="line">                 if(!socket_target) &#123;</span><br><span class="line">                     &#x2F;&#x2F; 2.write replid and offset to slave</span><br><span class="line">                     replicationSetupSlaveForFullResync(c,slave-&gt;psync_initial_offset)</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        reply &#x3D; sendSynchronousCommand(SYNC_CMD_READ,fd,NULL);</span><br><span class="line">         &#x2F;* We are going to full resync, discard the cached master structure. *&#x2F;</span><br><span class="line">        replicationDiscardCachedMaster();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    psync_result &#x3D; slaveTryPartialResynchronization(fd,1);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    &#x2F;* PSYNC failed or is not supported: we want our slaves to resync with us</span><br><span class="line">     * as well, if we have any sub-slaves. The master may transfer us an</span><br><span class="line">     * entirely different data set and we have no way to incrementally feed</span><br><span class="line">     * our slaves after that. *&#x2F;</span><br><span class="line">    disconnectSlaves(); &#x2F;* Force our slaves to resync with us as well. *&#x2F;</span><br><span class="line">    freeReplicationBacklog(); &#x2F;* Don&#39;t allow our chained slaves to PSYNC. *&#x2F;</span><br><span class="line"></span><br><span class="line">    &#x2F;* Fall back to SYNC if needed. Otherwise psync_result &#x3D;&#x3D; PSYNC_FULLRESYNC</span><br><span class="line">     * and the server.master_replid and master_initial_offset are</span><br><span class="line">     * already populated.  sync state,waited*&#x2F;</span><br><span class="line">     syncWrite(fd,&quot;SYNC\r\n&quot;,6,server.repl_syncio_timeout*1000) &#x3D;&#x3D; -1);</span><br><span class="line"></span><br><span class="line">    &#x2F;* Prepare a suitable temp file for bulk transfer *&#x2F;</span><br><span class="line">    while(maxtries--) &#123;</span><br><span class="line">        snprintf(tmpfile,256,</span><br><span class="line">            &quot;temp-%d.%ld.rdb&quot;,(int)server.unixtime,(long int)getpid());</span><br><span class="line">        dfd &#x3D; open(tmpfile,O_CREAT|O_WRONLY|O_EXCL,0644);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">    &#x2F;* Setup the non blocking download of the bulk file. *&#x2F;</span><br><span class="line">    aeCreateFileEvent(server.el,fd, AE_READABLE,readSyncBulkPayload,NULL);</span><br><span class="line"></span><br><span class="line">    server.repl_state &#x3D; REPL_STATE_TRANSFER;</span><br><span class="line">    server.repl_transfer_size &#x3D; -1;</span><br><span class="line">    server.repl_transfer_read &#x3D; 0;</span><br><span class="line">    server.repl_transfer_last_fsync_off &#x3D; 0;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; current node as slave,open temp-rdb.dump file and get fd for this file</span><br><span class="line">    server.repl_transfer_fd &#x3D; dfd;</span><br><span class="line">    server.repl_transfer_lastio &#x3D; server.unixtime;</span><br><span class="line">    server.repl_transfer_tmpfile &#x3D; zstrdup(tmpfile);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void readSyncBulkPayload(aeEventLoop *el, int fd, void *privdata, int mask) &#123;</span><br><span class="line">    char buf[4096];</span><br><span class="line">    ssize_t nread, readlen, nwritten;</span><br><span class="line"></span><br><span class="line">    &#x2F;* If repl_transfer_size &#x3D;&#x3D; -1 we still have to read the bulk length</span><br><span class="line">     * from the master reply. *&#x2F;</span><br><span class="line">      syncReadLine(fd,buf,1024,server.repl_syncio_timeout*1000) &#x3D;&#x3D; -1) &#123;</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">    &#x2F;* Read bulk data *&#x2F;</span><br><span class="line">    if (usemark) &#123;</span><br><span class="line">        readlen &#x3D; sizeof(buf);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        left &#x3D; server.repl_transfer_size - server.repl_transfer_read;</span><br><span class="line">        readlen &#x3D; (left &lt; (signed)sizeof(buf)) ? left : (signed)sizeof(buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; read  rdb.dump from master</span><br><span class="line">    nread &#x3D; read(fd,buf,readlen);</span><br><span class="line">    if (nread &lt;&#x3D; 0) &#123;</span><br><span class="line">        cancelReplicationHandshake();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">       &#x2F;&#x2F; write to current temp-rdb.dump file</span><br><span class="line">       nwritten &#x3D; write(server.repl_transfer_fd,buf,nread)) </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">        rename(server.repl_transfer_tmpfile,server.rdb_filename) ;</span><br><span class="line">     </span><br><span class="line">        &#x2F;* We need to stop any AOFRW fork before flusing and parsing</span><br><span class="line">         * RDB, otherwise we&#39;ll create a copy-on-write disaster. *&#x2F;</span><br><span class="line">        if(aof_is_enabled) stopAppendOnly();</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;mark client as dirty,that will be remove</span><br><span class="line">        signalFlushedDb(-1);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; clean all  data for current node</span><br><span class="line">        emptyDb(-1,server.repl_slave_lazy_flush ? EMPTYDB_ASYNC : EMPTYDB_NO_FLAGS,replicationEmptyDbCallback)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; proto long long emptyDb(int dbnum, int flags, void(callback)(void*)) </span><br><span class="line">            int async &#x3D; (flags &amp; EMPTYDB_ASYNC);</span><br><span class="line">            long long removed &#x3D; 0;</span><br><span class="line">            int startdb &#x3D; 0;</span><br><span class="line">            int enddb &#x3D; server.dbnum-1;</span><br><span class="line"></span><br><span class="line">           for (int j &#x3D; startdb; j &lt;&#x3D; enddb; j++) &#123;</span><br><span class="line">              removed +&#x3D; dictSize(server.db[j].dict);</span><br><span class="line">              &#x2F;&#x2F;async instand for as backgroup job to flush data in database</span><br><span class="line">              if (async) &#123;</span><br><span class="line">                &#x2F;&#x2F; that will create new dict after async,old dict mark to clean</span><br><span class="line">                emptyDbAsync(&amp;server.db[j]);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F;blocking for flush all data in database</span><br><span class="line">                dictEmpty(server.db[j].dict,callback);</span><br><span class="line">                dictEmpty(server.db[j].expires,callback);</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">      </span><br><span class="line">        &#x2F;* Before loading the DB into memory we need to delete the readable</span><br><span class="line">         * handler, otherwise it will get called recursively since</span><br><span class="line">         * rdbLoad() will call the event loop to process events from time to</span><br><span class="line">         * time for non blocking loading. *&#x2F;</span><br><span class="line">        aeDeleteFileEvent(server.el,server.repl_transfer_s,AE_READABLE);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;init slave info</span><br><span class="line">        rdbSaveInfo rsi &#x3D; RDB_SAVE_INFO_INIT;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;load data from rdb_file </span><br><span class="line">        rdbLoad(server.rdb_filename,&amp;rsi);</span><br><span class="line">        </span><br><span class="line">     </span><br><span class="line">       &#x2F;&#x2F; create master client for slave,that will got master socket and other info</span><br><span class="line">       &#x2F;&#x2F;   incude replid of master,server.replid</span><br><span class="line">        replicationCreateMasterClient(server.repl_transfer_s,rsi.repl_stream_db);</span><br><span class="line">        server.repl_state &#x3D; REPL_STATE_CONNECTED;</span><br><span class="line">       </span><br><span class="line">       &#x2F;&#x2F; clean old replid,that included in server.replid2</span><br><span class="line">        clearReplicationId2();</span><br><span class="line">        </span><br><span class="line">        &#x2F;* Let&#39;s create the replication backlog if needed. Slaves need to</span><br><span class="line">         * accumulate the backlog regardless of the fact they have sub-slaves</span><br><span class="line">         * or not, in order to behave correctly if they are promoted to</span><br><span class="line">         * masters after a failover. *&#x2F;</span><br><span class="line">        if (server.repl_backlog &#x3D;&#x3D; NULL) createReplicationBacklog();</span><br><span class="line"></span><br><span class="line">     </span><br><span class="line">        &#x2F;* Restart the AOF subsystem now that we finished the sync. This</span><br><span class="line">         * will trigger an AOF rewrite, and when done will start appending</span><br><span class="line">         * to the new file. *&#x2F;</span><br><span class="line">        if (aof_is_enabled) restartAOF();</span><br><span class="line">    &#125;</span><br><span class="line">    return;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> * On success the fuction returns the number of keys removed from the</span><br><span class="line"> * database(s). Otherwise -1 is returned in the specific case the</span><br><span class="line"> * DB number is out of range, and errno is set to EINVAL. *&#x2F;</span><br><span class="line">long long emptyDb(int dbnum, int flags, void(callback)(void*)) &#123;</span><br><span class="line">    int async &#x3D; (flags &amp; EMPTYDB_ASYNC);</span><br><span class="line">    long long removed &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    if (dbnum &lt; -1 || dbnum &gt;&#x3D; server.dbnum) &#123;</span><br><span class="line">        errno &#x3D; EINVAL;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int startdb, enddb;</span><br><span class="line">    if (dbnum &#x3D;&#x3D; -1) &#123;</span><br><span class="line">        startdb &#x3D; 0;</span><br><span class="line">        enddb &#x3D; server.dbnum-1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        startdb &#x3D; enddb &#x3D; dbnum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (int j &#x3D; startdb; j &lt;&#x3D; enddb; j++) &#123;</span><br><span class="line">        removed +&#x3D; dictSize(server.db[j].dict);</span><br><span class="line">        if (async) &#123;</span><br><span class="line">            emptyDbAsync(&amp;server.db[j]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            dictEmpty(server.db[j].dict,callback);</span><br><span class="line">            dictEmpty(server.db[j].expires,callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (server.cluster_enabled) &#123;</span><br><span class="line">        if (async) &#123;</span><br><span class="line">            slotToKeyFlushAsync();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            slotToKeyFlush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (dbnum &#x3D;&#x3D; -1) flushSlaveKeysWithExpireList();</span><br><span class="line">    return removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>step4 wait for child process</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;</span><br><span class="line">int serverCron(struct aeEventLoop *eventLoop, long long id, void *clientData) </span><br><span class="line">&#123;</span><br><span class="line">    int statloc</span><br><span class="line">  if ((pid &#x3D; wait3(&amp;statloc,WNOHANG,NULL)) !&#x3D; 0) &#123;</span><br><span class="line">            int exitcode &#x3D; WEXITSTATUS(statloc);</span><br><span class="line">            int bysignal &#x3D; 0;</span><br><span class="line"></span><br><span class="line">            if (WIFSIGNALED(statloc)) bysignal &#x3D; WTERMSIG(statloc);</span><br><span class="line"></span><br><span class="line">            if (pid &#x3D;&#x3D; -1) &#123;</span><br><span class="line">                &#x2F;&#x2F; error output</span><br><span class="line">            &#125; else if (pid &#x3D;&#x3D; server.rdb_child_pid) &#123;</span><br><span class="line">                &#x2F;&#x2F;each do bgsave ,server will store child pid </span><br><span class="line">                backgroundSaveDoneHandler(exitcode,bysignal)</span><br><span class="line">                &#123;</span><br><span class="line">                     switch(server.rdb_child_type) &#123;</span><br><span class="line">                        case RDB_CHILD_TYPE_DISK:</span><br><span class="line">                            backgroundSaveDoneHandlerDisk(exitcode,bysignal)</span><br><span class="line">                            &#123;</span><br><span class="line">                                updateSlavesWaitingBgsave((!bysignal &amp;&amp; exitcode &#x3D;&#x3D; 0) ? C_OK : C_ERR, RDB_CHILD_TYPE_DISK)&#123;</span><br><span class="line">                                   if (slave-&gt;replstate &#x3D;&#x3D; SLAVE_STATE_WAIT_BGSAVE_START) &#123;</span><br><span class="line">                                      &#x2F;&#x2F;</span><br><span class="line">                                   &#125; else if (slave-&gt;replstate &#x3D;&#x3D; SLAVE_STATE_WAIT_BGSAVE_END) &#123;</span><br><span class="line">                                      if (type &#x3D;&#x3D; RDB_CHILD_TYPE_SOCKET) &#123;</span><br><span class="line">                                      &#x2F;&#x2F; update slave info</span><br><span class="line">                                         slave-&gt;replstate &#x3D; SLAVE_STATE_ONLINE;</span><br><span class="line">                                          slave-&gt;repl_put_online_on_ack &#x3D; 1;</span><br><span class="line">                                          slave-&gt;repl_ack_time &#x3D; server.unixtime; &#x2F;* Timeout otherwise. *</span><br><span class="line">                                      &#125;else&#123;</span><br><span class="line">                                           listRewind(server.slaves,&amp;li);</span><br><span class="line">                                           while((ln &#x3D; listNext(&amp;li))) &#123;</span><br><span class="line">                                              client *slave &#x3D; ln-&gt;value;</span><br><span class="line">                                             &#x2F;&#x2F;sendBulkToSlave:send maser rdb.dump to every slave</span><br><span class="line">                                             aeCreateFileEvent(server.el, slave-&gt;fd, AE_WRITABLE, sendBulkToSlave, slave);</span><br><span class="line">                                      &#125;</span><br><span class="line">                                  &#125;</span><br><span class="line">                            break;</span><br><span class="line">                        case RDB_CHILD_TYPE_SOCKET:</span><br><span class="line">                            backgroundSaveDoneHandlerSocket(exitcode,bysignal)</span><br><span class="line">                            &#123;</span><br><span class="line">                               server.rdb_child_type &#x3D; RDB_CHILD_TYPE_NONE;</span><br><span class="line">                               updateSlavesWaitingBgsave((!bysignal &amp;&amp; exitcode &#x3D;&#x3D; 0) ? C_OK : C_ERR, RDB_CHILD_TYPE_SOCKET);</span><br><span class="line">                            &#125;</span><br><span class="line">                            break;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#x2F;&#x2F;read child data from parent,and check data</span><br><span class="line">                if (!bysignal &amp;&amp; exitcode &#x3D;&#x3D; 0) receiveChildInfo();</span><br><span class="line">            &#125; else if (pid &#x3D;&#x3D; server.aof_child_pid) &#123;</span><br><span class="line">                backgroundRewriteDoneHandler(exitcode,bysignal);</span><br><span class="line">                </span><br><span class="line">                &#x2F;&#x2F;read child data from parent,and check data</span><br><span class="line">                if (!bysignal &amp;&amp; exitcode &#x3D;&#x3D; 0) receiveChildInfo();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (!ldbRemoveChild(pid)) &#123;</span><br><span class="line">                    serverLog(LL_WARNING,</span><br><span class="line">                        &quot;Warning, detected child with unmatched pid: %ld&quot;,</span><br><span class="line">                        (long)pid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/Linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8dup%E5%92%8Cdup2%E5%8C%BA%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/Linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8dup%E5%92%8Cdup2%E5%8C%BA%E5%88%AB/" class="post-title-link" itemprop="url">Linux系统调用dup和dup2区别</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-16 17:44:18 / Modified: 17:45:46" itemprop="dateCreated datePublished" datetime="2020-04-16T17:44:18+08:00">2020-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="dup"><a href="#dup" class="headerlink" title="dup"></a>dup</h2><ul>
<li>函数原型是 int dup(old_fd),把old_fd下标中的内容拷贝到当前进程文件描述符表中最小的可用位置下标空间中，open系统调用会默认返回当前进程描述符表中最小的下标作为文件描述符.dup系统调用不是原子的<h2 id="dup2"><a href="#dup2" class="headerlink" title="dup2"></a>dup2</h2></li>
<li>函数原型是 int dup2(new_fd,old_fd),这个操作是原子的。如果old_fd已经存在就close(old_fd),然后调用dup(new_fd),把new_fd中内容拷贝到当前进程文件描述符表中最小的下标空间中。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#define FILE_NAME &quot;&#x2F;tmp&#x2F;out&quot;</span><br><span class="line">static void redirect_stdout_without_dup() &#123;</span><br><span class="line">  fprintf(stdout, &quot;pid&#x3D;%d\n&quot;, getpid());</span><br><span class="line">  const char *str &#x3D; &quot;my dup\n&quot;;</span><br><span class="line">  &#x2F;&#x2F;关闭 stdout</span><br><span class="line">  close(1);</span><br><span class="line">  &#x2F;&#x2F;当前process中描述符表中最小可用的下标是1，因为刚刚关闭</span><br><span class="line">  int fd &#x3D; open(FILE_NAME, O_RDWR | O_CREAT | O_TRUNC, 0666);</span><br><span class="line">  if (fd &gt; 0) &#123;</span><br><span class="line">    &#x2F;&#x2F; stdout 在每个进程描述表中的下标为1</span><br><span class="line">    &#x2F;&#x2F;此时，数据是写到了刚刚打开的fd中，新打开的fd返回的是1</span><br><span class="line">    fprintf(stdout, &quot; open fd&#x3D;%d\n&quot;, fd);</span><br><span class="line">    &#x2F;&#x2F; write 操作也是写到fd&#x3D;1中，当前进程中文件描述符为1的并不是标准输出</span><br><span class="line">    write(fd, str, strlen(str));</span><br><span class="line">    close(1);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void redirect_stdout_with_dup() &#123;</span><br><span class="line">  fprintf(stdout, &quot;pid&#x3D;%d\n&quot;, getpid());</span><br><span class="line">  const char *str &#x3D; &quot;my dup&quot;;</span><br><span class="line">  &#x2F;&#x2F;默认打开fd，在当前进程描述表中fd并不是&#123;0，1，2&#125;</span><br><span class="line">  int fd &#x3D; open(FILE_NAME, O_RDWR | O_CREAT | O_TRUNC, 0666);</span><br><span class="line">  if (fd &gt; 0) &#123;</span><br><span class="line">    &#x2F;&#x2F;关闭标准的输出的文件描述符</span><br><span class="line">    close(1);</span><br><span class="line">    &#x2F;&#x2F;拷贝fd到当前进程描述符中最小的下标位置，当前最小的下标应该是刚刚关闭的1</span><br><span class="line">    dup(fd);</span><br><span class="line">    &#x2F;&#x2F; fprintf的内容写入到了fd中，并没有写入到标准输出中</span><br><span class="line">    fprintf(stdout, &quot; open fd&#x3D;%d\n&quot;, fd);</span><br><span class="line">    write(fd, str, strlen(str));</span><br><span class="line">    &#x2F;&#x2F;关闭当前文件描述符</span><br><span class="line">    close(fd);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">static void redirect_stdout_with_dup2() &#123;</span><br><span class="line">  fprintf(stdout, &quot;pid&#x3D;%d\n&quot;, getpid());</span><br><span class="line">  const char *str &#x3D; &quot;i&#39;m dup2\n&quot;;</span><br><span class="line">  &#x2F;&#x2F;打开一个新的文件描述符</span><br><span class="line">  int fd &#x3D; open(FILE_NAME, O_RDWR | O_CREAT | O_TRUNC, 0666);</span><br><span class="line">  if (fd &gt; 0) &#123;</span><br><span class="line">    &#x2F;&#x2F;如果1号文件描述符是打开状态，就关闭1号文件描述符</span><br><span class="line">    &#x2F;&#x2F;把当前进程中文件描述符表中下标为fd的指针拷贝下标为1的空间</span><br><span class="line">    &#x2F;&#x2F;如果fd&#x3D;&#x3D;1就直接返回fd</span><br><span class="line">    dup2(fd, 1); &#x2F;&#x2F; equals: close(1) and dup(fd)</span><br><span class="line">    &#x2F;&#x2F; fd和1号文件描述符指向相同的文件结构体指针</span><br><span class="line">    fprintf(stdout, &quot;%d already redirect to stdout\n&quot;, fd);</span><br><span class="line">    write(fd, str, strlen(str));</span><br><span class="line">    &#x2F;&#x2F;刷盘操作</span><br><span class="line">    if (fd !&#x3D; 1) &#123;</span><br><span class="line">      close(fd);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">int main(void) &#123;</span><br><span class="line">  &#x2F;*</span><br><span class="line">redirect_stdout_without_dup();</span><br><span class="line">redirect_stdout_with_dup();</span><br><span class="line">*&#x2F;</span><br><span class="line">  redirect_stdout_with_dup2();</span><br><span class="line">  for (;;) &#123;</span><br><span class="line">    sleep(1);</span><br><span class="line">  &#125;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2020/04/16/Linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8dup%E5%92%8Cdup2%E5%8C%BA%E5%88%AB/2582954-114c3951ba781a8b.png" alt></li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ul>
<li>从上图的信息来看，标准输出1 被重定向到/tmp/out.lsof可以看出当前进程文件描述符表中打开的文件描述符。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">perrynzhou</p>
  <div class="site-description" itemprop="description">涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">perrynzhou</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
