<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https:&#x2F;&#x2F;github.com&#x2F;perrynzhou。">
<meta property="og:type" content="website">
<meta property="og:title" content="perrynzhou">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="perrynzhou">
<meta property="og:description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https:&#x2F;&#x2F;github.com&#x2F;perrynzhou。">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="perrynzhou">
<meta property="article:tag" content="C">
<meta property="article:tag" content=" Go">
<meta property="article:tag" content=" 分布式存储">
<meta property="article:tag" content=" 对象存储">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>perrynzhou</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">perrynzhou</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一个专注存储技术的疯子,https://github.com/perrynzhou</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/30/Linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E8%B0%83%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/30/Linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E8%B0%83%E7%94%A8/" class="post-title-link" itemprop="url">Linux系统调调用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-30 18:43:03 / Modified: 18:46:31" itemprop="dateCreated datePublished" datetime="2020-05-30T18:43:03+08:00">2020-05-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h4><p>![](系统调用.png =800x800)</p>
<h4 id="系统调用例子"><a href="#系统调用例子" class="headerlink" title="系统调用例子"></a>系统调用例子</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;time.h&gt;</span><br><span class="line">int main(void) &#123;</span><br><span class="line">    time_t tt;</span><br><span class="line">    struct tm *t;</span><br><span class="line">    &#x2F;&#x2F;time系统调用非常方便</span><br><span class="line">    tt &#x3D; time(NULL);</span><br><span class="line">    &#x2F;&#x2F;内嵌汇编替换time系统调用</span><br><span class="line">       asm volatile (</span><br><span class="line">        &#x2F;&#x2F;清空ebx寄存器</span><br><span class="line">        &quot;mov $0,%%ebx\n\t&quot;</span><br><span class="line">        &#x2F;&#x2F;系统调用一般是通过eax保存系统调用号，time在32位系统中调用号为13，因此传递13到eax寄存器</span><br><span class="line">        &quot;mov $0xd,%%eax\n\t&quot;</span><br><span class="line">        &#x2F;&#x2F;调用int 0x80指令，陷入内核态，进行系统调用</span><br><span class="line">        &quot;int $0x80\n\t&quot;</span><br><span class="line">        &#x2F;&#x2F;把结果eax寄存器结果保存在变量tt中</span><br><span class="line">        &quot;mov %%eax,%0\n\t&quot;</span><br><span class="line">        : &quot;&#x3D;m&quot; (tt)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    t &#x3D; localtime(&amp;tt);</span><br><span class="line">    fprintf(stdout,&quot;%s&quot;,asctime(t));</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/27/glusterfs-client%E5%AE%A2%E6%88%B6%E7%AB%AF%E5%87%BA%E7%8E%B0RPC-CLNT-DISCONNECT%E9%97%AE%E9%A2%98%E5%92%8Ckernel%E5%87%BA%E7%8E%B0task-xxx-blocked-for-more-than-120-second/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/27/glusterfs-client%E5%AE%A2%E6%88%B6%E7%AB%AF%E5%87%BA%E7%8E%B0RPC-CLNT-DISCONNECT%E9%97%AE%E9%A2%98%E5%92%8Ckernel%E5%87%BA%E7%8E%B0task-xxx-blocked-for-more-than-120-second/" class="post-title-link" itemprop="url">glusterfs client客戶端出现RPC_CLNT_DISCONNECT问题和kernel出现task xxx blocked for more than 120 seconds</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-27 17:26:20 / Modified: 17:32:50" itemprop="dateCreated datePublished" datetime="2020-05-27T17:26:20+08:00">2020-05-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h4><ul>
<li>glusterfs客户端无法连接某个节点的brick，一直出现rpc无法连接</li>
<li>kernel 出现hung_task_timeout_secs超时问题</li>
</ul>
<h4 id="故障分析"><a href="#故障分析" class="headerlink" title="故障分析"></a>故障分析</h4><p>   <strong>kernel层面分析</strong><br>   kernel出现sync flood，原因是客户端断掉后不断重新尝试导致，后面CallTrace出现 hung_task_timeout_secs关键字，该关键字含义是，异步刷新IO到磁盘，如果在hung_task_timeout_secs时间内IO没有刷完，就会报出这个错误，解决方法需要调整vm.dirty_ratio和vm.dirty_backgroud_ratio参数，两个参数分别控制脏页刷磁盘的比例，如果后端磁盘非常慢，超过操作系统默认的timeout会出现这样的calltrace.建议设置vm.dirty_ratio=5和vm.dirty_backgroud_ratio=5</p>
<p>  <strong>客户端日志分析</strong><br>    日志中大量报出0-speech_vol_v2-client-55对应的brick无法建立rpc连接(通过网络telnet 主机和端口无异常),从日志来看可能是sync flood导致，客户端无法连接到这个glusterfsd</p>
<p>  <strong>服务端日志</strong><br>    服务端的日志也很明显出现read/write出现告警</p>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><ul>
<li>调整kernel中 vm.dirty_ratio=5和 vm.dirty_backgroud_ratio=10（该问题仅仅关闭kernel报错)</li>
<li>重启节点的glusterd的进程或者重启节点(sync flood的问题)</li>
</ul>
<h4 id="glusterfs-version"><a href="#glusterfs-version" class="headerlink" title="glusterfs version"></a>glusterfs version</h4><ul>
<li>服务端版本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ai-storage-prd-141-165-65-141.v-bj-4.vivo.lan:&#x2F;root]</span><br><span class="line"># gluster --version</span><br><span class="line">glusterfs 7.2</span><br></pre></td></tr></table></figure>
<ul>
<li>客户端版本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@storage-center-prd-10-194-8-133.v-bj-4.vivo.lan:&#x2F;var&#x2F;log&#x2F;glusterfs]</span><br><span class="line"># rpm -qa|grep gluster</span><br><span class="line">glusterfs-7.2-1.el7.x86_64</span><br><span class="line">glusterfs-fuse-7.2-1.el7.x86_64</span><br><span class="line">glusterfs-libs-7.2-1.el7.x86_64</span><br></pre></td></tr></table></figure>

<h4 id="cluster-volume"><a href="#cluster-volume" class="headerlink" title="cluster volume"></a>cluster volume</h4><ul>
<li><p>volume info</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume info  speech_vol_v2     </span><br><span class="line"> </span><br><span class="line">Volume Name: speech_vol_v2</span><br><span class="line">Type: Distributed-Replicate</span><br><span class="line">Volume ID: e1b28e82-0d0b-4c87-bb6a-45306ec4a568</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 24 x 3 &#x3D; 72</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: 141.165.65.141:&#x2F;data1&#x2F;brick</span><br><span class="line">Brick2: 141.165.65.142:&#x2F;data1&#x2F;brick</span><br><span class="line">Brick3: 141.165.65.144:&#x2F;data1&#x2F;brick</span><br><span class="line">Brick4: 141.165.65.141:&#x2F;data2&#x2F;brick</span><br><span class="line">Brick5: 141.165.65.142:&#x2F;data2&#x2F;brick</span><br><span class="line">Brick6: 141.165.65.144:&#x2F;data2&#x2F;brick</span><br><span class="line">Brick7: 141.165.65.141:&#x2F;data3&#x2F;brick</span><br><span class="line">Brick8: 141.165.65.142:&#x2F;data3&#x2F;brick</span><br><span class="line">Brick9: 141.165.65.144:&#x2F;data3&#x2F;brick</span><br><span class="line">Brick10: 141.165.65.141:&#x2F;data4&#x2F;brick</span><br><span class="line">Brick11: 141.165.65.142:&#x2F;data4&#x2F;brick</span><br><span class="line">Brick12: 141.165.65.144:&#x2F;data4&#x2F;brick</span><br><span class="line">Brick13: 141.165.65.141:&#x2F;data5&#x2F;brick</span><br><span class="line">Brick14: 141.165.65.142:&#x2F;data5&#x2F;brick</span><br><span class="line">Brick15: 141.165.65.144:&#x2F;data5&#x2F;brick</span><br><span class="line">Brick16: 141.165.65.141:&#x2F;data6&#x2F;brick</span><br><span class="line">Brick17: 141.165.65.142:&#x2F;data6&#x2F;brick</span><br><span class="line">Brick18: 141.165.65.144:&#x2F;data6&#x2F;brick</span><br><span class="line">Brick19: 141.165.65.141:&#x2F;data7&#x2F;brick</span><br><span class="line">Brick20: 141.165.65.142:&#x2F;data7&#x2F;brick</span><br><span class="line">Brick21: 141.165.65.144:&#x2F;data7&#x2F;brick</span><br><span class="line">Brick22: 141.165.65.141:&#x2F;data8&#x2F;brick</span><br><span class="line">Brick23: 141.165.65.142:&#x2F;data8&#x2F;brick</span><br><span class="line">Brick24: 141.165.65.144:&#x2F;data8&#x2F;brick</span><br><span class="line">Brick25: 141.165.65.141:&#x2F;data9&#x2F;brick</span><br><span class="line">Brick26: 141.165.65.142:&#x2F;data9&#x2F;brick</span><br><span class="line">Brick27: 141.165.65.144:&#x2F;data9&#x2F;brick</span><br><span class="line">Brick28: 141.165.65.141:&#x2F;data10&#x2F;brick</span><br><span class="line">Brick29: 141.165.65.142:&#x2F;data10&#x2F;brick</span><br><span class="line">Brick30: 141.165.65.144:&#x2F;data10&#x2F;brick</span><br><span class="line">Brick31: 141.165.65.141:&#x2F;data11&#x2F;brick</span><br><span class="line">Brick32: 141.165.65.142:&#x2F;data11&#x2F;brick</span><br><span class="line">Brick33: 141.165.65.144:&#x2F;data11&#x2F;brick</span><br><span class="line">Brick34: 141.165.65.141:&#x2F;data12&#x2F;brick</span><br><span class="line">Brick35: 141.165.65.142:&#x2F;data12&#x2F;brick</span><br><span class="line">Brick36: 141.165.65.144:&#x2F;data12&#x2F;brick</span><br><span class="line">Brick37: 141.165.181.146:&#x2F;data1&#x2F;brick</span><br><span class="line">Brick38: 141.165.181.147:&#x2F;data1&#x2F;brick</span><br><span class="line">Brick39: 141.165.181.148:&#x2F;data1&#x2F;brick</span><br><span class="line">Brick40: 141.165.181.146:&#x2F;data2&#x2F;brick</span><br><span class="line">Brick41: 141.165.181.147:&#x2F;data2&#x2F;brick</span><br><span class="line">Brick42: 141.165.181.148:&#x2F;data2&#x2F;brick</span><br><span class="line">Brick43: 141.165.181.146:&#x2F;data3&#x2F;brick</span><br><span class="line">Brick44: 141.165.181.147:&#x2F;data3&#x2F;brick</span><br><span class="line">Brick45: 141.165.181.148:&#x2F;data3&#x2F;brick</span><br><span class="line">Brick46: 141.165.181.146:&#x2F;data4&#x2F;brick</span><br><span class="line">Brick47: 141.165.181.147:&#x2F;data4&#x2F;brick</span><br><span class="line">Brick48: 141.165.181.148:&#x2F;data4&#x2F;brick</span><br><span class="line">Brick49: 141.165.181.146:&#x2F;data5&#x2F;brick</span><br><span class="line">Brick50: 141.165.181.147:&#x2F;data5&#x2F;brick</span><br><span class="line">Brick51: 141.165.181.148:&#x2F;data5&#x2F;brick</span><br><span class="line">Brick52: 141.165.181.146:&#x2F;data6&#x2F;brick</span><br><span class="line">Brick53: 141.165.181.147:&#x2F;data6&#x2F;brick</span><br><span class="line">Brick54: 141.165.181.148:&#x2F;data6&#x2F;brick</span><br><span class="line">Brick55: 141.165.181.146:&#x2F;data7&#x2F;brick</span><br><span class="line">Brick56: 141.165.181.147:&#x2F;data7&#x2F;brick</span><br><span class="line">Brick57: 141.165.181.148:&#x2F;data7&#x2F;brick</span><br><span class="line">Brick58: 141.165.181.146:&#x2F;data8&#x2F;brick</span><br><span class="line">Brick59: 141.165.181.147:&#x2F;data8&#x2F;brick</span><br><span class="line">Brick60: 141.165.181.148:&#x2F;data8&#x2F;brick</span><br><span class="line">Brick61: 141.165.181.146:&#x2F;data9&#x2F;brick</span><br><span class="line">Brick62: 141.165.181.147:&#x2F;data9&#x2F;brick</span><br><span class="line">Brick63: 141.165.181.148:&#x2F;data9&#x2F;brick</span><br><span class="line">Brick64: 141.165.181.146:&#x2F;data10&#x2F;brick</span><br><span class="line">Brick65: 141.165.181.147:&#x2F;data10&#x2F;brick</span><br><span class="line">Brick66: 141.165.181.148:&#x2F;data10&#x2F;brick</span><br><span class="line">Brick67: 141.165.181.146:&#x2F;data11&#x2F;brick</span><br><span class="line">Brick68: 141.165.181.147:&#x2F;data11&#x2F;brick</span><br><span class="line">Brick69: 141.165.181.148:&#x2F;data11&#x2F;brick</span><br><span class="line">Brick70: 141.165.181.146:&#x2F;data12&#x2F;brick</span><br><span class="line">Brick71: 141.165.181.147:&#x2F;data12&#x2F;brick</span><br><span class="line">Brick72: 141.165.181.148:&#x2F;data12&#x2F;brick</span><br><span class="line">Options Reconfigured:</span><br><span class="line">network.ping-timeout: 120</span><br><span class="line">cluster.read-hash-mode: 3</span><br><span class="line">storage.fips-mode-rchecksum: on</span><br><span class="line">nfs.disable: on</span><br></pre></td></tr></table></figure>
</li>
<li><p>volume status</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume status   speech_vol_v2     </span><br><span class="line">Status of volume: speech_vol_v2</span><br><span class="line">Gluster process                             TCP Port  RDMA Port  Online  Pid</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Brick 141.165.65.141:&#x2F;data1&#x2F;brick            49152     0          Y       16432</span><br><span class="line">Brick 141.165.65.142:&#x2F;data1&#x2F;brick            49152     0          Y       16355</span><br><span class="line">Brick 141.165.65.144:&#x2F;data1&#x2F;brick            49152     0          Y       32212</span><br><span class="line">Brick 141.165.65.141:&#x2F;data2&#x2F;brick            49153     0          Y       20613</span><br><span class="line">Brick 141.165.65.142:&#x2F;data2&#x2F;brick            49153     0          Y       16376</span><br><span class="line">Brick 141.165.65.144:&#x2F;data2&#x2F;brick            49153     0          Y       32232</span><br><span class="line">Brick 141.165.65.141:&#x2F;data3&#x2F;brick            49154     0          Y       20627</span><br><span class="line">Brick 141.165.65.142:&#x2F;data3&#x2F;brick            49154     0          Y       16402</span><br><span class="line">Brick 141.165.65.144:&#x2F;data3&#x2F;brick            49154     0          Y       32252</span><br><span class="line">Brick 141.165.65.141:&#x2F;data4&#x2F;brick            49155     0          Y       10020</span><br><span class="line">Brick 141.165.65.142:&#x2F;data4&#x2F;brick            49155     0          Y       16433</span><br><span class="line">Brick 141.165.65.144:&#x2F;data4&#x2F;brick            49155     0          Y       32272</span><br><span class="line">Brick 141.165.65.141:&#x2F;data5&#x2F;brick            49156     0          Y       10026</span><br><span class="line">Brick 141.165.65.142:&#x2F;data5&#x2F;brick            49156     0          Y       16457</span><br><span class="line">Brick 141.165.65.144:&#x2F;data5&#x2F;brick            49156     0          Y       32292</span><br><span class="line">Brick 141.165.65.141:&#x2F;data6&#x2F;brick            49157     0          Y       20620</span><br><span class="line">Brick 141.165.65.142:&#x2F;data6&#x2F;brick            49157     0          Y       16485</span><br><span class="line">Brick 141.165.65.144:&#x2F;data6&#x2F;brick            49157     0          Y       32312</span><br><span class="line">Brick 141.165.65.141:&#x2F;data7&#x2F;brick            49158     0          Y       10055</span><br><span class="line">Brick 141.165.65.142:&#x2F;data7&#x2F;brick            49158     0          Y       16505</span><br><span class="line">Brick 141.165.65.144:&#x2F;data7&#x2F;brick            49158     0          Y       32332</span><br><span class="line">Brick 141.165.65.141:&#x2F;data8&#x2F;brick            49159     0          Y       15551</span><br><span class="line">Brick 141.165.65.142:&#x2F;data8&#x2F;brick            49159     0          Y       16530</span><br><span class="line">Brick 141.165.65.144:&#x2F;data8&#x2F;brick            49159     0          Y       32352</span><br><span class="line">Brick 141.165.65.141:&#x2F;data9&#x2F;brick            49160     0          Y       10075</span><br><span class="line">Brick 141.165.65.142:&#x2F;data9&#x2F;brick            49160     0          Y       16552</span><br><span class="line">Brick 141.165.65.144:&#x2F;data9&#x2F;brick            49160     0          Y       32372</span><br><span class="line">Brick 141.165.65.141:&#x2F;data10&#x2F;brick           49161     0          Y       10086</span><br><span class="line">Brick 141.165.65.142:&#x2F;data10&#x2F;brick           49161     0          Y       16573</span><br><span class="line">Brick 141.165.65.144:&#x2F;data10&#x2F;brick           49161     0          Y       32394</span><br><span class="line">Brick 141.165.65.141:&#x2F;data11&#x2F;brick           49162     0          Y       10099</span><br><span class="line">Brick 141.165.65.142:&#x2F;data11&#x2F;brick           49162     0          Y       16595</span><br><span class="line">Brick 141.165.65.144:&#x2F;data11&#x2F;brick           49162     0          Y       32415</span><br><span class="line">Brick 141.165.65.141:&#x2F;data12&#x2F;brick           49163     0          Y       10106</span><br><span class="line">Brick 141.165.65.142:&#x2F;data12&#x2F;brick           49163     0          Y       16616</span><br><span class="line">Brick 141.165.65.144:&#x2F;data12&#x2F;brick           49163     0          Y       32435</span><br><span class="line">Brick 141.165.181.146:&#x2F;data1&#x2F;brick           49152     0          Y       177222</span><br><span class="line">Brick 141.165.181.147:&#x2F;data1&#x2F;brick           49164     0          Y       215532</span><br><span class="line">Brick 141.165.181.148:&#x2F;data1&#x2F;brick           49152     0          Y       182183</span><br><span class="line">Brick 141.165.181.146:&#x2F;data2&#x2F;brick           49153     0          Y       177242</span><br><span class="line">Brick 141.165.181.147:&#x2F;data2&#x2F;brick           49165     0          Y       215541</span><br><span class="line">Brick 141.165.181.148:&#x2F;data2&#x2F;brick           49153     0          Y       182203</span><br><span class="line">Brick 141.165.181.146:&#x2F;data3&#x2F;brick           49154     0          Y       177263</span><br><span class="line">Brick 141.165.181.147:&#x2F;data3&#x2F;brick           49166     0          Y       215552</span><br><span class="line">Brick 141.165.181.148:&#x2F;data3&#x2F;brick           49154     0          Y       182224</span><br><span class="line">Brick 141.165.181.146:&#x2F;data4&#x2F;brick           49155     0          Y       177283</span><br><span class="line">Brick 141.165.181.147:&#x2F;data4&#x2F;brick           49167     0          Y       215563</span><br><span class="line">Brick 141.165.181.148:&#x2F;data4&#x2F;brick           49155     0          Y       182244</span><br><span class="line">Brick 141.165.181.146:&#x2F;data5&#x2F;brick           49156     0          Y       177303</span><br><span class="line">Brick 141.165.181.147:&#x2F;data5&#x2F;brick           49168     0          Y       215574</span><br><span class="line">Brick 141.165.181.148:&#x2F;data5&#x2F;brick           49156     0          Y       182264</span><br><span class="line">Brick 141.165.181.146:&#x2F;data6&#x2F;brick           49157     0          Y       177323</span><br><span class="line">Brick 141.165.181.147:&#x2F;data6&#x2F;brick           49169     0          Y       215585</span><br><span class="line">Brick 141.165.181.148:&#x2F;data6&#x2F;brick           49157     0          Y       182284</span><br><span class="line">Brick 141.165.181.146:&#x2F;data7&#x2F;brick           49158     0          Y       177343</span><br><span class="line">Brick 141.165.181.147:&#x2F;data7&#x2F;brick           49158     0          Y       176773</span><br><span class="line">Brick 141.165.181.148:&#x2F;data7&#x2F;brick           49158     0          Y       182304</span><br><span class="line">Brick 141.165.181.146:&#x2F;data8&#x2F;brick           49159     0          Y       177363</span><br><span class="line">Brick 141.165.181.147:&#x2F;data8&#x2F;brick           49170     0          Y       215596</span><br><span class="line">Brick 141.165.181.148:&#x2F;data8&#x2F;brick           49159     0          Y       182324</span><br><span class="line">Brick 141.165.181.146:&#x2F;data9&#x2F;brick           49160     0          Y       177383</span><br><span class="line">Brick 141.165.181.147:&#x2F;data9&#x2F;brick           49171     0          Y       215607</span><br><span class="line">Brick 141.165.181.148:&#x2F;data9&#x2F;brick           49160     0          Y       182346</span><br><span class="line">Brick 141.165.181.146:&#x2F;data10&#x2F;brick          49161     0          Y       177403</span><br><span class="line">Brick 141.165.181.147:&#x2F;data10&#x2F;brick          49172     0          Y       215618</span><br><span class="line">Brick 141.165.181.148:&#x2F;data10&#x2F;brick          49161     0          Y       182366</span><br><span class="line">Brick 141.165.181.146:&#x2F;data11&#x2F;brick          49162     0          Y       177423</span><br><span class="line">Brick 141.165.181.147:&#x2F;data11&#x2F;brick          49173     0          Y       215629</span><br><span class="line">Brick 141.165.181.148:&#x2F;data11&#x2F;brick          49162     0          Y       182386</span><br><span class="line">Brick 141.165.181.146:&#x2F;data12&#x2F;brick          49163     0          Y       177443</span><br><span class="line">Brick 141.165.181.147:&#x2F;data12&#x2F;brick          49174     0          Y       215639</span><br><span class="line">Brick 141.165.181.148:&#x2F;data12&#x2F;brick          49163     0          Y       182406</span><br></pre></td></tr></table></figure>

<h4 id="客户端无法连接的Brick的信息"><a href="#客户端无法连接的Brick的信息" class="headerlink" title="客户端无法连接的Brick的信息"></a>客户端无法连接的Brick的信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;这些信息存在于&#x2F;var&#x2F;log&#x2F;glusterfs&#x2F;mnt-&#123;挂载名称&#125;.log中的Final graph:</span><br><span class="line">volume speech_vol_v2-client-55</span><br><span class="line">    type protocol&#x2F;client</span><br><span class="line">    option ping-timeout 120</span><br><span class="line">    option remote-host 141.165.181.147</span><br><span class="line">    option remote-subvolume &#x2F;data7&#x2F;brick</span><br><span class="line">    option transport-type socket</span><br><span class="line">    option transport.socket.ssl-enabled off</span><br><span class="line">    option transport.tcp-user-timeout 0</span><br><span class="line">    option transport.socket.keepalive-time 20</span><br><span class="line">    option transport.socket.keepalive-interval 2</span><br><span class="line">    option transport.socket.keepalive-count 9</span><br><span class="line">    option send-gids true</span><br><span class="line">end-volume</span><br></pre></td></tr></table></figure>


<h4 id="客户端挂载Debug日志"><a href="#客户端挂载Debug日志" class="headerlink" title="客户端挂载Debug日志"></a>客户端挂载Debug日志</h4><h5 id="操作系统kernel日志-var-log-message"><a href="#操作系统kernel日志-var-log-message" class="headerlink" title="操作系统kernel日志(/var/log/message)"></a>操作系统kernel日志(/var/log/message)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">May 26 12:20:18 storage-center-prd-141-165-181-147 kernel: [4036004.156726] TCP: request_sock_TCP: Possible SYN flooding on port 24007. Sending cookies.  Check SNMP counters.</span><br><span class="line">May 26 16:52:13 storage-center-prd-141-165-181-147 systemd[1]: Starting Cleanup of Temporary Directories...</span><br><span class="line">May 26 16:52:13 storage-center-prd-141-165-181-147 systemd[1]: Started Cleanup of Temporary Directories.</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.524551] INFO: task kswapd0:266 blocked for more than 120 seconds.</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.531180] &quot;echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;hung_task_timeout_secs&quot; disables this message.</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539187] kswapd0         D 0000000007496801     0   266      2 0x00000000</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539195]  ffff881ffcd3b8f0 0000000000000046 ffff881ffeab9fa0 ffff881ffcd3bfd8</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539198]  ffff881ffcd3bfd8 ffff881ffcd3bfd8 ffff881ffeab9fa0 ffff8804e82b4860</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539200]  7fffffffffffffff ffff8804e82b4858 ffff881ffeab9fa0 0000000007496801</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539202] Call Trace:</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539216]  [&lt;ffffffff816a94c9&gt;] schedule+0x29&#x2F;0x70</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539228]  [&lt;ffffffff816a6fd9&gt;] schedule_timeout+0x239&#x2F;0x2c0</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539235]  [&lt;ffffffff812fab24&gt;] ? blk_finish_plug+0x14&#x2F;0x40</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539271]  [&lt;ffffffffc01f9354&gt;] ? _xfs_buf_ioapply+0x334&#x2F;0x460 [xfs]</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539273]  [&lt;ffffffff816a987d&gt;] wait_for_completion+0xfd&#x2F;0x140</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539277]  [&lt;ffffffff810c4810&gt;] ? wake_up_state+0x20&#x2F;0x20</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539292]  [&lt;ffffffffc01fb434&gt;] ? xfs_bwrite+0x24&#x2F;0x60 [xfs]</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539305]  [&lt;ffffffffc01fb026&gt;] xfs_buf_submit_wait+0xe6&#x2F;0x1d0 [xfs]</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539316]  [&lt;ffffffffc01fb434&gt;] xfs_bwrite+0x24&#x2F;0x60 [xfs]</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539330]  [&lt;ffffffffc0203b71&gt;] xfs_reclaim_inode+0x331&#x2F;0x360 [xfs]</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539346]  [&lt;ffffffffc0203e07&gt;] xfs_reclaim_inodes_ag+0x267&#x2F;0x390 [xfs]</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539348]  [&lt;ffffffff810c4593&gt;] ? try_to_wake_up+0x183&#x2F;0x340</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539351]  [&lt;ffffffff8121d67a&gt;] ? evict+0x10a&#x2F;0x180</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539353]  [&lt;ffffffff810c4765&gt;] ? wake_up_process+0x15&#x2F;0x20</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539366]  [&lt;ffffffffc0204df3&gt;] xfs_reclaim_inodes_nr+0x33&#x2F;0x40 [xfs]</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539380]  [&lt;ffffffffc02146f5&gt;] xfs_fs_free_cached_objects+0x15&#x2F;0x20 [xfs]</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539383]  [&lt;ffffffff81203888&gt;] prune_super+0xe8&#x2F;0x170</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539387]  [&lt;ffffffff81195413&gt;] shrink_slab+0x163&#x2F;0x330</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539390]  [&lt;ffffffff811f7537&gt;] ? vmpressure+0x87&#x2F;0x90</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539392]  [&lt;ffffffff81199081&gt;] balance_pgdat+0x4b1&#x2F;0x5e0</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539394]  [&lt;ffffffff81199323&gt;] kswapd+0x173&#x2F;0x440</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539398]  [&lt;ffffffff810b1910&gt;] ? wake_up_atomic_t+0x30&#x2F;0x30</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539401]  [&lt;ffffffff811991b0&gt;] ? balance_pgdat+0x5e0&#x2F;0x5e0</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539402]  [&lt;ffffffff810b098f&gt;] kthread+0xcf&#x2F;0xe0</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539404]  [&lt;ffffffff810b08c0&gt;] ? insert_kthread_work+0x40&#x2F;0x40</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539408]  [&lt;ffffffff816b4f18&gt;] ret_from_fork+0x58&#x2F;0x90</span><br><span class="line">May 27 00:30:14 storage-center-prd-141-165-181-147 kernel: [4079697.539409]  [&lt;ffffffff810b08c0&gt;] ? insert_kthread_work+0x40&#x2F;0x40</span><br><span class="line">May 27 00:32:14 storage-center-prd-141-165-181-147 kernel: [4079817.259262] INFO: task kswapd0:266 blocked for more than 120 seconds.</span><br></pre></td></tr></table></figure>

<h5 id="客户端Mount-Debug日志详情"><a href="#客户端Mount-Debug日志详情" class="headerlink" title="客户端Mount Debug日志详情"></a>客户端Mount Debug日志详情</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[2020-05-27 03:47:34.303569] D [logging.c:1718:__gf_log_inject_timer_event] 0-logging-infra: Starting timer now. Timeout &#x3D; 120, current buf size &#x3D; 5</span><br><span class="line">[2020-05-27 03:47:52.040397] D [socket.c:3053:socket_event_handler] 0-transport: EPOLLERR - disconnecting (sock:7) (non-SSL)</span><br><span class="line">[2020-05-27 03:47:52.040442] D [MSGID: 0] [client.c:2334:client_rpc_notify] 0-speech_vol_v2-client-55: got RPC_CLNT_DISCONNECT </span><br><span class="line">[2020-05-27 03:47:52.040639] D [rpc-clnt-ping.c:96:rpc_clnt_remove_ping_timer_locked] (--&gt; &#x2F;lib64&#x2F;libglusterfs.so.0(_gf_log_callingfn+0x13a)[0x7fb22321e8ea] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0x12eeb)[0x7fb222fc9eeb] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(rpc_clnt_connection_cleanup+0x92)[0x7fb222fc5922] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0xf4e8)[0x7fb222fc64e8] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(rpc_transport_notify+0x23)[0x7fb222fc2a93] ))))) 0-: 141.165.181.147:24007: ping timer event already removed</span><br><span class="line">[2020-05-27 03:47:55.040804] D [name.c:171:client_fill_address_family] 0-speech_vol_v2-client-55: address-family not specified, marking it as unspec for getaddrinfo to resolve from (remote-host: 141.165.181.147)</span><br><span class="line">[2020-05-27 03:47:55.043219] D [MSGID: 0] [common-utils.c:532:gf_resolve_ip6] 0-resolver: returning ip-141.165.181.147 (port-24007) for hostname: 141.165.181.147 and port: 24007 </span><br><span class="line">[2020-05-27 03:47:55.043244] D [socket.c:3384:socket_fix_ssl_opts] 0-speech_vol_v2-client-55: disabling SSL for portmapper connection</span><br><span class="line">[2020-05-27 03:47:55.043408] D [MSGID: 0] [client.c:2323:client_rpc_notify] 0-speech_vol_v2-client-55: got RPC_CLNT_CONNECT </span><br><span class="line">[2020-05-27 03:47:55.043611] D [rpc-clnt-ping.c:96:rpc_clnt_remove_ping_timer_locked] (--&gt; &#x2F;lib64&#x2F;libglusterfs.so.0(_gf_log_callingfn+0x13a)[0x7fb22321e8ea] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0x12eeb)[0x7fb222fc9eeb] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0x13691)[0x7fb222fca691] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(rpc_clnt_submit+0x3b4)[0x7fb222fc6914] (--&gt; &#x2F;usr&#x2F;lib64&#x2F;glusterfs&#x2F;7.2&#x2F;xlator&#x2F;protocol&#x2F;client.so(+0x135b2)[0x7fb2146675b2] ))))) 0-: 141.165.181.147:24007: ping timer event already removed</span><br><span class="line">[2020-05-27 03:47:55.043662] D [MSGID: 0] [client-handshake.c:1399:server_has_portmap] 0-speech_vol_v2-client-55: detected portmapper on server </span><br><span class="line">[2020-05-27 03:47:55.043783] D [rpc-clnt-ping.c:195:rpc_clnt_ping_cbk] 0-speech_vol_v2-client-55: Ping latency is 0ms</span><br><span class="line">[2020-05-27 03:47:55.043812] I [rpc-clnt.c:1963:rpc_clnt_reconfig] 0-speech_vol_v2-client-55: changing port to 49158 (from 0)</span><br><span class="line">[2020-05-27 03:47:55.043844] D [socket.c:3053:socket_event_handler] 0-transport: EPOLLERR - disconnecting (sock:6) (non-SSL)</span><br><span class="line">[2020-05-27 03:47:55.043855] D [MSGID: 0] [client.c:2394:client_rpc_notify] 0-speech_vol_v2-client-55: disconnected (skipped notify) </span><br><span class="line">[2020-05-27 03:47:55.043876] D [name.c:171:client_fill_address_family] 0-speech_vol_v2-client-55: address-family not specified, marking it as unspec for getaddrinfo to resolve from (remote-host: 141.165.181.147)</span><br><span class="line">[2020-05-27 03:49:34.303646] D [logging.c:1756:gf_log_flush_timeout_cbk] 0-logging-infra: Log timer timed out. About to flush outstanding messages if present</span><br><span class="line">[2020-05-27 03:47:55.043854] D [MSGID: 0] [client.c:2334:client_rpc_notify] 0-speech_vol_v2-client-55: got RPC_CLNT_DISCONNECT </span><br><span class="line">[2020-05-27 03:47:55.046202] D [MSGID: 0] [common-utils.c:532:gf_resolve_ip6] 0-resolver: returning ip-141.165.181.147 (port-24007) for hostname: 141.165.181.147 and port: 24007 </span><br><span class="line">[2020-05-27 03:49:34.303898] D [logging.c:1718:__gf_log_inject_timer_event] 0-logging-infra: Starting timer now. Timeout &#x3D; 120, current buf size &#x3D; 5</span><br><span class="line">[2020-05-27 03:50:02.344385] D [socket.c:3053:socket_event_handler] 0-transport: EPOLLERR - disconnecting (sock:7) (non-SSL)</span><br><span class="line">[2020-05-27 03:50:02.344418] D [MSGID: 0] [client.c:2334:client_rpc_notify] 0-speech_vol_v2-client-55: got RPC_CLNT_DISCONNECT </span><br><span class="line">[2020-05-27 03:50:02.344582] D [rpc-clnt-ping.c:96:rpc_clnt_remove_ping_timer_locked] (--&gt; &#x2F;lib64&#x2F;libglusterfs.so.0(_gf_log_callingfn+0x13a)[0x7fb22321e8ea] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0x12eeb)[0x7fb222fc9eeb] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(rpc_clnt_connection_cleanup+0x92)[0x7fb222fc5922] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0xf4e8)[0x7fb222fc64e8] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(rpc_transport_notify+0x23)[0x7fb222fc2a93] ))))) 0-: 141.165.181.147:24007: ping timer event already removed</span><br><span class="line">[2020-05-27 03:50:05.344677] D [name.c:171:client_fill_address_family] 0-speech_vol_v2-client-55: address-family not specified, marking it as unspec for getaddrinfo to resolve from (remote-host: 141.165.181.147)</span><br><span class="line">[2020-05-27 03:50:05.347099] D [MSGID: 0] [common-utils.c:532:gf_resolve_ip6] 0-resolver: returning ip-141.165.181.147 (port-24007) for hostname: 141.165.181.147 and port: 24007 </span><br><span class="line">[2020-05-27 03:50:05.347126] D [socket.c:3384:socket_fix_ssl_opts] 0-speech_vol_v2-client-55: disabling SSL for portmapper connection</span><br><span class="line">[2020-05-27 03:50:05.347336] D [MSGID: 0] [client.c:2323:client_rpc_notify] 0-speech_vol_v2-client-55: got RPC_CLNT_CONNECT </span><br><span class="line">[2020-05-27 03:50:05.347542] D [rpc-clnt-ping.c:96:rpc_clnt_remove_ping_timer_locked] (--&gt; &#x2F;lib64&#x2F;libglusterfs.so.0(_gf_log_callingfn+0x13a)[0x7fb22321e8ea] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0x12eeb)[0x7fb222fc9eeb] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0x13691)[0x7fb222fca691] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(rpc_clnt_submit+0x3b4)[0x7fb222fc6914] (--&gt; &#x2F;usr&#x2F;lib64&#x2F;glusterfs&#x2F;7.2&#x2F;xlator&#x2F;protocol&#x2F;client.so(+0x135b2)[0x7fb2146675b2] ))))) 0-: 141.165.181.147:24007: ping timer event already removed</span><br><span class="line">[2020-05-27 03:50:05.347591] D [MSGID: 0] [client-handshake.c:1399:server_has_portmap] 0-speech_vol_v2-client-55: detected portmapper on server </span><br><span class="line">[2020-05-27 03:50:05.347633] D [rpc-clnt-ping.c:195:rpc_clnt_ping_cbk] 0-speech_vol_v2-client-55: Ping latency is 0ms</span><br><span class="line">[2020-05-27 03:50:05.347701] I [rpc-clnt.c:1963:rpc_clnt_reconfig] 0-speech_vol_v2-client-55: changing port to 49158 (from 0)</span><br><span class="line">[2020-05-27 03:50:05.347735] D [socket.c:3053:socket_event_handler] 0-transport: EPOLLERR - disconnecting (sock:6) (non-SSL)</span><br><span class="line">[2020-05-27 03:50:05.347749] D [MSGID: 0] [client.c:2394:client_rpc_notify] 0-speech_vol_v2-client-55: disconnected (skipped notify) </span><br><span class="line">[2020-05-27 03:50:05.347765] D [name.c:171:client_fill_address_family] 0-speech_vol_v2-client-55: address-family not specified, marking it as unspec for getaddrinfo to resolve from (remote-host: 141.165.181.147)</span><br><span class="line">&#x2F;0-speech_vol_v2-client-55</span><br><span class="line">[2020-05-27 03:51:34.303977] D [logging.c:1756:gf_log_flush_timeout_cbk] 0-logging-infra: Log timer timed out. About to flush outstanding messages if present</span><br><span class="line">[2020-05-27 03:50:05.347748] D [MSGID: 0] [client.c:2334:client_rpc_notify] 0-speech_vol_v2-client-55: got RPC_CLNT_DISCONNECT </span><br><span class="line">[2020-05-27 03:50:05.350156] D [MSGID: 0] [common-utils.c:532:gf_resolve_ip6] 0-resolver: returning ip-141.165.181.147 (port-24007) for hostname: 141.165.181.147 and port: 24007 </span><br><span class="line">[2020-05-27 03:51:34.304035] D [logging.c:1718:__gf_log_inject_timer_event] 0-logging-infra: Starting timer now. Timeout &#x3D; 120, current buf size &#x3D; 5</span><br><span class="line">[2020-05-27 03:52:12.648388] D [socket.c:3053:socket_event_handler] 0-transport: EPOLLERR - disconnecting (sock:7) (non-SSL)</span><br><span class="line">[2020-05-27 03:52:12.648424] D [MSGID: 0] [client.c:2334:client_rpc_notify] 0-speech_vol_v2-client-55: got RPC_CLNT_DISCONNECT </span><br><span class="line">[2020-05-27 03:52:12.648591] D [rpc-clnt-ping.c:96:rpc_clnt_remove_ping_timer_locked] (--&gt; &#x2F;lib64&#x2F;libglusterfs.so.0(_gf_log_callingfn+0x13a)[0x7fb22321e8ea] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0x12eeb)[0x7fb222fc9eeb] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(rpc_clnt_connection_cleanup+0x92)[0x7fb222fc5922] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0xf4e8)[0x7fb222fc64e8] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(rpc_transport_notify+0x23)[0x7fb222fc2a93] ))))) 0-: 141.165.181.147:24007: ping timer event already removed</span><br><span class="line">[2020-05-27 03:52:15.648683] D [name.c:171:client_fill_address_family] 0-speech_vol_v2-client-55: address-family not specified, marking it as unspec for getaddrinfo to resolve from (remote-host: 141.165.181.147)</span><br><span class="line">[2020-05-27 03:52:15.651027] D [MSGID: 0] [common-utils.c:532:gf_resolve_ip6] 0-resolver: returning ip-141.165.181.147 (port-24007) for hostname: 141.165.181.147 and port: 24007 </span><br><span class="line">[2020-05-27 03:52:15.651052] D [socket.c:3384:socket_fix_ssl_opts] 0-speech_vol_v2-client-55: disabling SSL for portmapper connection</span><br><span class="line">[2020-05-27 03:52:15.651271] D [MSGID: 0] [client.c:2323:client_rpc_notify] 0-speech_vol_v2-client-55: got RPC_CLNT_CONNECT </span><br><span class="line">[2020-05-27 03:52:15.651501] D [rpc-clnt-ping.c:96:rpc_clnt_remove_ping_timer_locked] (--&gt; &#x2F;lib64&#x2F;libglusterfs.so.0(_gf_log_callingfn+0x13a)[0x7fb22321e8ea] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0x12eeb)[0x7fb222fc9eeb] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(+0x13691)[0x7fb222fca691] (--&gt; &#x2F;lib64&#x2F;libgfrpc.so.0(rpc_clnt_submit+0x3b4)[0x7fb222fc6914] (--&gt; &#x2F;usr&#x2F;lib64&#x2F;glusterfs&#x2F;7.2&#x2F;xlator&#x2F;protocol&#x2F;client.so(+0x135b2)[0x7fb2146675b2] ))))) 0-: 141.165.181.147:24007: ping timer event already removed</span><br><span class="line">[2020-05-27 03:52:15.651557] D [MSGID: 0] [client-handshake.c:1399:server_has_portmap] 0-speech_vol_v2-client-55: detected portmapper on server </span><br><span class="line">[2020-05-27 03:52:15.651693] D [rpc-clnt-ping.c:195:rpc_clnt_ping_cbk] 0-speech_vol_v2-client-55: Ping latency is 0ms</span><br><span class="line">[2020-05-27 03:52:15.651734] I [rpc-clnt.c:1963:rpc_clnt_reconfig] 0-speech_vol_v2-client-55: changing port to 49158 (from 0)</span><br><span class="line">[2020-05-27 03:52:15.651758] D [socket.c:3053:socket_event_handler] 0-transport: EPOLLERR - disconnecting (sock:6) (non-SSL)</span><br><span class="line">[2020-05-27 03:52:15.651770] D [MSGID: 0] [client.c:2394:client_rpc_notify] 0-speech_vol_v2-client-55: disconnected (skipped notify) </span><br><span class="line">[2020-05-27 03:52:15.651785] D [name.c:171:client_fill_address_family] 0-speech_vol_v2-client-55: address-family not specified, marking it as unspec for getaddrinfo to resolve from (remote-host: 141.165.181.147)</span><br><span class="line">[2020-05-27 03:53:34.304123] D [logging.c:1756:gf_log_flush_timeout_cbk] 0-logging-infra: Log timer timed out. About to flush outstanding messages if present</span><br><span class="line">[2020-05-27 03:52:15.651768] D [MSGID: 0] [client.c:2334:client_rpc_notify] 0-speech_vol_v2-client-55: got RPC_CLNT_DISCONNECT </span><br><span class="line">[2020-05-27 03:52:15.654154] D [MSGID: 0] [common-utils.c:532:gf_resolve_ip6] 0-resolver: returning ip-141.165.181.147 (port-24007) for hostname: 141.165.181.147 and port: 24007 </span><br><span class="line">[2020-05-27 03:53:34.304179] D [logging.c:1718:__gf_log_inject_timer_event] 0-logging-infra: Starting timer now. Timeout &#x3D; 120, current buf size &#x3D; 5</span><br></pre></td></tr></table></figure>


<h5 id="0-speech-vol-v2-client-55对应服务端节点-147下的-data7-brick-日志"><a href="#0-speech-vol-v2-client-55对应服务端节点-147下的-data7-brick-日志" class="headerlink" title="0-speech_vol_v2-client-55对应服务端节点(147下的/data7/brick)日志"></a>0-speech_vol_v2-client-55对应服务端节点(147下的/data7/brick)日志</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[2020-05-27 01:02:22.421765] W [socket.c:774:__socket_rwv] 0-tcp.speech_vol_v2-server: readv on 141.165.32.25:47645 failed (No data available)</span><br><span class="line">[2020-05-27 01:02:22.421795] I [MSGID: 115036] [server.c:501:server_rpc_notify] 0-speech_vol_v2-server: disconnecting connection from CTX_ID:de438bc8-1b52-446c-817f-60d646af0ba6-GRAPH_ID:2-PID:84971-HOST:ai-vtraining-prd-141-165-32-25.v-bj-4.vivo.lan-PC_NAME:speech_vol_v2-client-55-RECON_NO:-0 </span><br><span class="line">[2020-05-27 01:02:26.918776] W [socket.c:774:__socket_rwv] 0-tcp.speech_vol_v2-server: readv on 141.165.32.25:47562 failed (No data available)</span><br><span class="line">[2020-05-27 01:02:26.918807] I [MSGID: 115036] [server.c:501:server_rpc_notify] 0-speech_vol_v2-server: disconnecting connection from CTX_ID:36965041-2046-4413-88a4-08bc06fc1de4-GRAPH_ID:2-PID:87591-HOST:ai-vtraining-prd-141-165-32-25.v-bj-4.vivo.lan-PC_NAME:speech_vol_v2-client-55-RECON_NO:-0 </span><br><span class="line">[2020-05-27 01:03:13.270262] W [socket.c:774:__socket_rwv] 0-tcp.speech_vol_v2-server: readv on 141.165.86.129:48212 failed (No data available)</span><br><span class="line">[2020-05-27 01:03:13.270295] I [MSGID: 115036] [server.c:501:server_rpc_notify] 0-speech_vol_v2-server: disconnecting connection from CTX_ID:2dafdf38-ff96-45cc-99c2-1238764b59ae-GRAPH_ID:0-PID:75668-HOST:ai-vtraining-prd-141-165-86-129.v-bj-4.vivo.lan-PC_NAME:speech_vol_v2-client-55-RECON_NO:-0 </span><br><span class="line">[2020-05-27 01:03:13.285400] W [socket.c:774:__socket_rwv] 0-tcp.speech_vol_v2-server: readv on 141.165.86.129:48162 failed (No data available)</span><br><span class="line">[2020-05-27 01:03:13.285422] I [MSGID: 115036] [server.c:501:server_rpc_notify] 0-speech_vol_v2-server: disconnecting connection from CTX_ID:4251ffc2-e1c5-4357-a5d2-7c92e8221fad-GRAPH_ID:0-PID:75625-HOST:ai-vtraining-prd-141-165-86-129.v-bj-4.vivo.lan-PC_NAME:speech_vol_v2-client-55-RECON_NO:-0 </span><br><span class="line">[2020-05-27 01:36:05.410946] W [socket.c:774:__socket_rwv] 0-tcp.speech_vol_v2-server: readv on 10.196.20.133:47621 failed (No data available)</span><br><span class="line">[2020-05-27 01:36:05.410974] I [MSGID: 115036] [server.c:501:server_rpc_notify] 0-speech_vol_v2-server: disconnecting connection from CTX_ID:57fbf79a-bae3-4bcd-8670-70d559956cac-GRAPH_ID:0-PID:15841-HOST:ai-vtraining-gpu-prd-10-196-20-133.v-bj-4.vivo.lan-PC_NAME:speech_vol_v2-client-55-RECON_NO:-0 </span><br><span class="line">[2020-05-27 01:36:06.056913] W [socket.c:774:__socket_rwv] 0-tcp.speech_vol_v2-server: readv on 10.196.20.133:47331 failed (No data available)</span><br><span class="line">[2020-05-27 01:36:06.056941] I [MSGID: 115036] [server.c:501:server_rpc_notify] 0-speech_vol_v2-server: disconnecting connection from CTX_ID:b68c4c8e-e8d8-4d44-97a3-a503791d6177-GRAPH_ID:0-PID:16094-HOST:ai-vtraining-gpu-prd-10-196-20-133.v-bj-4.vivo.lan-PC_NAME:speech_vol_v2-client-55-RECON_NO:-0 </span><br><span class="line">[2020-05-27 02:10:34.719707] W [socket.c:774:__socket_rwv] 0-tcp.speech_vol_v2-server: readv on 141.165.30.45:48603 failed (No data available)</span><br><span class="line">[2020-05-27 02:10:34.719738] I [MSGID: 115036] [server.c:501:server_rpc_notify] 0-speech_vol_v2-server: disconnecting connection from CTX_ID:0ed18a02-3363-4cba-9313-93f7b221ede4-GRAPH_ID:10-PID:6869-HOST:ai-vtraining-prd-141-165-30-45.v-bj-4.vivo.lan-PC_NAME:speech_vol_v2-client-55-RECON_NO:-0 </span><br><span class="line">[2020-05-27 02:13:50.989206] I [addr.c:54:compare_addr_and_update] 0-&#x2F;data7&#x2F;brick: allowed &#x3D; &quot;*&quot;, received addr &#x3D; &quot;141.165.30.45&quot;</span><br><span class="line">[2020-05-27 02:13:50.989234] I [MSGID: 115029] [server-handshake.c:549:server_setvolume] 0-speech_vol_v2-server: accepted client from CTX_ID:a327610d-0acf-4785-a912-17e87c126ba9-GRAPH_ID:0-PID:67045-HOST:ai-vtraining-prd-141-165-30-45.v-bj-4.vivo.lan-PC_NAME:speech_vol_v2-client-55-RECON_NO:-0 (version: 6.5) with subvol &#x2F;data7&#x2F;brick </span><br><span class="line">[2020-05-27 02:17:13.967294] W [socket.c:774:__socket_rwv] 0-tcp.speech_vol_v2-server: readv on 141.165.30.45:48606 failed (No data available)</span><br><span class="line">[2020-05-27 02:39:55.104419] W [glusterfsd.c:1596:cleanup_and_exit] (--&gt;&#x2F;lib64&#x2F;libpthread.so.0(+0x7dd5) [0x7f9d087f1dd5] --&gt;&#x2F;usr&#x2F;sbin&#x2F;glusterfsd(glusterfs_sigwaiter+0xe5) [0x55f6769bb625] --&gt;&#x2F;usr&#x2F;sbin&#x2F;glusterfsd(cleanup_and_exit+0x6b) [0x55f6769bb48b] ) 0-: received signum (15), shutting down </span><br><span class="line">[2020-05-27 02:39:55.104502] W [socket.c:774:__socket_rwv] 0-glusterfs: writev on 141.165.181.147:24007 failed (Broken pipe)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/glusterfs%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8C%82%E8%BD%BDinit%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/26/glusterfs%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8C%82%E8%BD%BDinit%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">glusterfs客户端挂载init流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-26 21:27:16 / Modified: 21:31:59" itemprop="dateCreated datePublished" datetime="2020-05-26T21:27:16+08:00">2020-05-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Glusterfs-原理"><a href="#Glusterfs-原理" class="headerlink" title="Glusterfs 原理"></a>Glusterfs 原理</h4><p><strong>Glusterfs 基本原理</strong><br>    Glusterfs 是基于fuse的分布式存储，功能上支持分布式/3副本/EC三种存储方式。Glusterfs采用堆栈式的架构设计，服务端和客户端采用translator.<br>    GlusterFS概念中，由一系列translator构成的完整功能栈称之为Volume，分配给一个volume的本地文件系统称为brick，被至少一个translator处理过的brick称为subvolume。客户端是由于volume类型来加载对应的translator，服务端也是一样，根据不同的volume的类型加载translator。客户端(glusterfs)通过挂载时候提供节点IP地址，很对应节点的服务端管理进程通信，获取brick源信息、客户单需要加载的配置，客户端根据配置初始化xlator，后续IO的流程按照xlator的顺序经过每个xlator的fop函数，然后直接和对应的glusterfsd的进程交互IO操作。glusterfsd也是一样，根据服务端配置文件，初始化服务端需要加载xlator，进行每个xlator的fop的操作，最终执行系统IO函数进行IO操作。节点的管理服务(glusterd),仅仅加载一个管理的xlator,处理来自glusterfs/gluster的请求，不会处理对应的IO操作操作。</p>
<h4 id="Glusterfs环境"><a href="#Glusterfs环境" class="headerlink" title="Glusterfs环境"></a>Glusterfs环境</h4><p><strong>1.Glusterfs版本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">glusterfs 7.5</span><br></pre></td></tr></table></figure>
<p><strong>2.volume info</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Volume Name: rep3_vol</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: 73360fc2-e105-4fd4-9b92-b5fa333ba75d</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x 3 &#x3D; 3</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: 10.193.189.153:&#x2F;debug&#x2F;glusterfs&#x2F;rep3_vol&#x2F;brick</span><br><span class="line">Brick2: 10.193.189.154:&#x2F;debug&#x2F;glusterfs&#x2F;rep3_vol&#x2F;brick</span><br><span class="line">Brick3: 10.193.189.155:&#x2F;debug&#x2F;glusterfs&#x2F;rep3_vol&#x2F;brick</span><br><span class="line">Options Reconfigured:</span><br><span class="line">diagnostics.brick-log-level: INFO</span><br><span class="line">performance.client-io-threads: off</span><br><span class="line">nfs.disable: on</span><br><span class="line">storage.fips-mode-rchecksum: on</span><br><span class="line">transport.address-family: inet</span><br><span class="line">diagnostics.client-log-level: DEBUG</span><br></pre></td></tr></table></figure>

<h4 id="Mount-命令"><a href="#Mount-命令" class="headerlink" title="Mount 命令"></a>Mount 命令</h4><p><strong>1.通过mount命令挂载</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t glusterfs -o acl 10.193.189.153:&#x2F;rep3_vol &#x2F;mnt&#x2F;rep3_vol2</span><br></pre></td></tr></table></figure>
<p><strong>2.直接使用glusterfs二进制挂载</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;sbin&#x2F;glusterfs --acl --process-name fuse --volfile-server&#x3D;10.193.189.153 --volfile-id&#x3D;rep3_vol &#x2F;mnt&#x2F;rep3_vol</span><br></pre></td></tr></table></figure>
<h4 id="Mount-Glusterfs-整个流程"><a href="#Mount-Glusterfs-整个流程" class="headerlink" title="Mount Glusterfs 整个流程"></a>Mount Glusterfs 整个流程</h4><h5 id="Glusterfs-交互架构"><a href="#Glusterfs-交互架构" class="headerlink" title="Glusterfs 交互架构"></a>Glusterfs 交互架构</h5><p><img src="/2020/05/26/glusterfs%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8C%82%E8%BD%BDinit%E6%B5%81%E7%A8%8B/glusterfs-init.png" alt="glusterfs-init"></p>
<h5 id="Glusterfs-客户端实现分析"><a href="#Glusterfs-客户端实现分析" class="headerlink" title="Glusterfs 客户端实现分析"></a>Glusterfs 客户端实现分析</h5><ul>
<li><p>1.glusterfsd.c中的main方法入口函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">	create_fuse_mount(ctx);</span><br><span class="line">	glusterfs_volumes_init(ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>2.create_fuse_mount初始化mount/fuse的模块，具体是加载/usr/local/lib/glusterfs/2020.05.12/xlator/mount/fuse.so,会去执行fuse.so中的init方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int create_fuse_mount(glusterfs_ctx_t *ctx)</span><br><span class="line">&#123;</span><br><span class="line">	xlator_set_type(master, &quot;mount&#x2F;fuse&quot;)</span><br><span class="line">	xlator_init(master);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>3.加载glusterfs fuse模块以后会去执行 glusterfs_volumes_init，该函数主要是在客户端初始化针对客户端操作的volume需要的xlator.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int glusterfs_volumes_init(glusterfs_ctx_t *ctx)</span><br><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line">    glusterfs_mgmt_init(ctx);</span><br><span class="line">    glusterfs_process_volfp(ctx, fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>4.针对我们参数传递的volfile_server为某个节点的ip,代码会走到glusterfs_mgmt_init，该函数会根据连接请求去fetch spec</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">int glusterfs_mgmt_init(glusterfs_ctx_t *ctx)</span><br><span class="line">&#123;</span><br><span class="line">	rpc_clnt_register_notify(rpc, mgmt_rpc_notify, THIS);</span><br><span class="line">	rpcclnt_cbk_program_register(rpc, &amp;mgmt_cbk_prog, THIS);</span><br><span class="line">    ctx-&gt;notify &#x3D; glusterfs_mgmt_notify;</span><br><span class="line">    ret &#x3D; rpc_clnt_start(rpc);</span><br><span class="line">&#125;</span><br><span class="line">static int mgmt_rpc_notify(struct rpc_clnt *rpc, void *mydata, rpc_clnt_event_t event,</span><br><span class="line">                void *data)</span><br><span class="line">&#123;</span><br><span class="line"> switch (event) &#123;</span><br><span class="line">        case RPC_CLNT_DISCONNECT:</span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">        case RPC_CLNT_CONNECT:</span><br><span class="line">            ret &#x3D; glusterfs_volfile_fetch(ctx);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;spec 信息如下参见附件</span><br></pre></td></tr></table></figure></li>
<li><ol start="5">
<li>glusterfs_volfile_fetch 会调用glusterfs_volfile_fetch_one 获取spec</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int glusterfs_volfile_fetch(glusterfs_ctx_t *ctx)</span><br><span class="line">&#123;</span><br><span class="line">	return glusterfs_volfile_fetch_one(ctx, ctx-&gt;cmd_args.volfile_id);   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>6.glusterfs_volfile_fetch_one是实质获取客户端brick元数据和translator的函数、同时通过mgmt_getspec_cbk回调函数处理获取这些信息后的处理函数<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static int glusterfs_volfile_fetch_one(glusterfs_ctx_t *ctx, char *volfile_id)</span><br><span class="line">&#123;</span><br><span class="line"> ret &#x3D; mgmt_submit_request(&amp;req, frame, ctx, &amp;clnt_handshake_prog,</span><br><span class="line">                              GF_HNDSK_GETSPEC, mgmt_getspec_cbk,</span><br><span class="line">                              (xdrproc_t)xdr_gf_getspec_req);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;mgmt_submit_request函数会调用服务端的gluster_handshake_actors[GETSPEC]对应的函数，获取spec信息后会调用mgmt_getspec_cbk回调函数.</span><br><span class="line">&#x2F;&#x2F;在gdb参数中设置--volfile-server&#x3D;10.193.189.154 这个节点上gdb attach glusterd进程，然后设置在server_getspec，然后客户端请求，然后10.193.189.154节点的glusterd在server_getspec响应</span><br><span class="line">rpcsvc_actor_t gluster_handshake_actors[GF_HNDSK_MAXVALUE] &#x3D; &#123;</span><br><span class="line">    [GF_HNDSK_GETSPEC] &#x3D; &#123;&quot;GETSPEC&quot;, GF_HNDSK_GETSPEC, server_getspec, NULL, 0, DRC_NA&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;重新获取spec初始化客户端的translator的，这个函数就是构造xlator的图，同时初始化每个xlator</span><br><span class="line">int</span><br><span class="line">mgmt_getspec_cbk(struct rpc_req *req, struct iovec *iov, int count,</span><br><span class="line">                 void *myframe)</span><br><span class="line">&#123;</span><br><span class="line"> glusterfs_volfile_reconfigure(tmpfp, ctx);</span><br><span class="line"> glusterfs_process_volfp(ctx, tmpfp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Debug方法"><a href="#Debug方法" class="headerlink" title="Debug方法"></a>Debug方法</h4></li>
</ul>
<p><strong>1.调试的注意点</strong><br>    glusterfs/glusterd/glusterfsd是同一个二进制进程，仅仅是区别是glusterfsd和glusterfs软链了glusterd的进程。glusterfs使用同一个二进制程序，根据不同的业务功能，fork或者走不同逻辑分别来实现glusterfs/glusterfsd/glusterd的功能。</p>
<p><strong>2.调试的注意点</strong></p>
<p><strong>3.具体调试方法</strong></p>
<ul>
<li>1.执行命令gdb /usr/local/sbin/glusterfs</li>
<li>2.进入gdb的交互控制界面，需要设置参数,参数设置如下<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb &#x2F;usr&#x2F;local&#x2F;sbin&#x2F;glusterfs</span><br><span class="line">set args  --acl --process-name fuse --volfile-server&#x3D;10.193.189.153 --volfile-id&#x3D;rep3_vol &#x2F;mnt&#x2F;rep3_vol</span><br><span class="line">(gdb) set print pretty on</span><br><span class="line">(gdb) br main</span><br><span class="line">(gdb) br create_fuse_mount</span><br></pre></td></tr></table></figure></li>
<li>3.当断点执行到create_fuse_mount，该函数通过xlator_init加载mount/fuse的translor。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) </span><br><span class="line">Detaching after fork from child process 37741.</span><br><span class="line">Breakpoint 3, create_fuse_mount (ctx&#x3D;0x63e010) at glusterfsd.c:719</span><br><span class="line">&#x2F;&#x2F;中间过程</span><br><span class="line">(gdb) </span><br><span class="line">Detaching after fork from child process 39472.</span><br><span class="line">770         if (ret) &#123;</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure></li>
<li>4.等create_fuse_mount执行完毕以后，需要设置调试进程的模式,这样不至于进程一致停留在父进程中，子进程是需要和调试参数中设置的ip的节点通信，获取相关的bricks信息和客户端需要加载的translator<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Detaching after fork from child process 39472.</span><br><span class="line">770         if (ret) &#123;&#x2F;&#x2F;&#125;</span><br><span class="line">(gdb) set follow-fork-mode child </span><br><span class="line">(gdb)  set detach-on-fork off</span><br><span class="line">(gdb) </span><br><span class="line">main (argc&#x3D;7, argv&#x3D;0x7fffffffe368) at glusterfsd.c:2875</span><br><span class="line">2875        if (ret)</span><br><span class="line">(gdb) </span><br><span class="line">2878        ret &#x3D; daemonize(ctx);</span><br><span class="line">(gdb) </span><br><span class="line">[New process 39570]</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;&#x2F;lib64&#x2F;libthread_db.so.1&quot;.</span><br><span class="line">[New Thread 0x7fffeee4d700 (LWP 39573)]</span><br><span class="line">[New Thread 0x7fffee64c700 (LWP 39574)]</span><br><span class="line">[Switching to Thread 0x7ffff7fe74c0 (LWP 39570)]</span><br><span class="line">main (argc&#x3D;7, argv&#x3D;0x7fffffffe368) at glusterfsd.c:2879</span><br><span class="line">2879        if (ret)</span><br><span class="line">Missing separate debuginfos, use: debuginfo-install glibc-2.17-260.el7_6.3.x86_64 libuuid-2.23.2-59.el7.x86_64 openssl-libs-1.0.2k-16.el7.x86_64 zlib-1.2.7-18.el7.x86_64</span><br><span class="line">(gdb) </span><br><span class="line">2887        mem_pools_init();</span><br><span class="line">(gdb)   </span><br><span class="line"></span><br><span class="line">(gdb) set print elements 0</span><br><span class="line">(gdb) show print elements</span><br></pre></td></tr></table></figure></li>
<li>5.在子进程设置glusterfs客户端执行逻辑的函数,通过rpc请求，向服务端glusterd拉取bricks元数据和客户端需要加载的translator的信息<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) mgmt_getspec_cbk  </span><br><span class="line">(gdb) glusterfs_volfile_fetch_one</span><br><span class="line">(gdb) glusterfs_volfile_fetch </span><br><span class="line">(gdb) glusterfs_mgmt_init</span><br><span class="line">(gdb) glusterfs_volumes_init</span><br><span class="line">(gdb) glusterfs_process_volfp</span><br><span class="line">(gdb) glusterfs_graph_construct</span><br></pre></td></tr></table></figure>
<h4 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h4></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">volume rep3_vol-client-0</span><br><span class="line">    type protocol&#x2F;client</span><br><span class="line">    option send-gids true</span><br><span class="line">    option transport.socket.keepalive-count 9</span><br><span class="line">    option transport.socket.keepalive-interval 2</span><br><span class="line">    option transport.socket.keepalive-time 20</span><br><span class="line">    option transport.tcp-user-timeout 0</span><br><span class="line">    option transport.socket.ssl-enabled off</span><br><span class="line">    option password 7e9a1877-0837-4563-b73d-aa4cde754c91</span><br><span class="line">    option username bdb0a45d-e70d-445d-8fe6-76118dfdb738</span><br><span class="line">    option transport.address-family inet</span><br><span class="line">    option transport-type tcp</span><br><span class="line">    option remote-subvolume &#x2F;debug&#x2F;glusterfs&#x2F;rep3_vol&#x2F;brick</span><br><span class="line">    option remote-host 10.193.189.153</span><br><span class="line">    option ping-timeout 42</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-client-1</span><br><span class="line">    type protocol&#x2F;client</span><br><span class="line">    option send-gids true</span><br><span class="line">    option transport.socket.keepalive-count 9</span><br><span class="line">    option transport.socket.keepalive-interval 2</span><br><span class="line">    option transport.socket.keepalive-time 20</span><br><span class="line">    option transport.tcp-user-timeout 0</span><br><span class="line">    option transport.socket.ssl-enabled off</span><br><span class="line">    option password 7e9a1877-0837-4563-b73d-aa4cde754c91</span><br><span class="line">    option username bdb0a45d-e70d-445d-8fe6-76118dfdb738</span><br><span class="line">    option transport.address-family inet</span><br><span class="line">    option transport-type tcp</span><br><span class="line">    option remote-subvolume &#x2F;debug&#x2F;glusterfs&#x2F;rep3_vol&#x2F;brick</span><br><span class="line">    option remote-host 10.193.189.154</span><br><span class="line">    option ping-timeout 42</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-client-2</span><br><span class="line">    type protocol&#x2F;client</span><br><span class="line">    option send-gids true</span><br><span class="line">    option transport.socket.keepalive-count 9</span><br><span class="line">    option transport.socket.keepalive-interval 2</span><br><span class="line">    option transport.socket.keepalive-time 20</span><br><span class="line">    option transport.tcp-user-timeout 0</span><br><span class="line">    option transport.socket.ssl-enabled off</span><br><span class="line">    option password 7e9a1877-0837-4563-b73d-aa4cde754c91</span><br><span class="line">    option username bdb0a45d-e70d-445d-8fe6-76118dfdb738</span><br><span class="line">    option transport.address-family inet</span><br><span class="line">    option transport-type tcp</span><br><span class="line">    option remote-subvolume &#x2F;debug&#x2F;glusterfs&#x2F;rep3_vol&#x2F;brick</span><br><span class="line">    option remote-host 10.193.189.155</span><br><span class="line">    option ping-timeout 42</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-replicate-0</span><br><span class="line">    type cluster&#x2F;replicate</span><br><span class="line">    option use-compound-fops off</span><br><span class="line">    option afr-pending-xattr rep3_vol-client-0,rep3_vol-client-1,rep3_vol-client-2</span><br><span class="line">    subvolumes rep3_vol-client-0 rep3_vol-client-1 rep3_vol-client-2</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-dht</span><br><span class="line">    type cluster&#x2F;distribute</span><br><span class="line">    option force-migration off</span><br><span class="line">    option lock-migration off</span><br><span class="line">    subvolumes rep3_vol-replicate-0</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-utime</span><br><span class="line">    type features&#x2F;utime</span><br><span class="line">    option noatime on</span><br><span class="line">    subvolumes rep3_vol-dht</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-write-behind</span><br><span class="line">    type performance&#x2F;write-behind</span><br><span class="line">    subvolumes rep3_vol-utime</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-read-ahead</span><br><span class="line">    type performance&#x2F;read-ahead</span><br><span class="line">    subvolumes rep3_vol-write-behind</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-readdir-ahead</span><br><span class="line">    type performance&#x2F;readdir-ahead</span><br><span class="line">    option rda-cache-limit 10MB</span><br><span class="line">    option rda-request-size 131072</span><br><span class="line">    option parallel-readdir off</span><br><span class="line">    subvolumes rep3_vol-read-ahead</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-io-cache</span><br><span class="line">    type performance&#x2F;io-cache</span><br><span class="line">    subvolumes rep3_vol-readdir-ahead</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-open-behind</span><br><span class="line">    type performance&#x2F;open-behind</span><br><span class="line">    subvolumes rep3_vol-io-cache</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-quick-read</span><br><span class="line">    type performance&#x2F;quick-read</span><br><span class="line">    subvolumes rep3_vol-open-behind</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol-md-cache</span><br><span class="line">    type performance&#x2F;md-cache</span><br><span class="line">    subvolumes rep3_vol-quick-read</span><br><span class="line">end-volume</span><br><span class="line"></span><br><span class="line">volume rep3_vol</span><br><span class="line">    type debug&#x2F;io-stats</span><br><span class="line">    option global-threading off</span><br><span class="line">    option count-fop-hits off</span><br><span class="line">    option latency-measurement off</span><br><span class="line">    option threads 16</span><br><span class="line">    option log-level DEBUG</span><br><span class="line">    subvolumes rep3_vol-md-cache</span><br><span class="line">end-volume</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/14/OpenCAS-%E6%B6%88%E8%80%97%E8%BF%87%E5%A4%9A%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/14/OpenCAS-%E6%B6%88%E8%80%97%E8%BF%87%E5%A4%9A%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">OpenCAS 消耗过多内存问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-14 16:09:40 / Modified: 16:30:32" itemprop="dateCreated datePublished" datetime="2020-05-14T16:09:40+08:00">2020-05-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="OpenCase-内存耗尽的问题"><a href="#OpenCase-内存耗尽的问题" class="headerlink" title="OpenCase 内存耗尽的问题"></a>OpenCase 内存耗尽的问题</h2><h3 id="1-现象"><a href="#1-现象" class="headerlink" title="1.现象"></a>1.现象</h3><ul>
<li>使用3.5T  SSD 初始化opencas初始化，宿主机内存为120G，初始化成功后，运行一段时间出现内存全部消耗完。</li>
</ul>
<h3 id="2-opencas-版本信息"><a href="#2-opencas-版本信息" class="headerlink" title="2.opencas 版本信息"></a>2.opencas 版本信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">opencas version:19.9</span><br><span class="line">Linux kernel: 3.10.0-957.el7.x86_64</span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br></pre></td></tr></table></figure>

<h3 id="3-opencas-出问题时候日志"><a href="#3-opencas-出问题时候日志" class="headerlink" title="3.opencas 出问题时候日志"></a>3.opencas 出问题时候日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">use command:  grep vmalloc &#x2F;proc&#x2F;vmallocinfo |grep cas_cache</span><br><span class="line">0xffffae2a4dffe000-0xffffae2a4e000000    8192 ocf_metadata_hash_ctrl_init+0x23&#x2F;0xe0 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebb2000-0xffffae2a4ebb4000    8192 ocf_metadata_hash_ctrl_init+0x23&#x2F;0xe0 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebb4000-0xffffae2a4ebb6000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebb6000-0xffffae2a4ebb8000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebb8000-0xffffae2a4ebc5000   53248 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;12 vmalloc N0&#x3D;12</span><br><span class="line">0xffffae2a4ebc5000-0xffffae2a4ebc7000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebc7000-0xffffae2a4ebd1000   40960 raw_dynamic_init+0x38&#x2F;0x90 [cas_cache] pages&#x3D;9 vmalloc N0&#x3D;9</span><br><span class="line">0xffffae2a4ebd1000-0xffffae2a4ebd3000    8192 _cache_mngt_cache_priv_init+0x2e&#x2F;0x60 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ebf1000-0xffffae2a4ebf3000    8192 _ocf_mngt_attach_cache_device+0x23&#x2F;0x1b0 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4ebf3000-0xffffae2a4ebf5000    8192 ocf_volume_init+0x99&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4ebfc000-0xffffae2a4ebfe000    8192 ocf_freelist_init+0x25&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4ebfe000-0xffffae2a4ec00000    8192 ocf_freelist_init+0x64&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4edda000-0xffffae2a4edfb000  135168 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;32 vmalloc N0&#x3D;32</span><br><span class="line">0xffffae2a4edfb000-0xffffae2a4edfd000    8192 ocf_freelist_init+0x74&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4edfe000-0xffffae2a4ee00000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4ef01000-0xffffae2a4ef7b000  499712 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;121 vmalloc N0&#x3D;121</span><br><span class="line">0xffffae2a4ef7b000-0xffffae2a4ef87000   49152 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;11 vmalloc N1&#x3D;11</span><br><span class="line">0xffffae2a4ef87000-0xffffae2a4ef8f000   32768 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;7 vmalloc N1&#x3D;7</span><br><span class="line">0xffffae2a4ef8f000-0xffffae2a4ef9b000   49152 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;11 vmalloc N1&#x3D;11</span><br><span class="line">0xffffae2a4ef9b000-0xffffae2a4efab000   65536 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;15 vmalloc N1&#x3D;15</span><br><span class="line">0xffffae2a4efab000-0xffffae2a4efb9000   57344 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;13 vmalloc N1&#x3D;13</span><br><span class="line">0xffffae2a4efbe000-0xffffae2a4efc0000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4efc0000-0xffffae2a4efe1000  135168 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;32 vmalloc N0&#x3D;32</span><br><span class="line">0xffffae2a4efe1000-0xffffae2a4efee000   53248 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;12 vmalloc N0&#x3D;12</span><br><span class="line">0xffffae2a4efee000-0xffffae2a4eff0000    8192 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4eff0000-0xffffae2a4effa000   40960 raw_dynamic_init+0x38&#x2F;0x90 [cas_cache] pages&#x3D;9 vmalloc N0&#x3D;9</span><br><span class="line">0xffffae2a4effa000-0xffffae2a4effc000    8192 _cache_mngt_cache_priv_init+0x2e&#x2F;0x60 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f101000-0xffffae2a4f17b000  499712 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;121 vmalloc N0&#x3D;121</span><br><span class="line">0xffffae2a4f17b000-0xffffae2a4f17d000    8192 _ocf_mngt_attach_cache_device+0x23&#x2F;0x1b0 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f17d000-0xffffae2a4f17f000    8192 ocf_volume_init+0x99&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f17f000-0xffffae2a4f18b000   49152 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;11 vmalloc N0&#x3D;11</span><br><span class="line">0xffffae2a4f192000-0xffffae2a4f19a000   32768 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;7 vmalloc N0&#x3D;7</span><br><span class="line">0xffffae2a4f19a000-0xffffae2a4f1a6000   49152 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;11 vmalloc N0&#x3D;11</span><br><span class="line">0xffffae2a4f1a6000-0xffffae2a4f1b6000   65536 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;15 vmalloc N0&#x3D;15</span><br><span class="line">0xffffae2a4f1b6000-0xffffae2a4f1c4000   57344 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;13 vmalloc N0&#x3D;13</span><br><span class="line">0xffffae2a4f1c4000-0xffffae2a4f1c6000    8192 ocf_freelist_init+0x25&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f1c6000-0xffffae2a4f1c8000    8192 ocf_freelist_init+0x64&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f1c8000-0xffffae2a4f1ca000    8192 ocf_freelist_init+0x74&#x2F;0x100 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f1ca000-0xffffae2a4f1d4000   40960 ocf_cache_line_concurrency_init+0x48&#x2F;0x190 [cas_cache] pages&#x3D;9 vmalloc N0&#x3D;9</span><br><span class="line">0xffffae2a4f1d4000-0xffffae2a4f1d9000   20480 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;4 vmalloc N0&#x3D;4</span><br><span class="line">0xffffae2a4f1d9000-0xffffae2a4f1de000   20480 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;4 vmalloc N1&#x3D;4</span><br><span class="line">0xffffae2a4f1df000-0xffffae2a4f1e1000    8192 ocf_promotion_init+0x2e&#x2F;0xc0 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f1e5000-0xffffae2a4f1ef000   40960 ocf_cache_line_concurrency_init+0x48&#x2F;0x190 [cas_cache] pages&#x3D;9 vmalloc N1&#x3D;9</span><br><span class="line">0xffffae2a4f1f5000-0xffffae2a4f1f7000    8192 ocf_promotion_init+0x2e&#x2F;0xc0 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4f301000-0xffffae2a4f34b000  303104 ocf_metadata_concurrency_attached_init+0x57&#x2F;0x190 [cas_cache] pages&#x3D;73 vmalloc N0&#x3D;73</span><br><span class="line">0xffffae2a4f34b000-0xffffae2a4f395000  303104 ocf_metadata_concurrency_attached_init+0x57&#x2F;0x190 [cas_cache] pages&#x3D;73 vmalloc N1&#x3D;73</span><br><span class="line">0xffffae2a4f503000-0xffffae2a4f505000    8192 _raw_dynamic_get_item.isra.10+0xbc&#x2F;0x160 [cas_cache] pages&#x3D;1 vmalloc N0&#x3D;1</span><br><span class="line">0xffffae2a4f5fa000-0xffffae2a4f5fc000    8192 _raw_dynamic_get_item.isra.10+0xbc&#x2F;0x160 [cas_cache] pages&#x3D;1 vmalloc N1&#x3D;1</span><br><span class="line">0xffffae2a4fe90000-0xffffae2a4ff9a000 1089536 ocf_mngt_cache_start+0x1b0&#x2F;0x7a0 [cas_cache] pages&#x3D;265 vmalloc N0&#x3D;265</span><br><span class="line">0xffffae2a50b02000-0xffffae2a50c28000 1204224 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;293 vmalloc N0&#x3D;293</span><br><span class="line">0xffffae2a50c28000-0xffffae2a50d32000 1089536 ocf_mngt_cache_start+0x1b0&#x2F;0x7a0 [cas_cache] pages&#x3D;265 vmalloc N0&#x3D;265</span><br><span class="line">0xffffae2a50d32000-0xffffae2a50e58000 1204224 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;293 vmalloc N0&#x3D;293</span><br><span class="line">0xffffae2a50e58000-0xffffae2a52313000 21737472 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;5306 vmalloc vpages N0&#x3D;5306</span><br><span class="line">0xffffae2a52313000-0xffffae2a530e2000 14479360 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;3534 vmalloc vpages N0&#x3D;3534</span><br><span class="line">0xffffae2a530e2000-0xffffae2a5459d000 21737472 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;5306 vmalloc vpages N0&#x3D;5306</span><br><span class="line">0xffffae2a5459d000-0xffffae2a56311000 30883840 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;7539 vmalloc vpages N0&#x3D;7539</span><br><span class="line">0xffffae2a56311000-0xffffae2a564cc000 1814528 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;442 vmalloc N0&#x3D;442</span><br><span class="line">0xffffae2a564cc000-0xffffae2a57cf6000 25337856 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;6185 vmalloc vpages N0&#x3D;6185</span><br><span class="line">0xffffae2a57cf6000-0xffffae2a58cf8000 16785408 ocf_cache_line_concurrency_init+0x48&#x2F;0x190 [cas_cache] pages&#x3D;4097 vmalloc vpages N0&#x3D;4097</span><br><span class="line">0xffffae2a58cf8000-0xffffae2a593e0000 7241728 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;1767 vmalloc vpages N0&#x3D;1767</span><br><span class="line">0xffffae2a5c278000-0xffffae2a5d733000 21737472 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;5306 vmalloc vpages N1&#x3D;5306</span><br><span class="line">0xffffae2a5d733000-0xffffae2a5e502000 14479360 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;3534 vmalloc vpages N1&#x3D;3534</span><br><span class="line">0xffffae2a5e502000-0xffffae2a5f9bd000 21737472 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;5306 vmalloc vpages N1&#x3D;5306</span><br><span class="line">0xffffae2a5f9bd000-0xffffae2a5fb78000 1814528 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;442 vmalloc N1&#x3D;442</span><br><span class="line">0xffffae2a70001000-0xffffae2d073a0000 11127091200 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;2716574 vmalloc vpages N0&#x3D;2716574</span><br><span class="line">0xffffae2d073a0000-0xffffae2ec0f22000 7410819072 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1809281 vmalloc vpages N0&#x3D;1809281</span><br><span class="line">0xffffae2ec0f22000-0xffffae31582c1000 11127091200 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;2716574 vmalloc vpages N0&#x3D;2716574</span><br><span class="line">0xffffae31582c1000-0xffffae3506818000 15809736704 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;3859798 vmalloc vpages N0&#x3D;3859798</span><br><span class="line">0xffffae3506818000-0xffffae353db8a000 926359552 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;226161 vmalloc vpages N0&#x3D;226161</span><br><span class="line">0xffffae353db8a000-0xffffae3842bac000 12968927232 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;3166241 vmalloc vpages N0&#x3D;3166241</span><br><span class="line">0xffffae3842bac000-0xffffae384bcc2000 152133632 ocf_metadata_concurrency_attached_init+0x57&#x2F;0x190 [cas_cache] pages&#x3D;37141 vmalloc vpages N0&#x3D;37141</span><br><span class="line">0xffffae384bcc2000-0xffffae3928a84000 3705413632 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;904641 vmalloc vpages N0&#x3D;904641</span><br><span class="line">0xffffae3928a84000-0xffffae3bbfe23000 11127091200 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;2716574 vmalloc vpages N1&#x3D;2716574</span><br><span class="line">0xffffae3bbfe23000-0xffffae3d799a5000 7410819072 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;1809281 vmalloc vpages N1&#x3D;1809281</span><br><span class="line">0xffffae3d799a5000-0xffffae4010d44000 11127091200 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;2716574 vmalloc vpages N1&#x3D;2716574</span><br><span class="line">0xffffae4010d44000-0xffffae43bf29b000 15809736704 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;3859798 vmalloc vpages N1&#x3D;3859798</span><br><span class="line">0xffffae43bf29b000-0xffffae43c100f000 30883840 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;7539 vmalloc vpages N1&#x3D;7539</span><br><span class="line">0xffffae43c100f000-0xffffae43f8381000 926359552 _raw_ram_init+0x2d&#x2F;0x70 [cas_cache] pages&#x3D;226161 vmalloc vpages N1&#x3D;226161</span><br><span class="line">0xffffae43f8381000-0xffffae46fd3a3000 12968927232 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;3166241 vmalloc vpages N1&#x3D;3166241</span><br><span class="line">0xffffae46fd3a3000-0xffffae46febcd000 25337856 ocf_metadata_concurrency_attached_init+0x3c&#x2F;0x190 [cas_cache] pages&#x3D;6185 vmalloc vpages N1&#x3D;6185</span><br><span class="line">0xffffae46febcd000-0xffffae4707ce3000 152133632 ocf_metadata_concurrency_attached_init+0x57&#x2F;0x190 [cas_cache] pages&#x3D;37141 vmalloc vpages N1&#x3D;37141</span><br><span class="line">0xffffae4707ce3000-0xffffae4708ce5000 16785408 ocf_cache_line_concurrency_init+0x48&#x2F;0x190 [cas_cache] pages&#x3D;4097 vmalloc vpages N1&#x3D;4097</span><br><span class="line">0xffffae4708ce5000-0xffffae47e5aa7000 3705413632 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;904641 vmalloc vpages N1&#x3D;904641</span><br><span class="line">0xffffae47e5aa7000-0xffffae47e618f000 7241728 _ocf_realloc_with_cp+0x158&#x2F;0x1b0 [cas_cache] pages&#x3D;1767 vmalloc vpages N1&#x3D;1767</span><br><span class="line">0xffffae47e6eb3000-0xffffae47e6eec000  233472 cleaning_policy_acp_initialize+0x3e&#x2F;0x330 [cas_cache] pages&#x3D;56 vmalloc N1&#x3D;56</span><br><span class="line">0xffffae47e6eec000-0xffffae47e6ef3000   28672 cleaning_policy_acp_add_core+0x7c&#x2F;0x160 [cas_cache] pages&#x3D;6 vmalloc N1&#x3D;6</span><br><span class="line">0xffffae47e712a000-0xffffae47e7163000  233472 cleaning_policy_acp_initialize+0x3e&#x2F;0x330 [cas_cache] pages&#x3D;56 vmalloc N1&#x3D;56</span><br><span class="line">0xffffae47e7163000-0xffffae47e7169000   24576 cleaning_policy_acp_add_core+0x7c&#x2F;0x160 [cas_cache] pages&#x3D;5 vmalloc N1&#x3D;5</span><br><span class="line">0xffffae47e7692000-0xffffae47e8238000 12214272 cleaning_policy_acp_add_core+0x7c&#x2F;0x160 [cas_cache] pages&#x3D;2981 vmalloc vpages N1&#x3D;2981</span><br><span class="line">0xffffae47e8238000-0xffffae47e8af5000 9162752 cleaning_policy_acp_add_core+0x7c&#x2F;0x160 [cas_cache] pages&#x3D;2236 vmalloc vpages N1&#x3D;2236</span><br><span class="line"></span><br><span class="line">use command grep vmalloc &#x2F;proc&#x2F;vmallocinfo |grep cas_cache | awk &#39;&#123;total+&#x3D;$2&#125;; END &#123;print total&#125;&#39;</span><br><span class="line">126764556288 </span><br><span class="line">[root@szdpl1491 ~]# free -h</span><br><span class="line">              total        used        free      shared  buff&#x2F;cache   available</span><br><span class="line">Mem:           125G        123G        967M        5.1M        864M        194M</span><br><span class="line">Swap:           31G        7.9G         24G</span><br><span class="line"> </span><br><span class="line">the cas_cache use 118G,  I have  another sever with opencas for 1 month, the cas_cache use 59G</span><br></pre></td></tr></table></figure>
<h3 id="3-opencas-相关配置"><a href="#3-opencas-相关配置" class="headerlink" title="3.opencas 相关配置"></a>3.opencas 相关配置</h3><ul>
<li><p>cache mode: WT</p>
</li>
<li><p>cache config</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">casadm -L</span><br><span class="line"></span><br><span class="line">type    id   disk       status    write policy   device</span><br><span class="line">cache   1    &#x2F;dev&#x2F;sda   Running   wt             -</span><br><span class="line">└core   1    &#x2F;dev&#x2F;sdd   Active    -              &#x2F;dev&#x2F;cas1-1</span><br><span class="line">cache   2    &#x2F;dev&#x2F;sdb   Running   wt             -</span><br><span class="line">└core   1    &#x2F;dev&#x2F;sde   Active    -              &#x2F;dev&#x2F;cas2-1</span><br><span class="line">casadm -P -i 1</span><br><span class="line"></span><br><span class="line">Cache Id                  1</span><br><span class="line">Cache Size                926351414 [4KiB Blocks] &#x2F; 3533.75 [GiB]</span><br><span class="line">Cache Device              &#x2F;dev&#x2F;sda</span><br><span class="line">Core Devices              1</span><br><span class="line">Inactive Core Devices     0</span><br><span class="line">Write Policy              wt</span><br><span class="line">Eviction Policy           lru</span><br><span class="line">Cleaning Policy           alru</span><br><span class="line">Promotion Policy          always</span><br><span class="line">Cache line size           4 [KiB]</span><br><span class="line">Metadata Memory Footprint 46.7 [GiB]</span><br><span class="line">Dirty for                 0 [s] &#x2F; Cache clean</span><br><span class="line">Metadata Mode             normal</span><br><span class="line">Status                    Running</span><br><span class="line"></span><br><span class="line">╔══════════════════╤═══════════╤══════╤═════════════╗</span><br><span class="line">║ Usage statistics │   Count   │  %   │   Units     ║</span><br><span class="line">╠══════════════════╪═══════════╪══════╪═════════════╣</span><br><span class="line">║ Occupancy        │ 500156640 │ 54.0 │ 4KiB blocks ║</span><br><span class="line">║ Free             │ 426194774 │ 46.0 │ 4KiB blocks ║</span><br><span class="line">║ Clean            │ 500156640 │ 54.0 │ 4KiB blocks ║</span><br><span class="line">║ Dirty            │         0 │  0.0 │ 4KiB blocks ║</span><br><span class="line">╚══════════════════╧═══════════╧══════╧═════════════╝</span><br><span class="line"></span><br><span class="line">╔══════════════════════╤════════════╤═══════╤══════════╗</span><br><span class="line">║ Request statistics   │   Count    │   %   │ Units    ║</span><br><span class="line">╠══════════════════════╪════════════╪═══════╪══════════╣</span><br><span class="line">║ Read hits            │ 2628479218 │  61.6 │ Requests ║</span><br><span class="line">║ Read partial misses  │          0 │   0.0 │ Requests ║</span><br><span class="line">║ Read full misses     │         64 │   0.0 │ Requests ║</span><br><span class="line">║ Read total           │ 2628479282 │  61.6 │ Requests ║</span><br><span class="line">╟──────────────────────┼────────────┼───────┼──────────╢</span><br><span class="line">║ Write hits           │ 1579075690 │  37.0 │ Requests ║</span><br><span class="line">║ Write partial misses │    4237509 │   0.1 │ Requests ║</span><br><span class="line">║ Write full misses    │   58309934 │   1.4 │ Requests ║</span><br><span class="line">║ Write total          │ 1641623133 │  38.4 │ Requests ║</span><br><span class="line">╟──────────────────────┼────────────┼───────┼──────────╢</span><br><span class="line">║ Pass-Through reads   │          0 │   0.0 │ Requests ║</span><br><span class="line">║ Pass-Through writes  │          0 │   0.0 │ Requests ║</span><br><span class="line">║ Serviced requests    │ 4270102415 │ 100.0 │ Requests ║</span><br><span class="line">╟──────────────────────┼────────────┼───────┼──────────╢</span><br><span class="line">║ Total requests       │ 4270102415 │ 100.0 │ Requests ║</span><br><span class="line">╚══════════════════════╧════════════╧═══════╧══════════╝</span><br><span class="line"></span><br><span class="line">╔══════════════════════════════════╤═════════════╤═══════╤═════════════╗</span><br><span class="line">║ Block statistics                 │    Count    │   %   │   Units     ║</span><br><span class="line">╠══════════════════════════════════╪═════════════╪═══════╪═════════════╣</span><br><span class="line">║ Reads from core(s)               │         356 │   0.0 │ 4KiB blocks ║</span><br><span class="line">║ Writes to core(s)                │  2954907028 │ 100.0 │ 4KiB blocks ║</span><br><span class="line">║ Total to&#x2F;from core(s)            │  2954907384 │ 100.0 │ 4KiB blocks ║</span><br><span class="line">╟──────────────────────────────────┼─────────────┼───────┼─────────────╢</span><br><span class="line">║ Reads from cache                 │           0 │   0.0 │ 4KiB blocks ║</span><br><span class="line">║ Writes to cache                  │           0 │   0.0 │ 4KiB blocks ║</span><br><span class="line">║ Total to&#x2F;from cache              │           0 │   0.0 │ 4KiB blocks ║</span><br><span class="line">╟──────────────────────────────────┼─────────────┼───────┼─────────────╢</span><br><span class="line">║ Reads from exported object(s)    │ 12708231250 │  81.1 │ 4KiB blocks ║</span><br><span class="line">║ Writes to exported object(s)     │  2954907028 │  18.9 │ 4KiB blocks ║</span><br><span class="line">║ Total to&#x2F;from exported object(s) │ 15663138278 │ 100.0 │ 4KiB blocks ║</span><br><span class="line">╚══════════════════════════════════╧═════════════╧═══════╧═════════════╝</span><br><span class="line"></span><br><span class="line">╔════════════════════╤═══════╤═════╤══════════╗</span><br><span class="line">║ Error statistics   │ Count │  %  │ Units    ║</span><br><span class="line">╠════════════════════╪═══════╪═════╪══════════╣</span><br><span class="line">║ Cache read errors  │     0 │ 0.0 │ Requests ║</span><br><span class="line">║ Cache write errors │     0 │ 0.0 │ Requests ║</span><br><span class="line">║ Cache total errors │     0 │ 0.0 │ Requests ║</span><br><span class="line">╟────────────────────┼───────┼─────┼──────────╢</span><br><span class="line">║ Core read errors   │     0 │ 0.0 │ Requests ║</span><br><span class="line">║ Core write errors  │     0 │ 0.0 │ Requests ║</span><br><span class="line">║ Core total errors  │     0 │ 0.0 │ Requests ║</span><br><span class="line">╟────────────────────┼───────┼─────┼──────────╢</span><br><span class="line">║ Total errors       │     0 │ 0.0 │ Requests ║</span><br><span class="line">╚════════════════════╧═══════╧═════╧══════════╝</span><br></pre></td></tr></table></figure>
</li>
<li><p>cache line size</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># dmesg |grep &quot;Cache line size&quot;</span><br><span class="line">2751 [ 1505.783016] cache1: Hash offset : 44427904 kiB</span><br><span class="line">2752 [ 1505.783017] cache1: Hash size : 904644 kiB</span><br><span class="line">2753 [ 1505.783018] cache1: Cache line size: 4 kiB</span><br><span class="line">2754 [ 1505.783019] cache1: Metadata capacity: 47803 MiB</span><br><span class="line">2755 [ 1521.649327] cache1: OCF metadata self-test PASSED</span><br><span class="line">2756 [ 1527.389763] Thread cas_clean_cache1 started</span><br><span class="line"></span><br><span class="line">2893 [ 1823.699193] cache2: Hash offset : 44427904 kiB</span><br><span class="line">2894 [ 1823.699194] cache2: Hash size : 904644 kiB</span><br><span class="line">2895 [ 1823.699195] cache2: Cache line size: 4 kiB</span><br><span class="line">2896 [ 1823.699197] cache2: Metadata capacity: 47803 MiB</span><br><span class="line">2897 [ 1839.660385] cache2: OCF metadata self-test PASSED</span><br><span class="line">2898 [ 1845.359600] Thread cas_clean_cache2 started</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="5-解决方法"><a href="#5-解决方法" class="headerlink" title="5.解决方法"></a>5.解决方法</h3><ul>
<li>opencas在初始化时候casadm 需要添加–cache-line-size  参数，默认是4k，针对宿主机器消耗内存的计算公式为 内存消耗 =  SSD_size / Cache_Line_size  * 70 byte</li>
<li>官方给的简要说明<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">It looks quite normal to me. You have two huge cache devices (2 x 3.5TB) and size of CAS metadata is proportional to number of cache lines. CAS allocates about 70 bytes of metadata per cache line, so in your case it is about 60GiB of metadata per single cache, giving ~120GiB in total. That matches pretty well with your numbers.</span><br><span class="line"></span><br><span class="line">You can decrease memory consumption by choosing bigger cache line size. You can select cache line size up to 64kiB, which would decrease memory usage by factor of 16.</span><br><span class="line"></span><br><span class="line">I&#39;d also recommend you, if it&#39;s possible, to switch to CAS v20.3.</span><br><span class="line">CAS v19.9 was tested only with basic set of tests, while v20.3 was thoroughly validated with extensive set of tests, thus it&#39;s much more stable than any previous version.</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="6-关于opencas-cache-line官方说明"><a href="#6-关于opencas-cache-line官方说明" class="headerlink" title="6.关于opencas cache line官方说明"></a>6.关于opencas cache line官方说明</h3><p><strong>Why does Open CAS Linux use some DRAM space?</strong></p>
<p>Open CAS Linux uses a portion of system memory for metadata, which tells us where data resides. The amount of memory needed is proportional to the size of the cache space. This is true for any caching software solution. However with Open CAS Linux this memory footprint can be decreased using a larger cache line size set by the parameter <em>–cache-line-size</em> which may be useful in high density servers with many large HDDs.</p>
<p><strong>Configuration Tool Details</strong></p>
<p>The Open CAS Linux product includes a user-level configuration tool that provides complete control of the caching software. The commands and parameters available with this tool are detailed in this chapter.</p>
<p>To access help from the CLI, type the <em>-H</em> or -<em>-help</em> parameter for details. You can also view the man page for this product by entering the following command:</p>
<blockquote>
<p># man casadm</p>
</blockquote>
<p><strong>Usage:</strong> casadm –start-cache –cache-device <DEVICE> [option…]</DEVICE></p>
<p><strong>Example:</strong></p>
<blockquote>
<p># casadm –start-cache –cache-device /dev/sdc</p>
</blockquote>
<p>or</p>
<blockquote>
<p># casadm -S -d /dev/sdc</p>
</blockquote>
<p><strong>Description:</strong> Prepares a block device to be used as device for caching other block devices. Typically the cache devices are SSDs or other NVM block devices or RAM disks. The process starts a framework for device mappings pertaining to a specific cache ID. The cache can be loaded with an old state when using the <em>-l</em> or <em>–load</em> parameter (previous cache metadata will not be marked as invalid) or with a new state as the default (previous cache metadata will be marked as invalid).</p>
<p><strong>Required Parameters:</strong></p>
<p><strong>[-d, –cache-device ] :</strong> Caching device to be used. This is an SSD or any NVM block device or RAM disk shown in the <em>/dev</em> directory. <device> needs to be the complete path describing the caching device to be used, for example /dev/sdc.</device></p>
<p><strong>Optional Parameters:</strong></p>
<p><strong>[-i, –cache-id ]:</strong> Cache ID to create; &lt;1 to 16384&gt;. The ID may be specified or by default the command will use the lowest available number first.</p>
<p><strong>[-l, –load]:</strong> Load existing cache metadata from caching device. If the cache device has been used previously and then disabled (like in a reboot) and it is determined that the data in the core device has not changed since the cache device was used, this option will allow continuing the use of the data in the cache device without the need to re-warm the cache with data.</p>
<ul>
<li><em>Caution:</em> You must ensure that the last shutdown followed the instructions in section <a href="https://open-cas.github.io/guide_running.html#stopping-cache-instances" target="_blank" rel="noopener"><strong>Stopping Cache Instances</strong></a>. If there was any change in the core data prior to enabling the cache, data would be not synced correctly and will be corrupted.</li>
</ul>
<p><strong>[-f, –force]:</strong> Forces creation of a cache even if a file system exists on the cache device. This is typically used for devices that have been previously utilized as a cache device.</p>
<ul>
<li><em>Caution:</em> This will delete the file system and any existing data on the cache device.</li>
</ul>
<p><strong>[-c, –cache-mode ]:</strong> Sets the cache mode for a cache instance the first time it is started or created. The mode can be one of the following:</p>
<p><em>wt:</em> (default mode) Turns write-through mode on. When using this parameter, the write-through feature is enabled which allows the acceleration of only read intensive operations.</p>
<p><em>wb:</em> Turns write-back mode on. When using this parameter, the write-back feature is enabled which allows the acceleration of both read and write intensive operations.</p>
<ul>
<li><em>Caution:</em> A failure of the cache device may lead to the loss of data that has not yet been flushed to the core device.</li>
</ul>
<p><em>wa:</em> Turns write-around mode on. When using this parameter, the write-around feature is enabled which allows the acceleration of reads only. All write locations that do not already exist in the cache (i.e. the locations have not be read yet or have been evicted), are written directly to the core drive bypassing the cache. If the location being written already exists in cache, then both the cache and the core drive will be updated.</p>
<p><em>pt:</em> Starts cache in pass-through mode. Caching is effectively disabled in this mode. This allows the user to associate all their desired core devices to be cached prior to actually enabling caching. Once the core devices are associated, the user would dynamically switch to their desired caching mode (see ‘-Q | –set-cache-mode’ for details).</p>
<p><em>wo:</em> Turns write-only mode on. When using this parameter, the write-only feature is enabled which allows the acceleration of write intensive operations primarily.</p>
<ul>
<li><em>Caution:</em> A failure of the cache device may lead to the loss of data that has not yet been flushed to the core device.</li>
</ul>
<p><strong>[-x, –cache-line-size ]:</strong> Set cache line size {4 (default), 8, 16, 32, 64}. The cache line size can only be set when starting the cache and cannot be changed after cache is started.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/05/lustre-2-13%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/05/lustre-2-13%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">lustre-2.13部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-05 13:53:58 / Modified: 15:16:23" itemprop="dateCreated datePublished" datetime="2020-05-05T13:53:58+08:00">2020-05-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="chapter-1-lustre部署"><a href="#chapter-1-lustre部署" class="headerlink" title="chapter 1.lustre部署"></a>chapter 1.lustre部署</h2><h3 id="0-节点信息"><a href="#0-节点信息" class="headerlink" title="0.节点信息"></a>0.节点信息</h3><table>
<thead>
<tr>
<th>node</th>
<th>role</th>
</tr>
</thead>
<tbody><tr>
<td>centos1(mgs_node/mds_node)</td>
<td>mgs/mds</td>
</tr>
<tr>
<td>centos2(oss_node)</td>
<td>oss</td>
</tr>
<tr>
<td>centos3(client_node)</td>
<td>client</td>
</tr>
</tbody></table>
<h3 id="1-kernel版本信息"><a href="#1-kernel版本信息" class="headerlink" title="1.kernel版本信息"></a>1.kernel版本信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS1 ~]# cat &#x2F;etc&#x2F;redhat-release </span><br><span class="line">CentOS Linux release 7.7.1908 (Core)</span><br><span class="line">[root@CentOS1 ~]# uname -r</span><br><span class="line">3.10.0-1062.el7.x86_64</span><br></pre></td></tr></table></figure>

<h3 id="2-配置离线lustre-安装包安装源"><a href="#2-配置离线lustre-安装包安装源" class="headerlink" title="2.配置离线lustre 安装包安装源"></a>2.配置离线lustre 安装包安装源</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; lustre-2.13.0 内核刚好匹配 kernel 3.10.0-1062.el7.x86_64</span><br><span class="line">[root@CentOS1 lustre]# pwd</span><br><span class="line">&#x2F;root&#x2F;lustre</span><br><span class="line">[root@CentOS1 lustre]# ls</span><br><span class="line">repo.conf</span><br><span class="line">[root@CentOS1 lustre]# cat repo.conf </span><br><span class="line">[lustre-server]</span><br><span class="line">name&#x3D;lustre-server</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;downloads.whamcloud.com&#x2F;public&#x2F;lustre&#x2F;lustre-2.13.0&#x2F;el7.7.1908&#x2F;server</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[patchless-ldiskfs-server]</span><br><span class="line">name&#x3D;patchless-ldiskfs-server</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;downloads.whamcloud.com&#x2F;public&#x2F;lustre&#x2F;lustre-2.13.0&#x2F;el7.7.1908&#x2F;patchless-ldiskfs-server</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line"></span><br><span class="line">[lustre-client]</span><br><span class="line">name&#x3D;lustre-client</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;downloads.whamcloud.com&#x2F;public&#x2F;lustre&#x2F;lustre-2.13.0&#x2F;el7.7.1908&#x2F;client</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line"></span><br><span class="line">[e2fsprogs-wc]</span><br><span class="line">name&#x3D;e2fsprogs-wc</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;downloads.whamcloud.com&#x2F;public&#x2F;e2fsprogs&#x2F;latest&#x2F;el7</span><br><span class="line">gpgcheck&#x3D;0</span><br></pre></td></tr></table></figure>

<h3 id="3-下载lustre安装包到本地"><a href="#3-下载lustre安装包到本地" class="headerlink" title="3.下载lustre安装包到本地"></a>3.下载lustre安装包到本地</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS1 ~]# cd ~&#x2F;lustre</span><br><span class="line">[root@CentOS1 ~]# yum groupinstall “Development Tools” -y</span><br><span class="line">[root@CentOS1 ~]# yum install epel-release quilt libselinux-devel python-docutils xmlto asciidoc elfutils-libelf-devel elfutils-devel zlib-devel rng-tools binutils-devel python-devel sg3_utils newt-devel perl-ExtUtils-Embed audit-libs-devel lsof hmaccalc -y</span><br><span class="line">[root@CentOS1 ~]# systemctl stop firewalld.service</span><br><span class="line">[root@CentOS1 ~]# systemctl disable firewalld.service</span><br><span class="line">[root@CentOS1 ~]# yum install  yum-utils dkms-y</span><br><span class="line">[root@CentOS1 ~]# reposync -c lustre-repo.conf -n \</span><br><span class="line">-r lustre-server \</span><br><span class="line">-r lustre-client \</span><br><span class="line">-r patchless-ldiskfs-server \</span><br><span class="line">-r e2fsprogs-wc</span><br><span class="line">[root@CentOS1 ~]# cp ~&#x2F;lustre&#x2F;repo.conf &#x2F;etc&#x2F;yum.repos.d&#x2F;lustre.repo</span><br></pre></td></tr></table></figure>

<h3 id="4-安装lustre版本kernel"><a href="#4-安装lustre版本kernel" class="headerlink" title="4.安装lustre版本kernel"></a>4.安装lustre版本kernel</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;after download all lustre package</span><br><span class="line">[root@CentOS1 lustre]# ls</span><br><span class="line">e2fsprogs-wc  lustre-client  lustre-server  patchless-ldiskfs-server  repo.conf</span><br><span class="line"></span><br><span class="line">[root@CentOS1 lustre]# cd e2fsprogs-wc&#x2F;RPMS&#x2F;x86_64&#x2F; &amp;&amp; pwd</span><br><span class="line">&#x2F;root&#x2F;lustre&#x2F;e2fsprogs-wc&#x2F;RPMS&#x2F;x86_64 &amp;&amp; yum --nogpgcheck --disablerepo&#x3D;* --enablerepo&#x3D;e2fsprogs-wc install  e2fsprogs-1.45.2.wc1-0.el7.x86_64.rpm </span><br><span class="line"></span><br><span class="line">[root@CentOS1 lustre]# cd lustre-server&#x2F;RPMS&#x2F;x86_64&#x2F; &amp;&amp; pwd </span><br><span class="line">&#x2F;root&#x2F;lustre&#x2F;lustre-server&#x2F;RPMS&#x2F;x86_64</span><br><span class="line">yum --nogpgcheck --disablerepo&#x3D;* --enablerepo&#x3D;e2fsprogs-wc install  e2fsprogs-1.45.2.wc1-0.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum --nogpgcheck --disablerepo&#x3D;* --enablerepo&#x3D;lustre-server install  kernel-devel-3.10.0-1062.1.1.el7_lustre.x86_64.rpm  kernel-headers-3.10.0-1062.1.1.el7_lustre.x86_64.rpm </span><br><span class="line">[root@CentOS1 ~] reboot</span><br></pre></td></tr></table></figure>
<h3 id="5-安装zfs"><a href="#5-安装zfs" class="headerlink" title="5.安装zfs"></a>5.安装zfs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS1 lustre]# cd lustre-server&#x2F;RPMS&#x2F;x86_64&#x2F; &amp;&amp; pwd </span><br><span class="line">&#x2F;root&#x2F;lustre&#x2F;lustre-server&#x2F;RPMS&#x2F;x86_64</span><br><span class="line"></span><br><span class="line">[root@CentOS1 x86_64]# yum --nogpgcheck --disablerepo&#x3D;* --enablerepo&#x3D;lustre-server install zfs-0.7.13-1.el7.x86_64.rpm  zfs-dkms-0.7.13-1.el7.noarch.rpm  zfs-dracut-0.7.13-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">[root@CentOS1 x86_64]# reboot</span><br><span class="line">[root@CentOS1 x86_64]# modprobe  zfs</span><br><span class="line">[root@CentOS1 x86_64]# lsmod  |grep zfs</span><br><span class="line">zfs                  3564425  3 </span><br><span class="line">zunicode              331170  1 zfs</span><br><span class="line">zavl                   15236  1 zfs</span><br><span class="line">icp                   270148  1 zfs</span><br><span class="line">zcommon                73440  1 zfs</span><br><span class="line">znvpair                89131  2 zfs,zcommon</span><br><span class="line">spl                   102412  4 icp,zfs,zcommon,znvpair</span><br></pre></td></tr></table></figure>
<h3 id="6-安装lustre-server-核心包"><a href="#6-安装lustre-server-核心包" class="headerlink" title="6.安装lustre server 核心包"></a>6.安装lustre server 核心包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS1 ~] yum --nogpgcheck --disablerepo&#x3D;*  --enablerepo&#x3D;lustre-server install kmod-lustre-2.13.0-1.el7.x86_64.rpm kmod-lustre-osd-ldiskfs-2.13.0-1.el7.x86_64.rpm lustre-2.13.0-1.el7.x86_64.rpm lustre-osd-ldiskfs-mount-2.13.0-1.el7.x86_64.rpm lustre-osd-zfs-mount-2.13.0-1.el7.x86_64.rpm lustre-resource-agents-2.13.0-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">[root@CentOS1 ~]# reboot</span><br><span class="line">[root@CentOS1 ~]# modprobe  lustre</span><br><span class="line">[root@CentOS1 ~]# lsmod  |grep lustre</span><br><span class="line">lustre                875887  0 </span><br><span class="line">lmv                   191957  1 lustre</span><br><span class="line">mdc                   247683  1 lustre</span><br><span class="line">lov                   320485  1 lustre</span><br><span class="line">ptlrpc               2287996  7 fid,fld,lmv,mdc,lov,osc,lustre</span><br><span class="line">obdclass             2649116  8 fid,fld,lmv,mdc,lov,osc,lustre,ptlrpc</span><br><span class="line">lnet                  595547  6 lmv,osc,lustre,obdclass,ptlrpc,ksocklnd</span><br><span class="line">libcfs                388506  11 fid,fld,lmv,mdc,lov,osc,lnet,lustre,obdclass,ptlrpc,ksocklnd</span><br><span class="line"></span><br><span class="line">[root@CentOS1 ~]# modprobe  lnet</span><br><span class="line">[root@CentOS1 ~]# lsmod  |grep lnet</span><br><span class="line">lnet                  595547  6 lmv,osc,lustre,obdclass,ptlrpc,ksocklnd</span><br><span class="line">libcfs                388506  11 fid,fld,lmv,mdc,lov,osc,lnet,lustre,obdclass,ptlrpc,ksocklnd</span><br></pre></td></tr></table></figure>

<h3 id="7-安装lustre-client核心包-客户端节点"><a href="#7-安装lustre-client核心包-客户端节点" class="headerlink" title="7.安装lustre client核心包(客户端节点)"></a>7.安装lustre client核心包(客户端节点)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;lustre server和lustre client版本版本冲突，客户端必须在其他节点安装</span><br><span class="line">[root@CentOS3 ~]# yum install epel-release -y</span><br><span class="line">[root@CentOS3 ~]# yum install dkms -y</span><br><span class="line">[root@CentOS3 ~]# cd lustre&#x2F;</span><br><span class="line">[root@CentOS3 lustre]# cd lustre-client&#x2F;RPMS&#x2F;x86_64&#x2F;</span><br><span class="line">[root@CentOS3 x86_64]# ls</span><br><span class="line">kmod-lustre-client-2.13.0-1.el7.x86_64.rpm        lustre-client-debuginfo-2.13.0-1.el7.x86_64.rpm  lustre-iokit-2.13.0-1.el7.x86_64.rpm</span><br><span class="line">kmod-lustre-client-tests-2.13.0-1.el7.x86_64.rpm  lustre-client-dkms-2.13.0-1.el7.noarch.rpm</span><br><span class="line">lustre-client-2.13.0-1.el7.x86_64.rpm             lustre-client-tests-2.13.0-1.el7.x86_64.rpm</span><br><span class="line">[root@CentOS3 x86_64]# yum --nogpgcheck --disablerepo&#x3D;*  --enablerepo&#x3D;lustre-client install  kmod-lustre-client-2.13.0-1.el7.x86_64.rpm  lustre-client-2.13.0-1.el7.x86_64.rpm  lustre-client-dkms-2.13.0-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure>


<h3 id="8-deploy-msg-mst"><a href="#8-deploy-msg-mst" class="headerlink" title="8.deploy msg/mst"></a>8.deploy msg/mst</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS1 ~]# fdisk -l|grep sd</span><br><span class="line">Disk &#x2F;dev&#x2F;sda: 68.7 GB, 68719476736 bytes, 134217728 sectors</span><br><span class="line">&#x2F;dev&#x2F;sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">&#x2F;dev&#x2F;sda2         2099200   134217727    66059264   8e  Linux LVM</span><br><span class="line">Disk &#x2F;dev&#x2F;sdc: 25.8 GB, 25769803776 bytes, 50331648 sectors</span><br><span class="line">Disk &#x2F;dev&#x2F;sdb: 25.8 GB, 25769803776 bytes, 50331648 sectors</span><br><span class="line">[root@CentOS1 ~]# mkfs.lustre --mgs  &#x2F;dev&#x2F;sdb</span><br><span class="line">[root@CentOS1 ~]# mkdir &#x2F;mgt</span><br><span class="line">[root@CentOS1 ~]# mount.lustre  &#x2F;dev&#x2F;sdb &#x2F;mgt&#x2F;</span><br><span class="line">[root@CentOS1 ~]# df -h</span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs                 905M     0  905M   0% &#x2F;dev</span><br><span class="line">tmpfs                    917M     0  917M   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs                    917M  9.0M  908M   1% &#x2F;run</span><br><span class="line">tmpfs                    917M     0  917M   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root   41G  2.9G   39G   7% &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sda1               1014M  193M  822M  20% &#x2F;boot</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-home   20G   33M   20G   1% &#x2F;home</span><br><span class="line">tmpfs                    184M     0  184M   0% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line">&#x2F;dev&#x2F;sdb                  24G   46M   23G   1% &#x2F;mgt</span><br></pre></td></tr></table></figure>
<h3 id="9-deploy-mds-mdt"><a href="#9-deploy-mds-mdt" class="headerlink" title="9.deploy mds/mdt"></a>9.deploy mds/mdt</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;mkfs.lustre --fsname&#x3D;lustrefs --mgsnode&#x3D;msg_node@tcp0  --mdt --index&#x3D;0 &#x2F;dev&#x2F;sdc</span><br><span class="line">[root@CentOS1 ~]# mkfs.lustre --fsname&#x3D;lustrefs --mgsnode&#x3D;10.211.55.3@tcp0  --mdt --index&#x3D;0 &#x2F;dev&#x2F;sdc</span><br><span class="line"></span><br><span class="line">   Permanent disk data:</span><br><span class="line">Target:     lustrefs:MDT0000</span><br><span class="line">Index:      0</span><br><span class="line">Lustre FS:  lustrefs</span><br><span class="line">Mount type: ldiskfs</span><br><span class="line">Flags:      0x61</span><br><span class="line">              (MDT first_time update )</span><br><span class="line">Persistent mount opts: user_xattr,errors&#x3D;remount-ro</span><br><span class="line">Parameters: mgsnode&#x3D;10.211.55.3@tcp</span><br><span class="line"></span><br><span class="line">checking for existing Lustre data: not found</span><br><span class="line">device size &#x3D; 24576MB</span><br><span class="line">formatting backing filesystem ldiskfs on &#x2F;dev&#x2F;sdc</span><br><span class="line">        target name   lustrefs:MDT0000</span><br><span class="line">        kilobytes     25165824</span><br><span class="line">        options        -J size&#x3D;983 -I 1024 -i 2560 -q -O dirdata,uninit_bg,^extents,dir_nlink,quota,huge_file,ea_inode,flex_bg -E lazy_journal_init -F</span><br><span class="line">mkfs_cmd &#x3D; mke2fs -j -b 4096 -L lustrefs:MDT0000  -J size&#x3D;983 -I 1024 -i 2560 -q -O dirdata,uninit_bg,^extents,dir_nlink,quota,huge_file,ea_inode,flex_bg -E lazy_journal_init -F &#x2F;dev&#x2F;sdc 25165824k</span><br><span class="line">Writing CONFIGS&#x2F;mountdata</span><br><span class="line">[root@CentOS1 ~]# mkdir &#x2F;mdt</span><br><span class="line">[root@CentOS1 ~]# mount.lustre &#x2F;dev&#x2F;sdc  &#x2F;mdt</span><br></pre></td></tr></table></figure>

<h3 id="10-deploy-oss-ost"><a href="#10-deploy-oss-ost" class="headerlink" title="10.deploy oss/ost"></a>10.deploy oss/ost</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;mkfs.lustre --ost --fsname&#x3D;lustrefs --mgsnode&#x3D;mgs_node@tcp0 --index&#x3D;1 &#x2F;dev&#x2F;sdb</span><br><span class="line"></span><br><span class="line">[root@CentOS2 ~]# mkfs.lustre --ost --fsname&#x3D;lustrefs --mgsnode&#x3D;10.211.55.3@tcp0 --index&#x3D;1 &#x2F;dev&#x2F;sdb</span><br><span class="line"></span><br><span class="line">   Permanent disk data:</span><br><span class="line">Target:     lustrefs:OST0001</span><br><span class="line">Index:      1</span><br><span class="line">Lustre FS:  lustrefs</span><br><span class="line">Mount type: ldiskfs</span><br><span class="line">Flags:      0x62</span><br><span class="line">              (OST first_time update )</span><br><span class="line">Persistent mount opts: ,errors&#x3D;remount-ro</span><br><span class="line">Parameters: mgsnode&#x3D;10.211.55.3@tcp</span><br><span class="line"></span><br><span class="line">checking for existing Lustre data: not found</span><br><span class="line">device size &#x3D; 24576MB</span><br><span class="line">formatting backing filesystem ldiskfs on &#x2F;dev&#x2F;sdb</span><br><span class="line">        target name   lustrefs:OST0001</span><br><span class="line">        kilobytes     25165824</span><br><span class="line">        options        -J size&#x3D;983 -I 512 -i 69905 -q -O extents,uninit_bg,dir_nlink,quota,huge_file,flex_bg -G 256 -E resize&#x3D;&quot;4290772992&quot;,lazy_journal_init -F</span><br><span class="line">mkfs_cmd &#x3D; mke2fs -j -b 4096 -L lustrefs:OST0001  -J size&#x3D;983 -I 512 -i 69905 -q -O extents,uninit_bg,dir_nlink,quota,huge_file,flex_bg -G 256 -E resize&#x3D;&quot;4290772992&quot;,lazy_journal_init -F &#x2F;dev&#x2F;sdb 25165824k</span><br><span class="line">Writing CONFIGS&#x2F;mountdata</span><br><span class="line">[root@CentOS2 ~]# mkdir &#x2F;ost</span><br><span class="line">[root@CentOS2 ~]# mount.lustre  &#x2F;dev&#x2F;sdb &#x2F;ost&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="11-mount-on-client-node"><a href="#11-mount-on-client-node" class="headerlink" title="11.mount on client node"></a>11.mount on client node</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS3 ~]# mkdir &#x2F;mnt&#x2F;lustrefs</span><br><span class="line">[root@CentOS3 ~]# mount -t lustre 10.211.55.3@tcp0:&#x2F;lustrefs &#x2F;mnt&#x2F;lustrefs</span><br><span class="line">[root@CentOS3 ~]# df -h</span><br><span class="line">Filesystem                 Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs                   906M     0  906M   0% &#x2F;dev</span><br><span class="line">tmpfs                      917M     0  917M   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs                      917M  9.0M  908M   1% &#x2F;run</span><br><span class="line">tmpfs                      917M     0  917M   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root     41G  2.8G   39G   7% &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sda1                 1014M  149M  866M  15% &#x2F;boot</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-home     20G   33M   20G   1% &#x2F;home</span><br><span class="line">tmpfs                      184M     0  184M   0% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line">10.211.55.3@tcp:&#x2F;lustrefs   23G   46M   22G   1% &#x2F;mnt&#x2F;lustrefs</span><br></pre></td></tr></table></figure>

<h2 id="chapter-2-lustre-process"><a href="#chapter-2-lustre-process" class="headerlink" title="chapter 2. lustre process"></a>chapter 2. lustre process</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;show luste mgs info</span><br><span class="line">[root@CentOS1 ~]# ps -ef|grep mgs</span><br><span class="line">root      2275     2  0 13:29 ?        00:00:00 [mgs_params_noti]</span><br><span class="line">root      2276     2  0 13:29 ?        00:00:00 [ll_mgs_0000]</span><br><span class="line">root      2277     2  0 13:29 ?        00:00:00 [ll_mgs_0001]</span><br><span class="line">root      2278     2  0 13:29 ?        00:00:00 [ll_mgs_0002]</span><br><span class="line">root      2375     2  0 13:31 ?        00:00:00 [mgs_lustrefs_no]</span><br><span class="line">root      2548  2105  0 13:49 pts&#x2F;0    00:00:00 grep --color&#x3D;auto mgs</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;show lustre mdt process</span><br><span class="line">[root@CentOS1 ~]# ps -ef|grep mdt</span><br><span class="line">root      2357     2  0 13:31 ?        00:00:00 [mdt00_000]</span><br><span class="line">root      2358     2  0 13:31 ?        00:00:00 [mdt00_001]</span><br><span class="line">root      2359     2  0 13:31 ?        00:00:01 [mdt00_002]</span><br><span class="line">root      2360     2  0 13:31 ?        00:00:00 [mdt_rdpg00_000]</span><br><span class="line">root      2361     2  0 13:31 ?        00:00:00 [mdt_rdpg00_001]</span><br><span class="line">root      2362     2  0 13:31 ?        00:00:00 [mdt_attr00_000]</span><br><span class="line">root      2363     2  0 13:31 ?        00:00:00 [mdt_attr00_001]</span><br><span class="line">root      2364     2  0 13:31 ?        00:00:00 [mdt_out00_000]</span><br><span class="line">root      2365     2  0 13:31 ?        00:00:00 [mdt_out00_001]</span><br><span class="line">root      2366     2  0 13:31 ?        00:00:00 [mdt_seqs_0000]</span><br><span class="line">root      2367     2  0 13:31 ?        00:00:00 [mdt_seqs_0001]</span><br><span class="line">root      2368     2  0 13:31 ?        00:00:00 [mdt_seqm_0000]</span><br><span class="line">root      2369     2  0 13:31 ?        00:00:00 [mdt_seqm_0001]</span><br><span class="line">root      2370     2  0 13:31 ?        00:00:00 [mdt_fld_0000]</span><br><span class="line">root      2371     2  0 13:31 ?        00:00:00 [mdt_fld_0001]</span><br><span class="line">root      2372     2  0 13:31 ?        00:00:00 [mdt_io00_000]</span><br><span class="line">root      2373     2  0 13:31 ?        00:00:00 [mdt_io00_001]</span><br><span class="line">root      2374     2  0 13:31 ?        00:00:00 [mdt_io00_002]</span><br><span class="line">root      2540     2  0 13:48 ?        00:00:00 [mdt00_003]</span><br><span class="line">root      2552  2105  0 13:49 pts&#x2F;0    00:00:00 grep --color&#x3D;auto mdt</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;show ost process</span><br><span class="line">[root@CentOS2 ~]# ps -ef|grep ost</span><br><span class="line">root      1854     1  0 13:09 ?        00:00:00 &#x2F;usr&#x2F;libexec&#x2F;postfix&#x2F;master -w</span><br><span class="line">postfix   1859  1854  0 13:09 ?        00:00:00 pickup -l -t unix -u</span><br><span class="line">postfix   1860  1854  0 13:09 ?        00:00:00 qmgr -l -t unix -u</span><br><span class="line">root      2431     2  0 13:47 ?        00:00:00 [ll_ost00_000]</span><br><span class="line">root      2432     2  0 13:47 ?        00:00:00 [ll_ost00_001]</span><br><span class="line">root      2433     2  0 13:47 ?        00:00:00 [ll_ost00_002]</span><br><span class="line">root      2434     2  0 13:47 ?        00:00:00 [ll_ost_create00]</span><br><span class="line">root      2435     2  0 13:47 ?        00:00:00 [ll_ost_create00]</span><br><span class="line">root      2436     2  0 13:47 ?        00:00:00 [ll_ost_io00_000]</span><br><span class="line">root      2437     2  0 13:47 ?        00:00:00 [ll_ost_io00_001]</span><br><span class="line">root      2438     2  0 13:47 ?        00:00:00 [ll_ost_io00_002]</span><br><span class="line">root      2439     2  0 13:47 ?        00:00:00 [ll_ost_seq00_00]</span><br><span class="line">root      2440     2  0 13:47 ?        00:00:00 [ll_ost_seq00_00]</span><br><span class="line">root      2441     2  0 13:47 ?        00:00:00 [ll_ost_out00_00]</span><br><span class="line">root      2442     2  0 13:47 ?        00:00:00 [ll_ost_out00_00]</span><br><span class="line">root      2473  2111  0 13:49 pts&#x2F;0    00:00:00 grep --color&#x3D;auto ost</span><br></pre></td></tr></table></figure>

<h2 id="chapter-3-script"><a href="#chapter-3-script" class="headerlink" title="chapter 3.script"></a>chapter 3.script</h2><ul>
<li>start mgs/mdt</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">modprobe  zfs</span><br><span class="line">modprobe  lustre</span><br><span class="line">modprobe  lnet</span><br><span class="line">&#x2F;&#x2F;execute on mgs&#x2F;mdt node</span><br><span class="line">mount.lustre &#x2F;dev&#x2F;sdc  &#x2F;mdt</span><br><span class="line">mount.lustre  &#x2F;dev&#x2F;sdb &#x2F;mgt&#x2F;</span><br></pre></td></tr></table></figure>
<ul>
<li>start ost</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modprobe  zfs</span><br><span class="line">modprobe  lustre</span><br><span class="line">modprobe  lnet</span><br><span class="line">mount.lustre  &#x2F;dev&#x2F;sdb &#x2F;ost&#x2F;</span><br></pre></td></tr></table></figure>
<ul>
<li>mount </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t lustre 10.211.55.3@tcp0:&#x2F;lustrefs &#x2F;mnt&#x2F;lustrefs</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/21/glusterfs%E9%9B%86%E7%BE%A4glusterd%E6%98%BE%E7%A4%BADisconnect%E7%8A%B6%E6%80%81%E5%AF%BC%E8%87%B4%E9%9B%86%E7%BE%A4IO%E8%AF%B7%E6%B1%82%E5%8F%98%E6%85%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/21/glusterfs%E9%9B%86%E7%BE%A4glusterd%E6%98%BE%E7%A4%BADisconnect%E7%8A%B6%E6%80%81%E5%AF%BC%E8%87%B4%E9%9B%86%E7%BE%A4IO%E8%AF%B7%E6%B1%82%E5%8F%98%E6%85%A2/" class="post-title-link" itemprop="url">glusterfs集群glusterd显示Disconnect状态导致集群IO请求变慢</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-21 11:43:12 / Modified: 11:44:58" itemprop="dateCreated datePublished" datetime="2020-04-21T11:43:12+08:00">2020-04-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="glusterfs集群glusterd显示Disconnect状态导致集群IO请求变慢"><a href="#glusterfs集群glusterd显示Disconnect状态导致集群IO请求变慢" class="headerlink" title="glusterfs集群glusterd显示Disconnect状态导致集群IO请求变慢"></a>glusterfs集群glusterd显示Disconnect状态导致集群IO请求变慢</h3><h4 id="172-25-78-16节点的集群状态"><a href="#172-25-78-16节点的集群状态" class="headerlink" title="172.25.78.16节点的集群状态"></a>172.25.78.16节点的集群状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@szdpl1491 ~]# gluster pool list</span><br><span class="line">UUID                                    Hostname        State</span><br><span class="line">bde7b9e2-af2a-419e-8242-6a8f8e18bb8a    172.25.78.242   Disconnected </span><br><span class="line">54fa8ec0-3617-4c8e-968a-7402a80a9017    172.25.78.240   Connected </span><br><span class="line">588bb497-5d9f-4bcf-b0b1-c9d364afb084    172.25.78.241   Connected </span><br><span class="line">a8522deb-ee16-44a3-a800-9525cb8d64fa    localhost       Connected</span><br></pre></td></tr></table></figure>
<ul>
<li>172.25.78.242节点在172.25.78.16的状态明显不对，查看其它的节点242的认证信息</li>
</ul>
<h4 id="172-25-78-240节点的集群状态"><a href="#172-25-78-240节点的集群状态" class="headerlink" title="172.25.78.240节点的集群状态"></a>172.25.78.240节点的集群状态</h4>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@szdpl1543 ~]# gluster pool list</span><br><span class="line">UUID                                    Hostname        State</span><br><span class="line">588bb497-5d9f-4bcf-b0b1-c9d364afb084    172.25.78.241   Connected </span><br><span class="line">bde7b9e2-af2a-419e-8242-6a8f8e18bb8a    172.25.78.242   Connected </span><br><span class="line">a8522deb-ee16-44a3-a800-9525cb8d64fa    172.25.78.16    Connected </span><br><span class="line">54fa8ec0-3617-4c8e-968a-7402a80a9017    localhost       Connected </span><br><span class="line">[root@szdpl1543 ~]# cd &#x2F;var&#x2F;lib&#x2F;glusterd&#x2F;peers&#x2F;</span><br><span class="line">[root@szdpl1543 peers]# ls</span><br><span class="line">588bb497-5d9f-4bcf-b0b1-c9d364afb084  a8522deb-ee16-44a3-a800-9525cb8d64fa  bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">[root@szdpl1543 peers]# cat bde7b9e2-af2a-419e-8242-6a8f8e18bb8a </span><br><span class="line">uuid&#x3D;bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">state&#x3D;3</span><br><span class="line">hostname1&#x3D;172.25.78.242</span><br><span class="line">hostname2&#x3D;bogon</span><br><span class="line">[root@szdpl1543 peers]# vi bde7b9e2-af2a-419e-8242-6a8f8e18bb8a </span><br><span class="line">uuid&#x3D;bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">state&#x3D;3</span><br><span class="line">hostname1&#x3D;172.25.78.242</span><br></pre></td></tr></table></figure>



<h4 id="172-25-78-16节点的集群状态-1"><a href="#172-25-78-16节点的集群状态-1" class="headerlink" title="172.25.78.16节点的集群状态"></a>172.25.78.16节点的集群状态</h4>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@szdpl1491 ~]# gluster pool list</span><br><span class="line"> UUID                                    Hostname        State</span><br><span class="line">  bde7b9e2-af2a-419e-8242-6a8f8e18bb8a    172.25.78.242   Disconnected </span><br><span class="line">  54fa8ec0-3617-4c8e-968a-7402a80a9017    172.25.78.240   Connected </span><br><span class="line">  588bb497-5d9f-4bcf-b0b1-c9d364afb084    172.25.78.241   Connected </span><br><span class="line">  a8522deb-ee16-44a3-a800-9525cb8d64fa    localhost       Connected</span><br><span class="line">[root@szdpl1491 ~]# cd &#x2F;var&#x2F;lib&#x2F;glusterd&#x2F;peers&#x2F;</span><br><span class="line">[root@szdpl1491 peers]# ls</span><br><span class="line">54fa8ec0-3617-4c8e-968a-7402a80a9017  588bb497-5d9f-4bcf-b0b1-c9d364afb084  bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">[root@szdpl1491 peers]# cat bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">uuid&#x3D;bde7b9e2-af2a-419e-8242-6a8f8e18bb8a</span><br><span class="line">state&#x3D;3</span><br><span class="line">hostname1&#x3D;bogon</span><br><span class="line">hostname2&#x3D;172.25.78.242</span><br></pre></td></tr></table></figure>
<ul>
<li>修改每个节点的var/lib/glusterd/peers/bde7b9e2-af2a-419e-8242-6a8f8e18bb8a 中的hostname1修改为真实的IP，然后重启每个节点的glusterd的服务(systemctl restart glusterd)</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/21/%E5%AE%89%E8%A3%85glusterfs%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/21/%E5%AE%89%E8%A3%85glusterfs%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC/" class="post-title-link" itemprop="url">安装glusterfs指定版本</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-21 09:48:29 / Modified: 09:52:34" itemprop="dateCreated datePublished" datetime="2020-04-21T09:48:29+08:00">2020-04-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="1-glusterfs7-repo源"><a href="#1-glusterfs7-repo源" class="headerlink" title="1.glusterfs7 repo源"></a>1.glusterfs7 repo源</h4><ul>
<li>添加此源到/etc/yum.repo.d/glusterfs.repo中<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[centos-gluster7]</span><br><span class="line">gpgcheck &#x3D; 0</span><br><span class="line">mirrorlist &#x3D; http:&#x2F;&#x2F;mirrorlist.centos.org?arch&#x3D;$basearch&amp;release&#x3D;$releasever&amp;repo&#x3D;storage-gluster-7</span><br><span class="line">name &#x3D; CentOS-$releasever - Gluster 7</span><br><span class="line"></span><br><span class="line">[centos-gluster6]</span><br><span class="line">gpgcheck &#x3D; 0</span><br><span class="line">mirrorlist &#x3D; http:&#x2F;&#x2F;mirrorlist.centos.org?arch&#x3D;$basearch&amp;release&#x3D;$releasever&amp;repo&#x3D;storage-gluster-6</span><br><span class="line">name &#x3D; CentOS-$releasever - Gluster 6</span><br></pre></td></tr></table></figure>
<h4 id="2-更新系统yum-源"><a href="#2-更新系统yum-源" class="headerlink" title="2.更新系统yum 源"></a>2.更新系统yum 源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum check-update</span><br></pre></td></tr></table></figure>
<h4 id="3-安装脚本-glusterfs-install-sh"><a href="#3-安装脚本-glusterfs-install-sh" class="headerlink" title="3.安装脚本(glusterfs_install.sh)"></a>3.安装脚本(glusterfs_install.sh)</h4></li>
<li>脚本内容<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">version&#x3D;&quot;$1&quot;</span><br><span class="line">[[ &quot;$version&quot; &#x3D;&#x3D; &quot;&quot; ]] &amp;&amp; echo &quot;version not provided&quot; &amp;&amp; exit 1</span><br><span class="line"></span><br><span class="line">rpm_packages&#x3D;(</span><br><span class="line">glusterfs-server</span><br><span class="line">glusterfs-events</span><br><span class="line">glusterfs-extra-xlators</span><br><span class="line">glusterfs-geo-replication</span><br><span class="line">glusterfs-libs</span><br><span class="line">glusterfs-rdma</span><br><span class="line">glusterfs</span><br><span class="line">glusterfs-api</span><br><span class="line">glusterfs-api-devel</span><br><span class="line">glusterfs-cli</span><br><span class="line">glusterfs-client-xlators</span><br><span class="line">glusterfs-fuse</span><br><span class="line">python2-gluster</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for index in $&#123;!rpm_packages[@]&#125;; do</span><br><span class="line">  rpm_version_packages[$index]&#x3D;$&#123;rpm_packages[$index]&#125;&quot;-&quot;$version</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum install -y $&#123;rpm_version_packages[*]&#125;</span><br></pre></td></tr></table></figure></li>
<li>脚本执行<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 7.2是版本号</span><br><span class="line">.&#x2F;glusterfs_install.sh 7.2</span><br></pre></td></tr></table></figure>







</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/Go%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8C%E5%87%BD%E6%95%B0%E4%BE%8B%E5%AD%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/Go%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8C%E5%87%BD%E6%95%B0%E4%BE%8B%E5%AD%90/" class="post-title-link" itemprop="url">Go语言调用C函数例子</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-16 18:05:07 / Modified: 18:07:17" itemprop="dateCreated datePublished" datetime="2020-04-16T18:05:07+08:00">2020-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>go access c struct</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">  &#x2F;&#x2F; go run cgo.go</span><br><span class="line">  package main</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;assert.h&gt;</span><br><span class="line">typedef struct student &#123;</span><br><span class="line">        int age;</span><br><span class="line">        char *name;</span><br><span class="line">&#125;student;</span><br><span class="line"></span><br><span class="line">void student_init(void **ptr,char *name,int age) &#123;</span><br><span class="line">        size_t len &#x3D; strlen(name);</span><br><span class="line">        student *st &#x3D; (student *)calloc(1,sizeof(student));</span><br><span class="line">        assert(st!&#x3D;NULL);</span><br><span class="line">        st-&gt;age &#x3D; age;</span><br><span class="line">        st-&gt;name &#x3D; (char *)calloc(1,len+1);</span><br><span class="line">        memcpy(st-&gt;name,name,len);</span><br><span class="line">        *ptr &#x3D; st;</span><br><span class="line">        fprintf(stdout,&quot;...call student_init...\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line">student *student_new(char *name,int age) &#123;</span><br><span class="line">        size_t len &#x3D; strlen(name);</span><br><span class="line">        student *st &#x3D; (student *)calloc(1,sizeof(student));</span><br><span class="line">        assert(st!&#x3D;NULL);</span><br><span class="line">        st-&gt;age &#x3D; age;</span><br><span class="line">        st-&gt;name &#x3D; (char *)calloc(1,len+1);</span><br><span class="line">        memcpy(st-&gt;name,name,len);</span><br><span class="line"></span><br><span class="line">        fprintf(stdout,&quot;...call student_new...\n&quot;);</span><br><span class="line">        return st;</span><br><span class="line">&#125;</span><br><span class="line">void student_destroy(void *ptr) &#123;</span><br><span class="line">        student *st &#x3D; (student *)ptr;</span><br><span class="line">        if(st !&#x3D;NULL)</span><br><span class="line">        &#123;</span><br><span class="line">                free(st-&gt;name);</span><br><span class="line">                free(st);</span><br><span class="line">                st&#x3D;NULL;</span><br><span class="line">                fprintf(stdout,&quot;...call student_destroy...\n&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">void student_print(void  *ptr) &#123;</span><br><span class="line">        student *st &#x3D; (student *)ptr;</span><br><span class="line">        fprintf(stdout,&quot;student addr&#x3D;%p,name&#x3D;%p,age&#x3D;%p\n&quot;,st,st-&gt;name,&amp;st-&gt;age);</span><br><span class="line">        fprintf(stdout,&quot; student &#123;name&#x3D;%s,age&#x3D;%d&#125;\n&quot;,st-&gt;name,st-&gt;age);</span><br><span class="line">&#125;</span><br><span class="line">*&#x2F;</span><br><span class="line">import &quot;C&quot;</span><br><span class="line">import (</span><br><span class="line">        &quot;fmt&quot;</span><br><span class="line">        &quot;unsafe&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">        var st1 unsafe.Pointer</span><br><span class="line">        name :&#x3D; C.CString(&quot;perrynzhou&quot;)</span><br><span class="line">        C.student_init(&amp;st1, name, 30)</span><br><span class="line">        C.student_print(st1)</span><br><span class="line">        C.student_destroy(st1)</span><br><span class="line">        C.free(unsafe.Pointer(name))</span><br><span class="line"></span><br><span class="line">        var st2 *C.student</span><br><span class="line">        name2 :&#x3D; C.CString(&quot;hello&quot;)</span><br><span class="line">        st2 &#x3D; C.student_new(name2, 100)</span><br><span class="line">        fmt.Printf(&quot;init student st2 &#123;age:%d,name:%s&#125;\n&quot;, st2.age, C.GoString(st2.name))</span><br><span class="line">        C.student_print(unsafe.Pointer(st2))</span><br><span class="line"></span><br><span class="line">        C.free(unsafe.Pointer(st2.name))</span><br><span class="line">        name3 :&#x3D; C.CString(&quot;join&quot;)</span><br><span class="line">        st2.name &#x3D; name3</span><br><span class="line">        st2.age &#x3D; 67</span><br><span class="line">        fmt.Printf(&quot;after change student st2 &#123;age:%d,name:%s&#125;\n&quot;, st2.age, C.GoString(st2.name))</span><br><span class="line">        C.student_print(unsafe.Pointer(st2))</span><br><span class="line">        C.student_destroy(unsafe.Pointer(st2))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/16/Go%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8C%E5%87%BD%E6%95%B0%E4%BE%8B%E5%AD%90/2582954-7ff22e6700b629e6.png" alt></p>
<ul>
<li>go access c memory<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;    go build  -o cgo_test cgo.go </span><br><span class="line"></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">void *alloc() &#123;</span><br><span class="line">        static int count &#x3D; 0;</span><br><span class="line">        void *d &#x3D; malloc(sizeof(int));</span><br><span class="line">        *((int *)d) &#x3D; count++;</span><br><span class="line">        return d;</span><br><span class="line">&#125;</span><br><span class="line">*&#x2F;</span><br><span class="line">import &quot;C&quot;</span><br><span class="line">import (</span><br><span class="line">        &quot;fmt&quot;</span><br><span class="line">        &quot;runtime&quot;</span><br><span class="line">        &quot;sync&quot;</span><br><span class="line">        &quot;time&quot;</span><br><span class="line">        &quot;unsafe&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type CStruct struct &#123;</span><br><span class="line">        sync.Mutex</span><br><span class="line">        name     string</span><br><span class="line">        allocCnt int</span><br><span class="line">        memory   unsafe.Pointer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (cs *CStruct) alloc(name string, id int) &#123;</span><br><span class="line">        cs.name &#x3D; fmt.Sprintf(&quot;CStruct-%s-%d&quot;, name, id)</span><br><span class="line">        cs.Lock()</span><br><span class="line">        defer cs.Unlock()</span><br><span class="line">        cs.allocCnt++</span><br><span class="line">        fmt.Printf(&quot;%s begin with alloc,count&#x3D;%d\n&quot;, cs.name, cs.allocCnt)</span><br><span class="line">        cs.memory &#x3D; C.alloc()</span><br><span class="line">        runtime.SetFinalizer(cs, free)</span><br><span class="line">&#125;</span><br><span class="line">func free(cs *CStruct) &#123;</span><br><span class="line">        C.free(unsafe.Pointer(cs.memory))</span><br><span class="line">        cs.Lock()</span><br><span class="line">        defer cs.Unlock()</span><br><span class="line">        cs.allocCnt--</span><br><span class="line">        fmt.Printf(&quot;%s end with free count&#x3D;%d\n&quot;, cs.name, cs.allocCnt)</span><br><span class="line">&#125;</span><br><span class="line">func CStructTest(i int) &#123;</span><br><span class="line">        var c1, c2 CStruct</span><br><span class="line">        c1.alloc(&quot;c1&quot;, i)</span><br><span class="line">        c2.alloc(&quot;c2&quot;, i)</span><br><span class="line">&#125;</span><br><span class="line">func main() &#123;</span><br><span class="line">        for i :&#x3D; 0; i &lt; 10; i++ &#123;</span><br><span class="line">                CStructTest(i)</span><br><span class="line">                time.Sleep(time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">        runtime.GC()</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        fmt.Println(&quot;done..&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2020/04/16/Go%E8%AF%AD%E8%A8%80%E8%B0%83%E7%94%A8C%E5%87%BD%E6%95%B0%E4%BE%8B%E5%AD%90/2582954-4171fe1cc79448ad.png" alt></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84shell/" class="post-title-link" itemprop="url">实现简单的shell</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-16 18:01:22 / Modified: 18:02:44" itemprop="dateCreated datePublished" datetime="2020-04-16T18:01:22+08:00">2020-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>shell实现代码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*************************************************************************</span><br><span class="line">  &gt; File Name: shell.c</span><br><span class="line">  &gt; Author:perrynzhou </span><br><span class="line">  &gt; Mail:perrynzhou@gmail.com </span><br><span class="line">  &gt; Created Time: Thu 20 Jun 2019 09:15:59 PM CST</span><br><span class="line"> ************************************************************************&#x2F;</span><br><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;glob.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;types.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;wait.h&gt;</span><br><span class="line">static const char *delimiter &#x3D; &quot; \t\n&quot;;</span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  glob_t gt;</span><br><span class="line">  int (*cmd_cd_fn)(char **argv);</span><br><span class="line">  int (*cmd_exit_fn)(char **argv);</span><br><span class="line">  int (*cmd_help_fn)(char **argv);</span><br><span class="line">&#125; cmd_t;</span><br><span class="line">static void prompt()</span><br><span class="line">&#123;</span><br><span class="line">  fprintf(stdout, &quot;zsh-0.1$ &quot;);</span><br><span class="line">&#125;</span><br><span class="line">void parsed_cmd(char *line, cmd_t *cmd)</span><br><span class="line">&#123;</span><br><span class="line">  char *token;</span><br><span class="line">  int flag &#x3D; 0;</span><br><span class="line">  while (1)</span><br><span class="line">  &#123;</span><br><span class="line">    token &#x3D; strsep(&amp;line, delimiter);</span><br><span class="line">    if (token &#x3D;&#x3D; NULL)</span><br><span class="line">    &#123;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">    if (*token &#x3D;&#x3D; &#39;\0&#39;)</span><br><span class="line">    &#123;</span><br><span class="line">      continue;</span><br><span class="line">    &#125;</span><br><span class="line">    glob(token, GLOB_NOCHECK | GLOB_APPEND * flag, NULL, &amp;cmd-&gt;gt);</span><br><span class="line">    flag &#x3D; 1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">  char *line &#x3D; NULL;</span><br><span class="line">  size_t line_size &#x3D; 0;</span><br><span class="line">  cmd_t cmd;</span><br><span class="line">  pid_t pid;</span><br><span class="line">  while (1)</span><br><span class="line">  &#123;</span><br><span class="line">    prompt();</span><br><span class="line">    if (getline(&amp;line, &amp;line_size, stdin) &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">    parsed_cmd(line, &amp;cmd);</span><br><span class="line">    pid &#x3D; fork();</span><br><span class="line">    switch (pid)</span><br><span class="line">    &#123;</span><br><span class="line">    case -1:</span><br><span class="line">      perror(&quot;fork()&quot;);</span><br><span class="line">      exit(1);</span><br><span class="line">    case 0:</span><br><span class="line">      execvp(cmd.gt.gl_pathv[0], cmd.gt.gl_pathv);</span><br><span class="line">      exit(0);</span><br><span class="line">    default:</span><br><span class="line">      wait(NULL);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/%E5%85%B3%E4%BA%8ECPU%E5%AD%97%E8%8A%82%E5%BA%8F%E7%9A%84%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="perrynzhou">
      <meta itemprop="description" content="涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perrynzhou">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/%E5%85%B3%E4%BA%8ECPU%E5%AD%97%E8%8A%82%E5%BA%8F%E7%9A%84%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="url">关于CPU字节序的理解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-16 17:59:50 / Modified: 18:01:04" itemprop="dateCreated datePublished" datetime="2020-04-16T17:59:50+08:00">2020-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="为什么会有字节序这一说法"><a href="#为什么会有字节序这一说法" class="headerlink" title="为什么会有字节序这一说法"></a>为什么会有字节序这一说法</h2><ul>
<li>对于单字节处理器不存在字节序，对于大于1个字节的位数的CPU，其寄存器的宽度也大于1个字节，所以存储字节排序的问题</li>
</ul>
<h2 id="大端字节序排序"><a href="#大端字节序排序" class="headerlink" title="大端字节序排序"></a>大端字节序排序</h2><ul>
<li>大端：高字节位在低地址存储，低字节位在高地址存储</li>
<li>小端: 高字节位存储在高地址，低字节位存储在低地址<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> 例如 int  x &#x3D; 0x0001,假设是在64位的CPU上，它的地址空间为：0xff13,其字节排序可能有两种可能：</span><br><span class="line">  oxff13: 0  0  0  1   ---&gt;第一种情况 大端</span><br><span class="line">  0xff13: 1  0  0  0   ---&gt;第二种情况 小端</span><br><span class="line">在x这个值中0001从左往右是高字节位到低字节位，也就是 0,0 是高字节，0 1 是低字节位。</span><br></pre></td></tr></table></figure>
<h2 id="如何验证CPU的字节序呢？"><a href="#如何验证CPU的字节序呢？" class="headerlink" title="如何验证CPU的字节序呢？"></a>如何验证CPU的字节序呢？</h2></li>
<li>C语言中有union结构，这个结构的数据存储是从低地址向高地址依次存储值，可以通过这个特性来验证CPU的字节序<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*************************************************************************</span><br><span class="line">  &gt; File Name: byte_order.c</span><br><span class="line">  &gt; Author:perrynzhou </span><br><span class="line">  &gt; Mail:perrynzhou@gmail.com </span><br><span class="line">  &gt; Created Time: Fri 15 Nov 2019 03:42:37 PM CST</span><br><span class="line"> ************************************************************************&#x2F;</span><br><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">typedef union object_t &#123;</span><br><span class="line">    int a;</span><br><span class="line">    char b;</span><br><span class="line">&#125; object;</span><br><span class="line">enum</span><br><span class="line">&#123;</span><br><span class="line">    big_endian_type &#x3D; 0,</span><br><span class="line">    small_endian_type,</span><br><span class="line">&#125;;</span><br><span class="line">int checkCpu(object *obj)</span><br><span class="line">&#123;</span><br><span class="line">    return obj-&gt;b &#x3D;&#x3D; 1 ? small_endian_type : big_endian_type;</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int v &#x3D; 0x0001;</span><br><span class="line">    object obj;</span><br><span class="line">    obj.a &#x3D; v;</span><br><span class="line">    fprintf(stdout, &quot;value:%d,value_string:%s,object address:%p\n&quot;, v, &quot;0x0001&quot;, &amp;obj);</span><br><span class="line">    if (checkCpu(&amp;obj) &#x3D;&#x3D; big_endian_type)</span><br><span class="line">    &#123;</span><br><span class="line">        fprintf(stdout, &quot;store plan: |%d|%d|%d|%d|,big endian\n&quot;, 0, 0, 0, 1);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        fprintf(stdout, &quot;store plan: |%d|%d|%d|%d|,small endian\n&quot;, 1, 0, 0, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[perrynzhou@localhost ~&#x2F;Source&#x2F;vivo&#x2F;linux_kernel_study&#x2F;chapter_01]$ .&#x2F;test </span><br><span class="line">value:1,value_string:0x0001,object address:0x7ffcaf058a08</span><br><span class="line">store plan: |0|0|0|1|,big endian</span><br><span class="line">[perrynzhou@localhost ~&#x2F;Source&#x2F;vivo&#x2F;linux_kernel_study&#x2F;chapter_01]$</span><br></pre></td></tr></table></figure>



</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">perrynzhou</p>
  <div class="site-description" itemprop="description">涉猎的主要编程语言为 C、Go，分布式存储和对象存储.https://github.com/perrynzhou。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">perrynzhou</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
